<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">.
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lead Full-Stack Developer - Angular, ReactJS & .NET (USA H1B Visa) - Arif Suleman</title>
    <meta name="description" content=".NET Developer, Freelancer, Contractor, React, Angular - Arif Suleman, Dubai & USA IT Market. Speciality in Developing Software applications for Insurance, Healthcare , Real Estate and various verticals. CMS, WordPress, ECommerce Solutions"/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/aos.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="styles/main.css" rel="stylesheet">
  </head>
  <body id="top">
    <header>
      <div class="profile-page sidebar-collapse">
        <nav class="navbar navbar-expand-lg fixed-top navbar-transparent bg-primary" color-on-scroll="400">
          <div class="container">
            <div class="navbar-translate"><a class="navbar-brand" href="#" rel="tooltip">LEAD FULL-STACK DEVELOPER ( Reactjs / Angluar / .NET )</a>
              <button class="navbar-toggler navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-bar bar1"></span><span class="navbar-toggler-bar bar2"></span><span class="navbar-toggler-bar bar3"></span></button>
            </div>
            <div class="collapse navbar-collapse justify-content-end" id="navigation">
              <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link smooth-scroll" href="#about">About</a></li>
                <li class="nav-item"><a class="nav-link smooth-scroll" href="#skill">Skills</a></li>
                <li class="nav-item"><a class="nav-link smooth-scroll" href="#portfolio">Portfolio</a></li>
                <li class="nav-item"><a class="nav-link smooth-scroll" href="#experience">Code Samples</a></li>
                <li class="nav-item"><a class="nav-link smooth-scroll" href="#contact">Contact</a></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <div class="page-content">
      <div>
<div class="profile-page">
  <div class="wrapper">
    <div class="page-header page-header-small" filter-color="green">
      <div class="page-header-image" data-parallax="true" style="background-image: url('images/cc-bg-1.jpg');"></div>
      <div class="container">
        <div class="content-center">
          <div class="cc-profile-image"><a href="#"><img src="images/arif.jpg" alt="Image"/></a></div>
          <div class="h2 title">Arif Suleman (USA H1B Visa)</div>
          <p class="category text-white">Lead Full-Stack Developer - Angular, ReactJS & .NET</p><a class="btn btn-primary smooth-scroll mr-2" href="#contact" data-aos="zoom-in" data-aos-anchor="data-aos-anchor">Hire Me</a>

<!--
<a class="btn btn-primary" href="#" data-aos="zoom-in" data-aos-anchor="data-aos-anchor">Download CV</a>
-->

        </div>
      </div>
      <div class="section">
        <div class="container">
          
        </div>
      </div>
    </div>
  </div>
</div>
<div class="section" id="about">
  <div class="container">
    <div class="card" data-aos="fade-up" data-aos-offset="10">
      <div class="row">
        <div class="col-lg-6 col-md-12">
          <div class="card-body">
            <div class="h4 mt-0 title">About</div>
            <p>20+ years of IT industry Experience. Speciality in Developing Software applications for Insurance,financial, Metaverse, B2B and various verticals,
		 CMS, WordPress</p>
            <p><strong class="text-uppercase">At present, Looking for C2C USA IT opportunities, Authorized to work anywhere in USA</strong></p>
          </div>
        </div>
      
	 <div class="col-lg-6 col-md-12">
          <div class="card-body">
            <div class="h4 mt-0 title">Worked with Companies:</div>
            
            <div class="row">
              <div class="col-sm-4"><strong class="text-uppercase">UNITED STATES</strong></div>
              <div class="col-sm-8">AM TECHNOLOGIES, FLOW IMMERSIVE</div>
            </div>
           
	    <div class="row mt-3">
              <div class="col-sm-4"><strong class="text-uppercase">DUBAI & SINGAPORE</strong></div>
              <div class="col-sm-8">ACE Insurance, Takaful Emarat Insurance, Healthcare Solutions, Higher identity</div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="section" id="skill">
  <div class="container">
    <div class="h4 text-center mb-4 title">Professional Skills</div>
    <div class="card" data-aos="fade-up" data-aos-anchor-placement="top-bottom">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">.NET(C#)</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div><span class="progress-value">100%</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">Angular / React / Javascript</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div><span class="progress-value">100%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">CSS / HTML</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 80%;"></div><span class="progress-value">80%</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">CMS / WORDPRESS / ECOMMERCE</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 80%;"></div><span class="progress-value">80%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">SOLUTION ARCHITECT</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"></div><span class="progress-value">75%</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="progress-container progress-primary"><span class="progress-badge">PROJECT MANAGEMENT</span>
              <div class="progress">
                <div class="progress-bar progress-bar-primary" data-aos="progress-full" data-aos-offset="10" data-aos-duration="2000" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 70%;"></div><span class="progress-value">70%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="section" id="portfolio">
  <div class="container">
    <div class="row">
      <div class="col-md-6 ml-auto mr-auto">
        <div class="h4 text-center mb-4 title">Portfolio</div>
        <div class="nav-align-center">
          
        </div>
      </div>
    </div>
    <div class="tab-content gallery mt-5">
      <div class="tab-pane active" id="web-development">
        <div class="ml-auto mr-auto">
          <div class="row">
            <div class="col-md-6">
              <div class="cc-porfolio-image img-raised" data-aos="fade-up" data-aos-anchor-placement="top-bottom"><a href="#web-development">
                  <figure class="cc-effect"><img src="images/Emergeapp1.png" alt="Image"/>
                    <figcaption>
                      <div class="h4">SaaS app for traditional B2B Wholesale, Distribution and E-Commerce Merchants</div>
                      <p>Web Development</p>
                    </figcaption>
                  </figure></a></div>
              <div class="cc-porfolio-image img-raised" data-aos="fade-up" data-aos-anchor-placement="top-bottom"><a href="#web-development">
                  <figure class="cc-effect"><img src="images/commercial people 1.jpg" alt="Image"/>
                    <figcaption>
                      <div class="h4">Real Estate</div>
                      <p>Web Development</p>
                    </figcaption>
                  </figure></a></div>
            </div>
            <div class="col-md-6">
              <div class="cc-porfolio-image img-raised" data-aos="fade-up" data-aos-anchor-placement="top-bottom"><a href="#web-development">
                  <figure class="cc-effect"><img src="images/Unation.png" alt="Image"/>
                    <figcaption>
                      <div class="h4">UNATION - ALL ABOUT EVENTS</div>
                      <p>Web Development</p>
                    </figcaption>
                  </figure></a></div>
              <div class="cc-porfolio-image img-raised" data-aos="fade-up" data-aos-anchor-placement="top-bottom"><a href="#web-development">
                  <figure class="cc-effect"><img src="images/Request Flow.jpg" alt="Image"/>
                    <figcaption>
                      <div class="h4">Request , Response architect Sample</div>
                      <p>Web Development</p>
                    </figcaption>
                  </figure></a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="section" id="experience">
  <div class="container cc-experience">
    <div class="h4 text-center mb-4 title">Code Samples </div>
    <div class="card">
      <div class="row">
        <div class="col-md-3 bg-primary" data-aos="fade-right" data-aos-offset="50" data-aos-duration="500">
          <div class="card-body cc-experience-header">
            <p>JavaScript Framework</p>
            <div class="h5">Angularjs</div>
          </div>
        </div>
        <div class="col-md-9" data-aos="fade-left" data-aos-offset="50" data-aos-duration="500" style="background-color:#888; color:white;">
          <div class="card-body">
            <div class="h5">Sample using Angularjs for Processing Sales Order</div>

<pre style="margin:0em; overflow:auto; background-color:#ffffff; max-height: 200px;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;"><span style="color:#008000;">// Sales Order List Controller</span>
ORD.controller(<span style="color:#a31515;">'SalesListCtrl'</span>, [<span style="color:#a31515;">'$modal'</span>, <span style="color:#a31515;">'$location'</span>, <span style="color:#a31515;">'$controller'</span>, <span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$rootScope'</span>, <span style="color:#a31515;">'$http'</span>, <span style="color:#a31515;">'salesService'</span>, <span style="color:#a31515;">'errorDisplay'</span>, <span style="color:#a31515;">'ngTableParams'</span>, <span style="color:#a31515;">'$timeout'</span>, <span style="color:#a31515;">'$translate'</span>,
    function ($modal, $location, $controller, $scope, $rootScope, $http, salesService, errorDisplay, ngTableParams, $timeout, $translate) {
        $controller(<span style="color:#a31515;">'CommonListingPage'</span>, { $scope: $scope });
        $scope.initTemplate = {
            createLink: <span style="color:#a31515;">"#/sales/new"</span>,
            createText: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.NEW_SALES_ORDER'</span>),
            mainText: $translate.instant(<span style="color:#a31515;">'LISTINGPAGE.ALL_SALES_ORDERS'</span>),
            createNewPermission: <span style="color:#a31515;">'sales_create'</span>,
            menuId: <span style="color:#a31515;">'createNewDocument'</span>,
            tags: <span style="color:#a31515;">'LABEL.ITP.SALES.TAGS'</span>,
            searchListing: <span style="color:#a31515;">'LABEL.ITP.SALES.Q_FILTER'</span>,
            generalInfoListing: <span style="color:#a31515;">'LABEL.ITP.SALES.LISTING'</span>,
            topMenuListingPageTemplate: <span style="color:#a31515;">"ORD/Sales/TopMenuOfListingPage/topmenu.template.html?v="</span> + window.jsVersion
        };

        $scope.currentLessonCode;
        $scope.callbackArr;
        $scope.runIntroJS = function () {
            $scope.currentLessonCode = $rootScope.$itpService.getLessonCode();
            <span style="color:#0000ff;">if</span> (!$scope.currentLessonCode.length) {
                $rootScope.isITPRunning = <span style="color:#0000ff;">false</span>;
                <span style="color:#0000ff;">return</span>;
            }
            $rootScope.$itpService.hideAllModal();
            $scope.initTemplate.createLink = <span style="color:#a31515;">"#/sales/new?lesson-code=OPR_ORD_SO_L1"</span>;

            $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
            $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
            $rootScope.isLoadingITPData = <span style="color:#0000ff;">true</span>;


            $timeout(function () {
        
                <span style="color:#0000ff;">var</span> initStepCode = <span style="color:#a31515;">"2_2_1_1"</span>;
                <span style="color:#0000ff;">var</span> queryStepCode = $rootScope.$itpService.getStepCode();

                <span style="color:#0000ff;">if</span> (queryStepCode) {
                    initStepCode = queryStepCode;
                }

                <span style="color:#0000ff;">switch</span> ($scope.currentLessonCode) {
                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                        $scope.callbackArr =
                            [
                                {
                                    stepCode: <span style="color:#a31515;">'10_1_1_1'</span>,
                                    onafterchange: function () {
                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                        $scope.$apply();
                                        $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"220px"</span> });
                                    }
                                }
                            ]
                        <span style="color:#0000ff;">break</span>;
                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                        $scope.callbackArr =
                            [
                                {
                                    stepCode: <span style="color:#a31515;">'2_2_3_2'</span>,
                                    onafterchange: function () {
                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                        $scope.$apply();
                                        $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"220px"</span> });
                                    }
                                }
                            ]
                        <span style="color:#0000ff;">break</span>;
                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                        $scope.callbackArr =
                            [
                                {
                                    stepCode: initStepCode,
                                    onafterchange: function () {
                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                        $scope.$apply();
                                        $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"220px"</span> });
                                    }
                                }
                            ]
                        <span style="color:#0000ff;">break</span>;
                    <span style="color:#0000ff;">default</span>:
                        $scope.callbackArr =
                            [
                                {
                                    stepCode: initStepCode,
                                    onafterchange: function () {
                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                        $scope.$apply();
                                        $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"270px"</span> });
                                    }
                                }
                            ]
                        <span style="color:#0000ff;">break</span>;
                }

                angular.element(document).ready(function () {
                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                    $rootScope.$itpService.startFromStep(initStepCode, $scope.callbackArr);
                });
            }, 800);
        };
        
        <span style="color:#0000ff;">var</span> salesSearchFields = [
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.CRM.CUSTOMER'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'customer_name'</span>,
                directive: {
                    type: <span style="color:#a31515;">'customers-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.DOCUMENT_NUMBER_TABLE_TYPE'</span>, { type: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_ORDER'</span>) }),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'formattedNumber'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
             {
                 title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.SALES_ORDER_TYPE'</span>),
                 type: <span style="color:#a31515;">'directive'</span>,
                 param: <span style="color:#a31515;">'sales_type'</span>,
                 directive: {
                     type: <span style="color:#a31515;">'sales-order-type'</span>,
                     attributes: <span style="color:#a31515;">'type="name"'</span>
                 },
                 placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.SELECT_TYPE'</span>)
             },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.ADDRESS'</span>),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'address'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.STATE'</span>),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'state'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.CITY'</span>),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'city'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.POSTAL_CODE'</span>),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'postalCode'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.COUNTRY'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'country'</span>,
                directive: {
                    type: <span style="color:#a31515;">'countries-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                }
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.ITEM'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'item_name'</span>,
                directive: {
                    type: <span style="color:#a31515;">'products-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.CURRENCY'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'currency'</span>,
                directive: {
                    type: <span style="color:#a31515;">'currencies-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.TOTAL_AMOUNT'</span>),
                type: <span style="color:#a31515;">'select'</span>,
                param: <span style="color:#a31515;">'total'</span>,
                placeholder: <span style="color:#a31515;">'amount'</span>,
                data: [
                    {
                        title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.EQUAL_TO'</span>),
                        param: <span style="color:#a31515;">'total_amount'</span>,
                        type: <span style="color:#a31515;">'text'</span>
                    },
                    {
                        title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.NOT_EQUAL_TO'</span>),
                        param: <span style="color:#a31515;">'total_amount_not'</span>,
                        type: <span style="color:#a31515;">'text'</span>
                    },
                    {
                        title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.LESS_THAN'</span>),
                        param: <span style="color:#a31515;">'total_amount_max'</span>,
                        type: <span style="color:#a31515;">'text'</span>
                    },
                    {
                        title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.MORE_THAN'</span>),
                        param: <span style="color:#a31515;">'total_amount_min'</span>,
                        type: <span style="color:#a31515;">'text'</span>
                    }
                ]
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_STATUS'</span>),
                type: <span style="color:#a31515;">'select'</span>,
                param: <span style="color:#a31515;">'salesOrderStatus'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'GENERAL.LABEL.STATUS'</span>),
                data: $scope.convertObject(salesService.getAllStatus(), <span style="color:#a31515;">'salesOrderStatus'</span>, <span style="color:#a31515;">'number'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_FULFILLMENT_STATUS'</span>),
                type: <span style="color:#a31515;">'select'</span>,
                param: <span style="color:#a31515;">'salesOrderFullfillmentStatus'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'GENERAL.LABEL.STATUS'</span>),
                data: $scope.convertObject(salesService.getAllFullfillmentStatus(), <span style="color:#a31515;">'salesOrderFullfillmentStatus'</span>, <span style="color:#a31515;">'number'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_PAYMENT_STATUS'</span>),
                type: <span style="color:#a31515;">'select'</span>,
                param: <span style="color:#a31515;">'salesOrderPaymentStatus'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'GENERAL.LABEL.STATUS'</span>),
                data: $scope.convertObject(salesService.getAllPaymentStatus(), <span style="color:#a31515;">'salesOrderPaymentStatus'</span>, <span style="color:#a31515;">'number'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.CREDIT_TERM'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'credit_term'</span>,
                directive: {
                    type: <span style="color:#a31515;">'creditterms-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.DELIVERY_TERM'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'delivery_term'</span>,
                directive: {
                    type: <span style="color:#a31515;">'deliveryterms-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GNM.DELIVERY_METHOD'</span>),
                type: <span style="color:#a31515;">'directive'</span>,
                param: <span style="color:#a31515;">'delivery_method'</span>,
                directive: {
                    type: <span style="color:#a31515;">'deliverymethods-dropdown'</span>,
                    attributes: <span style="color:#a31515;">'type="name"'</span>
                },
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            },
            {
                title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.TAGS'</span>),
                type: <span style="color:#a31515;">'text'</span>,
                param: <span style="color:#a31515;">'tag'</span>,
                placeholder: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.CONTAINS_THE_WORD'</span>)
            }
        ];


        $scope.searchFields = salesSearchFields.concat($scope.searchFields);
        <span style="color:#008000;">// init searchlisting</span>
        $scope.moduleName = <span style="color:#a31515;">'salesorders'</span>;
        $scope._init($scope.moduleName);
        <span style="color:#008000;">//controller init</span>
        $scope.sales = [];

        <span style="color:#0000ff;">var</span> selectedSales = $scope.selectedSales = [];
        $scope.searchTable = function (searchParam) {
            $scope.searchParam = searchParam || $scope.searchParam;
            <span style="color:#0000ff;">if</span> ($scope.tableParams.$<span style="color:#0000ff;">params</span>.page != 1) { $scope.tableParams.$<span style="color:#0000ff;">params</span>.page = 1; } <span style="color:#0000ff;">else</span> { $scope.tableParams.reload(); }; 
        };
        $scope.tableParams = <span style="color:#0000ff;">new</span> ngTableParams({
            page: 1,            <span style="color:#008000;">// show first page</span>
            count: 10,          <span style="color:#008000;">// count per page</span>
            sorting: {
                salesOrderId: <span style="color:#a31515;">'desc'</span>     <span style="color:#008000;">// initial sorting</span>
            }
        }, {
            total: 0,           <span style="color:#008000;">// length of data</span>
            getData: function ($defer, <span style="color:#0000ff;">params</span>) {
                <span style="color:#008000;">// ajax request to api</span>
                <span style="color:#0000ff;">var</span> count = <span style="color:#0000ff;">params</span>.count();
                <span style="color:#0000ff;">var</span> page = <span style="color:#0000ff;">params</span>.page();
                <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> column <span style="color:#0000ff;">in</span> <span style="color:#0000ff;">params</span>.sorting()) <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> asc <span style="color:#0000ff;">in</span> <span style="color:#0000ff;">params</span>.sorting()) {
                    asc = <span style="color:#0000ff;">params</span>.sorting()[asc];
                    <span style="color:#0000ff;">break</span>;
                }

                <span style="color:#0000ff;">var</span> itpPendingDelivery;
                <span style="color:#0000ff;">var</span> itpPendingInvoice;
                <span style="color:#0000ff;">var</span> itpPendingPurchase;
                <span style="color:#0000ff;">var</span> itpFilterProductHasSupplier;
                <span style="color:#0000ff;">var</span> itpIsExcludeProductService;

                <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                    <span style="color:#0000ff;">var</span> itpIsExcludeProductService = <span style="color:#0000ff;">true</span>;

                    <span style="color:#0000ff;">switch</span> ($rootScope.$itpService.getLessonCode()) {
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_DO_L2'</span>:
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L2'</span>:
                            itpPendingDelivery = <span style="color:#0000ff;">true</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                            itpPendingInvoice = <span style="color:#0000ff;">true</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                            $rootScope.skipTrainingName = <span style="color:#a31515;">'LABEL.ITP.GENERAL.END_TRAINING'</span>;
                            itpPendingPurchase = <span style="color:#0000ff;">true</span>;
                            itpFilterProductHasSupplier = <span style="color:#0000ff;">true</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                            itpPendingDelivery = <span style="color:#0000ff;">true</span>;
                            itpPendingPurchase = <span style="color:#0000ff;">true</span>;
                            itpFilterProductHasSupplier = <span style="color:#0000ff;">true</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">default</span>:
                            itpPendingDelivery = <span style="color:#0000ff;">null</span>;
                            itpPendingInvoice = <span style="color:#0000ff;">null</span>;
                            <span style="color:#0000ff;">break</span>;
                    }
                }

                salesService.search(
                        itpPendingDelivery, itpPendingInvoice, itpPendingPurchase,
                        itpFilterProductHasSupplier, itpIsExcludeProductService,
                        $scope.search.text, count, page, column, asc, $scope.searchParam, { tracker: <span style="color:#a31515;">'emergeTracker'</span> })
                    .success(function (data) {
                        $timeout(function () {
                            
                            <span style="color:#0000ff;">params</span>.total(data.total);
                            
                            angular.forEach(data.results, function (node) {
                                node.isSelected = <span style="color:#0000ff;">false</span>;
                            });
                            $defer.resolve(data.results);

                            
                            angular.element(document).scrollTop(0);

                            
                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();

                                <span style="color:#0000ff;">if</span> (!data.results.length) {
                                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                             
                                            alert($translate.instant(<span style="color:#a31515;">'LABEL.ORD.NO_SUITABLE_SALES'</span>));
                                            $location.url(<span style="color:#a31515;">'/sales/new'</span>);
                                            <span style="color:#0000ff;">break</span>;
                                        <span style="color:#0000ff;">default</span>:
                                            <span style="color:#0000ff;">if</span> (lessonCode != <span style="color:#a31515;">'OPR_ORD_SO_L1'</span>) {
                                                alert($translate.instant(<span style="color:#a31515;">'LABEL.ORD.NO_SALES_TO_PERFORM_REQUIRED_OPERATION'</span>));
                                                $location.url(<span style="color:#a31515;">'/sales/new'</span>);
                                            }
                                            <span style="color:#0000ff;">break</span>;
                                    }
                                }

                                $scope.runIntroJS();
                            }

                        }, 500);
                    })
            }
        });

        $scope.columns =
            [
                {
                    field: <span style="color:#a31515;">'salesOrderId'</span>,
                    icon: <span style="color:#a31515;">''</span>,
                    headerClass: <span style="color:#a31515;">'text-center unsortable'</span>,
                    headerCheckboxTemplate: <span style="color:#a31515;">'ORD/Sales/TopMenuOfListingPage/salesHeaderCheckbox.template.html'</span>,
                    title: <span style="color:#a31515;">''</span>,
                    cellTemplate: <span style="color:#a31515;">''</span> +
                        <span style="color:#a31515;">'&lt;div class="checkbox check-success p-l-50-percent"&gt;'</span> +
                            <span style="color:#a31515;">'&lt;input id="salesOrderChk_{{row.salesOrderId}}" name="salesOrderChk_{{row.salesOrderId}}" ng-checked="row.isSelected" ng-model="row.isSelected" type="checkbox"&gt;'</span> +
                            <span style="color:#a31515;">'&lt;label for="salesOrderChk_{{row.salesOrderId}}"&gt;&nbsp;&lt;/label&gt;'</span> +
                        <span style="color:#a31515;">'&lt;/div&gt;'</span>,
                    sortable: <span style="color:#0000ff;">false</span>,
                    width: <span style="color:#a31515;">'50px'</span>
                },
                {
                    field: <span style="color:#a31515;">'isBackToBack'</span>,
                    icon: <span style="color:#a31515;">'dark-dropship-icon'</span>,
                    iconTitle: <span style="color:#a31515;">'View Shipment Dropship'</span>,
                    title: <span style="color:#a31515;">''</span>,
                    cellTemplate: <span style="color:#a31515;">'&lt;div class="text-center custom-tooltip-table"&gt;&lt;a href="#/sales/{{row.salesOrderId}}?viewDeliveryOrders=true" tooltip data-title="View Shipment Dropship" data-placement="left" ng-show="{{row.isBackToBack}}"&gt;&lt;img width="25px" alt="" src="assets/img/dropShippingIcon.svg"/&gt; &lt;/a&gt;&lt;/div&gt;'</span>,
                    sortable: <span style="color:#0000ff;">false</span>,
                    headerClass: <span style="color:#a31515;">'text-center unsortable'</span>,
                    width: <span style="color:#a31515;">'40px'</span>
                },
                {
                    field: <span style="color:#a31515;">'quotationId'</span>,
                    icon: <span style="color:#a31515;">'fa fa-file-text fa-large'</span>,
                    iconTitle: <span style="color:#a31515;">'View Quotation'</span>,
                    title: <span style="color:#a31515;">''</span>,
                    cellTemplate: <span style="color:#a31515;">'&lt;div class="text-center custom-tooltip-table"&gt;&lt;a href="#/quotations/{{row.quotationId}}" tooltip data-title="View Quotation" data-placement="left" ng-show="{{row.quotationId}}"&gt;&lt;i class="fa fa-file-text fa-large" /&gt;&lt;/a&gt;&lt;/div&gt;'</span>,
                    sortable: <span style="color:#0000ff;">false</span>,
                    headerClass: <span style="color:#a31515;">'text-center unsortable'</span>,
                    width: <span style="color:#a31515;">'40px'</span>
                },
                {
                    field: <span style="color:#a31515;">'salesOrderNumber'</span>,
                    icon: <span style="color:#a31515;">'fa fa-tag'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_ORDER_#'</span>),
                    cellTemplate: <span style="color:#a31515;">'&lt;a href="#/sales/{{row.salesOrderId}}{{functions.getCustomITPLink()}}" id="saleEditStep1" class="text-link text-success"&gt;{{row.salesOrderNumber}}&lt;/a&gt;'</span>,
                    width: <span style="color:#a31515;">'20%'</span>,
                    hideable: <span style="color:#0000ff;">false</span>
                },
                {
                    field: <span style="color:#a31515;">'saleChannel'</span>,
                    title: <span style="color:#a31515;">'# Sale Channel'</span>,
                    cellTemplate: <span style="color:#a31515;">'&lt;div ng-if="row.plugin && row.plugin.code == \'Xero\'"&gt;&lt;img src="/APP/assets/img/plugins/xero.png" tooltip data-title="Xero" data-placement="right" height="35" width="35"/&gt;&lt;/div&gt;'</span> +
                                  <span style="color:#a31515;">'&lt;div ng-if="row.plugin && row.plugin.code == \'MAGENTO\'"&gt;&lt;img src="/APP/assets/img/plugins/Magento.png" tooltip data-title="Magento" data-placement="right" height="35" width="35"/&gt;&lt;/div&gt;'</span> +
                                  <span style="color:#a31515;">'&lt;div ng-if="row.plugin && row.plugin.code == \'Shopify\'"&gt;&lt;img src="/APP/assets/img/plugins/shopify.png" tooltip data-title="Shopify" data-placement="right" height="35" width="35"/&gt;&lt;/div&gt;'</span> +
                                  <span style="color:#a31515;">'&lt;div ng-if="row.plugin && row.plugin.code == \'Woo\'"&gt;&lt;img src="/APP/assets/img/plugins/woo.png" tooltip data-title="Woo" data-placement="right" height="35" width="35"/&gt;&lt;/div&gt;'</span>,
                    width: <span style="color:#a31515;">'10%'</span>,
                    hideable: <span style="color:#0000ff;">false</span>
                },
                {
                    field: <span style="color:#a31515;">'companyName'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.COMPANY_NAME'</span>),
                    icon: <span style="color:#a31515;">'ionicons ion-ios-people'</span>,
                    width: <span style="color:#a31515;">'20%'</span>
                },
                {
                    field: <span style="color:#a31515;">'salesOrderFullfillmentStatus'</span>,
                    icon: <span style="color:#a31515;">'fa fa-truck'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.FULFILLMENT'</span>),
                    cellTemplate: <span style="color:#a31515;">'&lt;div id="fulfillmentStatusId" class="ngCellText"&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="row.salesOrderStatusId == 1 && row.isApprovalRequired"&gt;&nbsp;&nbsp;&nbsp;-&lt;/span&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="row.salesOrderStatusId == 2 || row.salesOrderStatusId == 3" ng-class="{ \'sale-order-pending-approval-color\' : row.salesOrderStatusId == 2, \'sale-order-not-approved-color\' : row.salesOrderStatusId == 3}" class="badge"&gt;SO {{row.salesOrderStatusId | salesStatus}}&lt;/span&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="(row.isApprovalRequired && row.salesOrderStatusId != 1 && row.salesOrderStatusId != 2 && row.salesOrderStatusId != 3) || (!row.isApprovalRequired)" ng-class="{ \'sale-order-inproress-color\' : row.salesOrderFullfillmentStatus == 1, \'sale-order-partially-delivered-color\' : row.salesOrderFullfillmentStatus == 2, \'sale-order-delivered-color\' : row.salesOrderFullfillmentStatus == 3 }" class="badge"&gt;{{row.salesOrderFullfillmentStatus | salesFullfillmentStatus}}&lt;/span&gt;'</span> +
                    <span style="color:#a31515;">'&lt;/div&gt;'</span>,
                    width: <span style="color:#a31515;">'20%'</span>
                },
                {
                    field: <span style="color:#a31515;">'salesOrderPaymentStatus'</span>,
                    icon: <span style="color:#a31515;">'fa fa-money'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'LABEL.ACC.PAYMENT'</span>),
                    cellTemplate: <span style="color:#a31515;">'&lt;div id="fulfillmentStatusId" class="ngCellText"&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="row.salesOrderStatusId == 1 && row.isApprovalRequired"&gt;&nbsp;&nbsp;&nbsp;-&lt;/span&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="row.salesOrderStatusId == 2 || row.salesOrderStatusId == 3" ng-class="{ \'sale-order-pending-approval-color\' : row.salesOrderStatusId == 2, \'sale-order-not-approved-color\' : row.salesOrderStatusId == 3}" class="badge"&gt;SO {{row.salesOrderStatusId | salesStatus}}&lt;/span&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-if="(row.isApprovalRequired && row.salesOrderStatusId != 1 && row.salesOrderStatusId != 2 && row.salesOrderStatusId != 3) || (!row.isApprovalRequired)" ng-class="{ \'sale-order-unpaid-color\' : row.salesOrderPaymentStatus == 1, \'sale-order-partial-paid-color\' : row.salesOrderPaymentStatus == 2, \'sale-order-paid-color\' : row.salesOrderPaymentStatus == 3 }" class="badge"&gt;{{row.salesOrderPaymentStatus | salesPaymentStatus}}&lt;/span&gt;'</span> +
                    <span style="color:#a31515;">'&lt;/div&gt;'</span>,
                    width: <span style="color:#a31515;">'20%'</span>
                },
                {
                    field: <span style="color:#a31515;">'salesOrderStatusId'</span>,
                    icon: <span style="color:#a31515;">'fa fa-circle-thin'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'GENERAL.LABEL.STATUS'</span>),
                    cellTemplate: <span style="color:#a31515;">'&lt;div class="ngCellText"&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span ng-class="{ \'sale-order-new-color\' : row.salesOrderFullfillmentStatus != 3 || row.salesOrderPaymentStatus != 3, \'sale-order-completed-color\' : row.salesOrderFullfillmentStatus == 3 && row.salesOrderPaymentStatus == 3 }" class="fa fa-circle"&gt;&lt;/span&gt;'</span> +
                        <span style="color:#a31515;">'&lt;span class="sales-order-font"&gt;{{((row.salesOrderFullfillmentStatus != 3 || row.salesOrderPaymentStatus != 3) ? "GENERAL.LABEL.OPEN" : "GENERAL.LABEL.CLOSED") | translate }}&lt;/span&gt;'</span> +
                    <span style="color:#a31515;">'&lt;/div&gt;'</span>,
                    width: <span style="color:#a31515;">'13%'</span>
                },
                {
                    field: <span style="color:#a31515;">'appSourceUrl'</span>,
                    title: <span style="color:#a31515;">''</span>,
                    cellTemplate: <span style="color:#a31515;">'&lt;a href="{{row.appSourceUrl}}" target="_blank"&gt;&lt;div class="app-icon-{{row.appSourceName}}"&gt;&lt;/div&gt;&lt;/a&gt;'</span>,
                    width: <span style="color:#a31515;">'5%'</span>
                },
                {
                    field: <span style="color:#a31515;">'dateOrdered'</span>,
                    icon: <span style="color:#a31515;">'fa fa-calendar'</span>,
                    title: $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.DATE_ORDERED'</span>),
                    cellFilter: <span style="color:#a31515;">'date'</span>,
                    width: <span style="color:#a31515;">'12%'</span>
                }
            ];

        $scope.functions = {
            getCustomITPLink: function () {
                <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                <span style="color:#0000ff;">if</span> (lessonCode.length) {
                    $rootScope.isITPRunning = <span style="color:#0000ff;">true</span>;
                } <span style="color:#0000ff;">else</span> {
                    $rootScope.isITPRunning = <span style="color:#0000ff;">false</span>;
                }

                <span style="color:#0000ff;">var</span> finalLink = <span style="color:#a31515;">""</span>;
                <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L2'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=OPR_ORD_SO_L2&step-code=2_2_2_2"</span>;
                            <span style="color:#0000ff;">if</span> ($rootScope.$itpService.isRelearnITPLesson()) {
                                finalLink += <span style="color:#a31515;">"&relearn-lesson=true"</span>;
                            }
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_DO_L2'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=OPR_ORD_DO_L2&step-code=2_3_2_2"</span>;
                            <span style="color:#0000ff;">if</span> ($rootScope.$itpService.isRelearnITPLesson()) {
                                finalLink += <span style="color:#a31515;">"&relearn-lesson=true"</span>;
                            }
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=OPR_ORD_SO_L3&step-code=2_2_3_3"</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=AO_ATSO_L3&step-code=2_2_1_101&relearn-lesson=true"</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=AO_ATSO_L4&step-code=10_1_4_2&relearn-lesson=true"</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=AO_ATSO_DO_L1&step-code=10_1_1_2&relearn-lesson=true"</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                            finalLink = <span style="color:#a31515;">"?lesson-code=AO_ATSO_SOTOINV&step-code=10_1_2_3&relearn-lesson=true"</span>;
                            <span style="color:#0000ff;">break</span>;
                    }
                }
                <span style="color:#0000ff;">return</span> finalLink;
            },
            deleteCustomer: function (id) {

            },

            totalSelectedItems: function () {
                <span style="color:#0000ff;">var</span> data = $scope.tableParams.data
                <span style="color:#0000ff;">if</span> (!data.length) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> totalSelectedItems = _.filter(data, function (so) {
                    <span style="color:#0000ff;">return</span> so.isSelected;
                });
                <span style="color:#0000ff;">var</span> result = <span style="color:#a31515;">''</span>;
                <span style="color:#0000ff;">if</span> (totalSelectedItems.length &gt; 0) {
                    result = <span style="color:#a31515;">'('</span> + totalSelectedItems.length + <span style="color:#a31515;">')'</span>
                }
                <span style="color:#0000ff;">return</span> result;
            },
            isCheckedAllItems: function (data) {
                <span style="color:#0000ff;">if</span> (!data) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> totalSelectedItems = _.filter(data, function (so) {
                    <span style="color:#0000ff;">return</span> so.isSelected;
                });

                <span style="color:#0000ff;">return</span> totalSelectedItems.length == data.length;
            },
            checkAllItems: function (data, statusOfHeaderCheckBox) {
                <span style="color:#0000ff;">if</span> (!data) <span style="color:#0000ff;">return</span>;

                angular.forEach(data, function (so) {
                    so.isSelected = statusOfHeaderCheckBox;
                });
            },

            openModalOfConvertedResults: function (dataTable, groupedField) {
                $modal.open({
                    backdrop: <span style="color:#a31515;">'static'</span>,
                    keyboard: <span style="color:#0000ff;">true</span>,
                    size: <span style="color:#a31515;">'md'</span>,
                    templateUrl: <span style="color:#a31515;">'ORD/Sales/TopMenuOfListingPage/convertMultipleSalesResultTable.modal.html?v='</span> + window.jsVersion,
                    controller: [<span style="color:#a31515;">"$scope"</span>, <span style="color:#a31515;">"$modalInstance"</span>, function ($scope, $modalInstance) {
                        $scope.totalSuccessfulSO = 0;
                        $scope.totalFailedSO = 0;

                        $scope.cancel = function () {
                            $modalInstance.close();
                        }

                        <span style="color:#0000ff;">if</span> (dataTable) {
                            <span style="color:#0000ff;">var</span> successList = _.filter(dataTable, function (node) {
                                <span style="color:#0000ff;">return</span> node.isSuccessful;
                            });
                            $scope.totalSuccessfulSO = successList.length || 0;
                            $scope.successTable = _.groupBy(successList, groupedField);

                            <span style="color:#0000ff;">var</span> failedList = _.filter(dataTable, function (node) {
                                <span style="color:#0000ff;">return</span> !node.isSuccessful;
                            });
                            $scope.totalFailedSO = failedList.length || 0;
                            $scope.failedTable = _.groupBy(failedList, groupedField);

                            <span style="color:#0000ff;">if</span> ($scope.totalSuccessfulSO &lt;= 0) <span style="color:#0000ff;">return</span>;

                            $timeout(function () {
                                <span style="color:#0000ff;">var</span> warningText = <span style="color:#a31515;">'A few of your field details for Sales Order are different. We took the latest Sales Order details by default, please check your Delivery Order fields again to confirm.'</span>;
                                <span style="color:#0000ff;">if</span> (groupedField == <span style="color:#a31515;">'convertedInvoiceNumber'</span>) {
                                    warningText = <span style="color:#a31515;">'A few of your Sales Oder field details are different. We took the latest Sales Order by default, please check your Invoice fields again.'</span>;
                                }
                                swal({
                                    title: <span style="color:#a31515;">'Notice'</span>,
                                    text: warningText,
                                    customClass: <span style="color:#a31515;">'greenConfirmationButton'</span>,
                                    type: <span style="color:#a31515;">'warning'</span>,
                                    showCancelButton: <span style="color:#0000ff;">false</span>,
                                    confirmButtonText: <span style="color:#a31515;">"OK, Got it"</span>
                                });
                            }, 1000);
                        }
                    }]
                });
            },
            convertMultipleSalesIntoADelivery: function () {
                <span style="color:#0000ff;">var</span> data = $scope.tableParams.data
                <span style="color:#0000ff;">if</span> (!data.length) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> salesOrderIds = [];
                _.each(data, function (so) {
                    <span style="color:#0000ff;">if</span> (so.isSelected) {
                        salesOrderIds.push(so.salesOrderId);
                    }
                });
                salesService.convertMultipleSalesIntoADelivery(salesOrderIds)
                .success(function (dataTable) {
                    $scope.tableParams.reload();

                    $scope.functions.openModalOfConvertedResults(dataTable, <span style="color:#a31515;">'convertedDeliveryOrderNumber'</span>);
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                .<span style="color:#0000ff;">finally</span>();
            },
            convertMultipleSalesToSeparateDelivery: function () {
                <span style="color:#0000ff;">var</span> data = $scope.tableParams.data
                <span style="color:#0000ff;">if</span> (!data.length) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> salesOrderIds = [];
                _.each(data, function (so) {
                    <span style="color:#0000ff;">if</span> (so.isSelected) {
                        salesOrderIds.push(so.salesOrderId);
                    }
                });
                salesService.convertMultipleSalesToSeparateDelivery(salesOrderIds)
                .success(function (dataTable) {
                    $scope.tableParams.reload();

                    $scope.functions.openModalOfConvertedResults(dataTable, <span style="color:#a31515;">'convertedDeliveryOrderNumber'</span>);
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                .<span style="color:#0000ff;">finally</span>();
            },
            convertMultipleSalesIntoAnInvoice: function () {
                <span style="color:#0000ff;">var</span> data = $scope.tableParams.data
                <span style="color:#0000ff;">if</span> (!data.length) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> salesOrderIds = [];
                _.each(data, function (so) {
                    <span style="color:#0000ff;">if</span> (so.isSelected) {
                        salesOrderIds.push(so.salesOrderId);
                    }
                });
                salesService.convertMultipleSalesIntoAnInvoice(salesOrderIds)
                .success(function (dataTable) {
                    $scope.tableParams.reload();

                    $scope.functions.openModalOfConvertedResults(dataTable, <span style="color:#a31515;">'convertedInvoiceNumber'</span>);
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                .<span style="color:#0000ff;">finally</span>();
            },
            convertMultipleSalesToSeparateInvoice: function () {
                <span style="color:#0000ff;">var</span> data = $scope.tableParams.data
                <span style="color:#0000ff;">if</span> (!data.length) <span style="color:#0000ff;">return</span>;

                <span style="color:#0000ff;">var</span> salesOrderIds = [];
                _.each(data, function (so) {
                    <span style="color:#0000ff;">if</span> (so.isSelected) {
                        salesOrderIds.push(so.salesOrderId);
                    }
                });
                salesService.convertMultipleSalesToSeparateInvoice(salesOrderIds)
                .success(function (dataTable) {
                    $scope.tableParams.reload();

                    $scope.functions.openModalOfConvertedResults(dataTable, <span style="color:#a31515;">'convertedInvoiceNumber'</span>);
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                .<span style="color:#0000ff;">finally</span>();
            },
        };

        salesService.topTags()
            .success(function (data) {
                $scope.tags = data;
            });

    }]);


ORD.controller(<span style="color:#a31515;">'SalesViewCtrl'</span>, [<span style="color:#a31515;">'userService'</span>, <span style="color:#a31515;">'deliveryMethodService'</span>, <span style="color:#a31515;">'deliveryTermService'</span>, <span style="color:#a31515;">'creditTermService'</span>, <span style="color:#a31515;">'Auth'</span>, <span style="color:#a31515;">'taxCodeService'</span>, <span style="color:#a31515;">'emergeNotification'</span>, <span style="color:#a31515;">'$window'</span>, <span style="color:#a31515;">'$cookieStore'</span>, <span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$emerge'</span>, <span style="color:#a31515;">'$interval'</span>, <span style="color:#a31515;">'$rootScope'</span>, <span style="color:#a31515;">'$firebaseObject'</span>, <span style="color:#a31515;">'$http'</span>, <span style="color:#a31515;">'$route'</span>,
    <span style="color:#a31515;">'$routeParams'</span>, <span style="color:#a31515;">'$timeout'</span>, <span style="color:#a31515;">'$location'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'$modal'</span>, <span style="color:#a31515;">'$translate'</span>, <span style="color:#a31515;">'hotkeys'</span>, <span style="color:#a31515;">'errorDisplay'</span>, <span style="color:#a31515;">'salesService'</span>, <span style="color:#a31515;">'purchaseService'</span>, <span style="color:#a31515;">'customerService'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'userService'</span>, <span style="color:#a31515;">'$log'</span>,
    function (userService, deliveryMethodService, deliveryTermService, creditTermService, Auth, taxCodeService, emergeNotification, $window, $cookieStore, $scope, $emerge, $interval, $rootScope, $firebaseObject, $http, $route, $routeParams, $timeout, $location, $filter, $modal, $translate, hotkeys, errorDisplay, salesService, purchaseService, customerService, productService, userService, $log) {
        $scope.readOnly = <span style="color:#0000ff;">true</span>;
        $scope.currentActiveMenuTab = { overview: <span style="color:#0000ff;">true</span> };

        <span style="color:#008000;">/* DECLARE ALL VARIABLES */</span>
        $scope.selected = {}; 
        $scope.selected.customer = {};
        $scope.selectedCurrency = {};
        $scope.totalTasksAndNotes = {};
        $scope.newSODsInMapping = [];

        $scope.customerId;
        $scope.customer;
        $scope.totalQuantity = 0;
        $scope.totalPrice = 0;
        $scope.totalGST = 0;
        $scope.totalGrand = 0;

        $scope.busy = <span style="color:#0000ff;">false</span>; 
        $scope.converting = <span style="color:#0000ff;">false</span>;
        $scope.isReservation = <span style="color:#0000ff;">true</span>;
        $scope.showDiscount = <span style="color:#0000ff;">false</span>; 
        $scope.previousCustomerId = <span style="color:#0000ff;">null</span>;
        $scope.isChangedCustomer = <span style="color:#0000ff;">false</span>; 
        $scope.sales = {
            billContacts: <span style="color:#0000ff;">null</span>,
            shipContacts: <span style="color:#0000ff;">null</span>
        };
        $scope.sales.salesOrderDetailsList_Items = [];
        $scope.sales.salesOrderDetailsList_Additionals = [];

        $scope.num = {
            invoice: <span style="color:#0000ff;">null</span>,
            delivery: <span style="color:#0000ff;">null</span>,
            packingList: <span style="color:#0000ff;">null</span>
        };

        $scope.isNewSalesOrder = <span style="color:#0000ff;">true</span>;

        <span style="color:#0000ff;">var</span> salesId = $routeParams.id;
        <span style="color:#0000ff;">var</span> poB2B = [];
        <span style="color:#0000ff;">var</span> firstLoad = <span style="color:#0000ff;">true</span>;
        <span style="color:#0000ff;">var</span> initialCurrencyId = <span style="color:#0000ff;">null</span>;
        <span style="color:#0000ff;">var</span> initialCurrencyExchangeRate = <span style="color:#0000ff;">null</span>;

        <span style="color:#0000ff;">var</span> userName = $rootScope.appUser.userName,
            userId = $rootScope.appUser.userId;

        function guid() {
            function s4() {
                <span style="color:#0000ff;">return</span> Math.floor((1 + Math.random()) * 0x10000)
                  .toString(16)
                  .substring(1);
            }
            <span style="color:#0000ff;">return</span> s4() + s4() + <span style="color:#a31515;">'-'</span> + s4() + <span style="color:#a31515;">'-'</span> + s4() + <span style="color:#a31515;">'-'</span> +
              s4() + <span style="color:#a31515;">'-'</span> + s4() + s4() + s4();
        }

        <span style="color:#008000;">/* ALL FUNCTIONS GO HERE */</span>
        $scope.initializing = <span style="color:#0000ff;">true</span>;
        $scope._init = function () {
            $scope.isCreate = !$routeParams.id;
            $scope.isCustomer = <span style="color:#0000ff;">true</span>;
            $rootScope.hideSidebar = <span style="color:#0000ff;">false</span>;
            $scope.customerHidden = <span style="color:#0000ff;">false</span>;
            $scope.loadDeliveryTabFirst = $routeParams.loadDeliveryTabFirst == <span style="color:#a31515;">"true"</span> ? <span style="color:#0000ff;">true</span> : <span style="color:#0000ff;">false</span>;

            <span style="color:#0000ff;">if</span> ($scope.loadDeliveryTabFirst) {
                $scope.currentActiveMenuTab = {
                    info: <span style="color:#0000ff;">false</span>,
                    delivery: <span style="color:#0000ff;">true</span>
                }
            }

            $scope.sales.tax = 7;
            $scope.newSalesItem = {};
            $scope.sales.salesOrderDetailsList_Items = [{
                isItem: <span style="color:#0000ff;">true</span>
            }];
            $scope.sales.salesOrderDetailsList_Additionals = [];
            <span style="color:#0000ff;">if</span> (salesId) {
                $scope.isNewSalesOrder = <span style="color:#0000ff;">false</span>;
                salesService.<span style="color:#0000ff;">get</span>(salesId)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> productIds = [];
                        $scope.sales = data;

                        <span style="color:#0000ff;">if</span> (angular.isString(data.tags)) {
                            $scope.sales.tags = data.tags.split(<span style="color:#a31515;">','</span>);
                        }

                        $scope.sales.questionMarkEmailBtn = <span style="color:#a31515;">'LABEL.ITP.SALES.Q_EMAIL'</span>;
                        $scope.sales.questionMarkCustomizedBtn = <span style="color:#a31515;">'LABEL.ITP.SALES.Q_CUSTOMIZE'</span>;

                        $scope.sales.tax = $filter(<span style="color:#a31515;">'number'</span>)($scope.sales.tax * 100, 2);
                        poB2B = data.purchaseOrders;
                        initialCurrencyId = data.currencyId;
                        initialCurrencyExchangeRate = data.exchangeRate;
                        $scope.statusArr = salesService.getAllStatus(data.settings.isApprovalRequired, <span style="color:#0000ff;">true</span>);
                        angular.forEach(data.salesOrderDetailsList, function (k, v) {
                            k.idForCheckBox = guid();

                            <span style="color:#0000ff;">if</span> (k.productId) {
                                productIds.push(k.productId);
                            }

                            <span style="color:#0000ff;">if</span> (k.salesOrderDetailsDropShipList && k.salesOrderDetailsDropShipList.length) {
                                k.isDropship = <span style="color:#0000ff;">true</span>;
                            }

                            angular.forEach(k.salesPurchaseMappingList, function (k1, v1) {
                                k1.purchaseOrderNumber = k1.purchaseOrderDetails.purchaseOrder.purchaseOrderNumber;
                            });
                        });

                        <span style="color:#0000ff;">if</span> ($scope.sales.billAttn) {
                            $scope.sales.billAttn = $scope.sales.billAttn.split(<span style="color:#a31515;">','</span>);
                        }

                        <span style="color:#0000ff;">if</span> ($scope.sales.shipAttn) {
                            $scope.sales.shipAttn = $scope.sales.shipAttn.split(<span style="color:#a31515;">','</span>);
                        }

                        <span style="color:#0000ff;">if</span> (data.customer && data.customer.contactList) {
                            $scope.customer = data.customer;

                            $scope.getShippingAndBillingAttentionContacts(data.customer);
                        }


                        <span style="color:#0000ff;">if</span> (data.salesOrderDetailsList.length) {

                            $scope.sales.salesOrderDetailsList_Items = _.filter(data.salesOrderDetailsList, function (item) {
                                <span style="color:#0000ff;">return</span> !!item.productId;
                            });
                            $scope.sales.salesOrderDetailsList_Additionals = _.filter(data.salesOrderDetailsList, function (item) {
                                <span style="color:#0000ff;">return</span> !item.productId;
                            });
                        }
                        <span style="color:#0000ff;">else</span> {
                            $scope.sales.salesOrderDetailsList_Items = [{
                                isItem: <span style="color:#0000ff;">true</span>
                            }];
                            $scope.sales.salesOrderDetailsList_Additionals = [];
                        }

                        <span style="color:#0000ff;">if</span> ($emerge.getRTCEnabled() == <span style="color:#0000ff;">true</span>) {
                            $scope.firebaseSales(data);
                        }

                        $scope.showHideDiscount();
                        $scope.busy = <span style="color:#0000ff;">false</span>;

                        $timeout(function () {
                            <span style="color:#0000ff;">if</span> ($scope.myForm) {
                                $scope.myForm.$setPristine();
                            }
                        }, 1000);

                        $scope.showDiscount = $scope.sales.salesOrderDetailsList_Additionals.length &gt; 0 ? <span style="color:#0000ff;">true</span> : <span style="color:#0000ff;">false</span>;
                        <span style="color:#0000ff;">if</span> ($location.search().viewDeliveryOrders) {
                            $timeout(function () {
                                $(<span style="color:#a31515;">'#itpClickOnDOTab &gt; a'</span>).trigger(<span style="color:#a31515;">"click"</span>);
                            });
                        }
                        $rootScope.$broadcast(<span style="color:#a31515;">'currencyChange'</span>, { currencyId: $scope.sales.currencyId, setDefault: <span style="color:#0000ff;">false</span> });
                        productService.getProductsOverview(productIds)
                        .success(function (overviewData) {
                            angular.forEach($scope.sales.salesOrderDetailsList_Items, function (SOD) {
                                <span style="color:#0000ff;">var</span> firstQtyOverview = _.find(overviewData, function (node) {
                                    <span style="color:#0000ff;">return</span> node.productId == SOD.productId;
                                });

                                SOD.qtyOverview = firstQtyOverview;
                                SOD.oldQty = angular.copy(SOD.qty * SOD.productUOMValue);
                                SOD = $scope.getAvaiQtyTooltipText(firstQtyOverview, SOD);
                            });

                            <span style="color:#0000ff;">if</span> (!$scope.readOnly) <span style="color:#0000ff;">return</span>;
                            <span style="color:#0000ff;">if</span> ($scope.sales.creditTermId) {
                                creditTermService.getCreditTermObjectById($scope.sales.creditTermId).success(function (data) {
                                    $scope.sales.creditTerm = data;
                                });
                            }
                            <span style="color:#0000ff;">if</span> ($scope.sales.deliveryTermId) {
                                deliveryTermService.getDeliveryTermObjectById($scope.sales.deliveryTermId).success(function (data) {
                                    $scope.sales.deliveryTerm = data;
                                });
                            }
                            <span style="color:#0000ff;">if</span> ($scope.sales.deliveryMethodId) {
                                deliveryMethodService.getDeliveryMethodObjectById($scope.sales.deliveryMethodId).success(function (data) {
                                    $scope.sales.deliveryMethod = data;
                                });
                            }
                            <span style="color:#0000ff;">if</span> ($scope.sales.salesPersonId) {
                                userService.getSalesPersonObjectById($scope.sales.salesPersonId).success(function (data) {
                                    $scope.sales.salesPerson = data;
                                });
                            }
                        })
                        .error(function (error) {
                            console.log(error);
                        })
                        .<span style="color:#0000ff;">finally</span>();

                    })
                    .error(function (data, status, headers, config) {
                        errorDisplay.show(data, status, headers, config);
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $timeout(function () {
                            $scope.initializing = <span style="color:#0000ff;">false</span>;
                        }, 1000);
                    });
            } <span style="color:#0000ff;">else</span> {
                $scope.isNewSalesOrder = <span style="color:#0000ff;">true</span>;

                <span style="color:#0000ff;">var</span> newCustomerId = $routeParams.customerId;

                <span style="color:#0000ff;">if</span> (newCustomerId) {
                    $scope.sales.customerId = newCustomerId;
                }
                $timeout(function () {
                    $scope.initializing = <span style="color:#0000ff;">false</span>;
                }, 1000);
                $scope.busy = <span style="color:#0000ff;">false</span>;
            }

            $scope.sortableOptions = {
                placeholder: <span style="color:#a31515;">"my-custom-css"</span>,
                handle: <span style="color:#a31515;">'.myHandle'</span>,
                scroll: <span style="color:#0000ff;">false</span>,
                stop: function (e, ui) {
                    <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> index <span style="color:#0000ff;">in</span> $scope.sales.salesOrderDetailsList_Items) {
                        $scope.sales.salesOrderDetailsList_Items[index].order = index;
                    }
                }
            }
        };

        $scope.showHideDiscount = function () {
            <span style="color:#0000ff;">var</span> data = $scope.sales;
            <span style="color:#0000ff;">if</span> (data.additionalCharges || data.freight || data.discountAmount) {
                $scope.showDiscount = <span style="color:#0000ff;">true</span>;
            }
        };

        $scope.getAvaiQtyTooltipText = function (qtyOverview, item) {
            <span style="color:#0000ff;">if</span> (item.isService) {
                <span style="color:#0000ff;">return</span> item;
            }

            <span style="color:#0000ff;">var</span> currentUOMValue = item.productUOMValue || 1;
            <span style="color:#0000ff;">var</span> currentQtyInBaseUOM = (item.qty || 0) * currentUOMValue;
            <span style="color:#0000ff;">var</span> oldQty = item.oldQty || 0;

            <span style="color:#0000ff;">if</span> (!qtyOverview) {
                <span style="color:#0000ff;">return</span>;
            }

            <span style="color:#0000ff;">var</span> physicalQty = qtyOverview.physicalQtyInBaseUOM;
            <span style="color:#0000ff;">var</span> avaiExcluPO = physicalQty - qtyOverview.soldQtyInBaseUOM +
                              qtyOverview.dropShippedPOQtyInBaseUOM + qtyOverview.deliveredQtyInBaseUOM;
            <span style="color:#0000ff;">var</span> avaiIncluPO = physicalQty - qtyOverview.soldQtyInBaseUOM +
                              qtyOverview.dropShippedPOQtyInBaseUOM + qtyOverview.deliveredQtyInBaseUOM +
                              qtyOverview.boughtQtyInBaseUOM - qtyOverview.receivedQtyInBaseUOM;

            avaiExcluPO = avaiExcluPO - (parseInt(currentQtyInBaseUOM) - oldQty);
            avaiIncluPO = avaiIncluPO - (parseInt(currentQtyInBaseUOM) - oldQty);

            item.tooltipText = <span style="color:#a31515;">''</span>;
            item.tooltipText = <span style="color:#a31515;">'&lt;div class="wrapper-xs text-left block"&gt;&lt;span class="pull-left p-r-lg"&gt;'</span> + $translate.instant(<span style="color:#a31515;">'LABEL.ORD.AVAIL_EXCL_PO'</span>) + <span style="color:#a31515;">': &lt;/span&gt; &lt;strong class="pull-right"&gt;'</span> + avaiExcluPO + <span style="color:#a31515;">'&lt;/strong&gt;&lt;/div&gt;'</span>
            item.tooltipText += <span style="color:#a31515;">'&lt;div class="wrapper-xs text-left block"&gt;&lt;span class="pull-left p-r-lg"&gt;'</span> + $translate.instant(<span style="color:#a31515;">'LABEL.ORD.AVAIL_INCL_PO'</span>) + <span style="color:#a31515;">': &lt;/span&gt; &lt;strong class="pull-right"&gt;'</span> + avaiIncluPO + <span style="color:#a31515;">'&lt;/strong&gt;&lt;/div&gt;'</span>
            item.tooltipText += <span style="color:#a31515;">'&lt;div class="wrapper-xs text-left block"&gt;&lt;span class="pull-left p-r-lg"&gt;'</span> + $translate.instant(<span style="color:#a31515;">'LABEL.GENERAL.PHYSICAL'</span>) + <span style="color:#a31515;">': &lt;/span&gt; &lt;strong class="pull-right"&gt;'</span> + physicalQty + <span style="color:#a31515;">'&lt;/strong&gt;&lt;/div&gt;'</span>;

            <span style="color:#0000ff;">return</span> item;
        }

        $scope.updateTierPrices = function (refreshMultiPriceList, item) {
            <span style="color:#0000ff;">var</span> customerId = <span style="color:#0000ff;">null</span>;
            <span style="color:#0000ff;">var</span> customerGroupId = <span style="color:#0000ff;">null</span>;
            item = item || {};

            <span style="color:#0000ff;">var</span> poNumber = _.filter(item.salesPurchaseMappingList, function (po) {
                <span style="color:#0000ff;">return</span> po.salesOrderDetailId == item.salesOrderDetailId;
            });
            <span style="color:#0000ff;">if</span> (poNumber && poNumber.length) {
                <span style="color:#0000ff;">var</span> str = $translate.instant(<span style="color:#a31515;">'ALERT.WARN_CHANGES_QTYSO_HAS_PO'</span>, { poNumber: poNumber[0].purchaseOrderNumber });
                alert(str);
            }

            <span style="color:#0000ff;">if</span> ($scope.customer) {
                customerId = $scope.customer.customerId;
                customerGroupId = $scope.customer.customerGroupId;
            }
            <span style="color:#0000ff;">var</span> _warn = function (skip) {
                <span style="color:#0000ff;">if</span> (!skip) {
                    <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.WARN_TIERPRICING_CHANGES'</span>))) {
                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                    } <span style="color:#0000ff;">else</span> {
                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                    }
                    ;
                } <span style="color:#0000ff;">else</span> {
                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                }
            };

            angular.forEach($scope.sales.salesOrderDetailsList_Items, function (sod) {
                <span style="color:#0000ff;">var</span> warned = <span style="color:#0000ff;">false</span>;
                <span style="color:#0000ff;">var</span> foundPrice = <span style="color:#0000ff;">false</span>;
                <span style="color:#0000ff;">var</span> _updatePrices = function (data) {
                    <span style="color:#0000ff;">if</span> (!refreshMultiPriceList && (item.salesOrderDetailsId != sod.salesOrderDetailsId || sod.salesOrderDetailsId) && sod.salesOrderDetailsId != 0) {
                        <span style="color:#0000ff;">return</span>;
                    }
                    <span style="color:#0000ff;">var</span> matchedPricesCustomer = _.filter(data, function (list) {
                        list.quantity = list.quantity || 1;
                        <span style="color:#0000ff;">return</span> (list.customerId) && (sod.qty &gt;= (list.quantity)) && (list.productUOMId == sod.productUOMId);
                    });


                    matchedPricesCustomer = $filter(<span style="color:#a31515;">'orderBy'</span>)(matchedPricesCustomer, <span style="color:#a31515;">'quantity'</span>, <span style="color:#0000ff;">true</span>);
                    <span style="color:#0000ff;">if</span> (matchedPricesCustomer.length) {
                        <span style="color:#0000ff;">if</span> (sod.unitPrice != matchedPricesCustomer[0].unitPrice) {
                            <span style="color:#0000ff;">if</span> (_warn(warned)) {
                                sod.unitPrice = matchedPricesCustomer[0].unitPrice;

                                <span style="color:#0000ff;">return</span>;
                            }
                        }
                        foundPrice = <span style="color:#0000ff;">true</span>;
                    }

                    <span style="color:#0000ff;">if</span> (sod.product && !foundPrice) {

                        <span style="color:#0000ff;">var</span> productTierPriceList = angular.copy(sod.product.productTierPriceList) || [];
                        productTierPriceList = $filter(<span style="color:#a31515;">'orderBy'</span>)(productTierPriceList, <span style="color:#a31515;">'quantity'</span>, <span style="color:#0000ff;">true</span>);

                        <span style="color:#0000ff;">if</span> (productTierPriceList.length &gt; 0) {
                            <span style="color:#008000;">// (PRIORITY) GET PRICE FOR CUSTOMER's GROUP</span>
                            <span style="color:#0000ff;">var</span> groupMatchedTierPriceList = _.filter(productTierPriceList, function (item) {
                                <span style="color:#0000ff;">return</span> item.customerGroupId == customerGroupId && item.quantity &lt;= sod.qty && item.productUOMId == sod.productUOMId
                            });

                            <span style="color:#0000ff;">if</span> (groupMatchedTierPriceList.length &gt; 0) {
                                <span style="color:#008000;">// if prices different then prompt that there's changes</span>
                                <span style="color:#0000ff;">if</span> (sod.unitPrice != groupMatchedTierPriceList[0].unitPrice) {
                                    <span style="color:#0000ff;">if</span> (_warn(warned)) {
                                        sod.unitPrice = groupMatchedTierPriceList[0].unitPrice;
                                    }
                                }
                            }

                            <span style="color:#008000;">// skip below if there's customer's group tier price</span>
                            <span style="color:#0000ff;">if</span> (groupMatchedTierPriceList.length &gt; 0) {
                                <span style="color:#0000ff;">return</span>;
                            }

                            <span style="color:#008000;">// (LAST) GET PRICE FOR ALL GROUPS ONLY</span>
                            <span style="color:#0000ff;">var</span> matchedTierPriceList = _.filter(productTierPriceList, function (item) {
                                <span style="color:#0000ff;">return</span> !item.customerGroupId && item.quantity &lt;= sod.qty && item.productUOMId == sod.productUOMId;
                            });
                            <span style="color:#0000ff;">if</span> (matchedTierPriceList.length &gt; 0) {

                                <span style="color:#008000;">// if prices different then prompt that there's changes</span>
                                <span style="color:#0000ff;">if</span> (sod.unitPrice != matchedTierPriceList[0].unitPrice) {
                                    <span style="color:#0000ff;">if</span> (_warn()) {
                                        sod.unitPrice = matchedTierPriceList[0].unitPrice;
                                    }

                                    warned = <span style="color:#0000ff;">true</span>;
                                }
                            } <span style="color:#0000ff;">else</span> {
                                <span style="color:#0000ff;">var</span> uom = $scope.getUOM(sod);

                                <span style="color:#0000ff;">if</span> (uom) {
                                    sod.unitPrice = uom.priceSelling;
                                } <span style="color:#0000ff;">else</span> {
                                    sod.unitPrice = sod.product.priceSelling;
                                }
                            }
                        }
                    }
                }

                <span style="color:#008000;">// MULTI PRICE LIST CALCULATIONS</span>
                <span style="color:#0000ff;">if</span> (refreshMultiPriceList == <span style="color:#0000ff;">true</span>) {
                    sod.multiPriceList = <span style="color:#0000ff;">null</span>;
                }

                <span style="color:#0000ff;">if</span> (sod.multiPriceList == <span style="color:#0000ff;">null</span> && sod.productId) {
                    productService.queryMultiPriceList(sod.productId, customerId)
                        .then(function (data) {
                            <span style="color:#0000ff;">var</span> priceList = data.data;
                            sod.multiPriceList = priceList;
                            _updatePrices(priceList);
                        });
                } <span style="color:#0000ff;">else</span> {
                    _updatePrices(sod.multiPriceList);
                }
            });
        };

        <span style="color:#008000;">/* Start - TOP MENU'S FUNCTIONS */</span>
        $scope.approve = function () {
            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.APPROVAL_APPROVING'</span>))) {
                $scope.approving = <span style="color:#0000ff;">true</span>;
                salesService.approve(salesId).success(function (data) {
                    $scope.myForm.$setPristine();
                    alert($translate.instant(<span style="color:#a31515;">'ALERT.APPROVAL_APPROVED'</span>));

                    <span style="color:#0000ff;">if</span> ($scope.sales.autoConvertToDOAfterSOCreated && $scope.num.delivery &lt;= 0) {
                        $scope.converting = <span style="color:#0000ff;">true</span>;
                        salesService.convertToDelivery($scope.sales.salesOrderId, <span style="color:#0000ff;">true</span>)
                        .success(function (data) {
                            <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.DELIVERY_CONVERTED'</span>));

                                $location.url(<span style="color:#a31515;">'sales'</span>);
                            }

                            <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                            } <span style="color:#0000ff;">else</span> {
                                callbackFunc();
                            }
                        })
                        .error(function (error) {
                            <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                $rootScope.openSaaSMessage(error);
                            }
                            <span style="color:#0000ff;">else</span> {
                                <span style="color:#0000ff;">if</span> (error) {
                                    alert($translate.instant(error.message));
                                }
                            }
                        })
                        .<span style="color:#0000ff;">finally</span>(function () {
                            $scope.converting = <span style="color:#0000ff;">false</span>;
                        });
                    } <span style="color:#0000ff;">else</span> {
                        $location.url(<span style="color:#a31515;">'sales'</span>);
                    }
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                .<span style="color:#0000ff;">finally</span>(function () {
                    $scope.approving = <span style="color:#0000ff;">false</span>;
                });
            }
        };

        $scope.rejectSo = function () {
            <span style="color:#0000ff;">if</span> ($scope.num) {
                <span style="color:#0000ff;">if</span> ($scope.num.delivery && $scope.num.delivery &gt; 0) {
                    alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SALES_HAS_DELIVER_CANNOT_REJECT'</span>));
                    <span style="color:#0000ff;">return</span>;
                }
                <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> ($scope.num.invoice && $scope.num.invoice &gt; 0) {
                    alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SALES_HAS_INVOICE_CANNOT_REJECT'</span>));
                    <span style="color:#0000ff;">return</span>;
                }
                <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> ($scope.sales.isBackToBack) {
                    alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SALES_HAS_PURCHASE_CANNOT_REJECT'</span>));
                    <span style="color:#0000ff;">return</span>;
                }
            }

            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.REJECT_SEND'</span>))) {
                $scope.approving = <span style="color:#0000ff;">true</span>;
                salesService.rejectSo(salesId).success(function (data) {
                    $scope.myForm.$setPristine();
                    alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SALES_REJECTED'</span>));
                    $location.url(<span style="color:#a31515;">'sales'</span>);
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.approving = <span style="color:#0000ff;">false</span>;
                    });
            }
        };

        $scope.downloadPDF = function (sales) {
            $rootScope.downloadPDF(salesService, sales, sales.salesOrderId, sales.salesOrderNumber);
        };

        <span style="color:#008000;">// open pdf dialog</span>
        $scope.openSalesPDF = function (sales) {
            <span style="color:#0000ff;">var</span> emailSubject = <span style="color:#a31515;">""</span>;
            <span style="color:#0000ff;">var</span> subjectPrefix = $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_ORDER'</span>);
            <span style="color:#0000ff;">if</span> (sales.customer) {
                emailSubject = $rootScope.createEmailSubject(subjectPrefix, sales.salesOrderNumber, sales.customer.companyName);
            }
            $rootScope.openPDFModal(salesService, sales, sales.salesOrderNumber, sales.salesOrderId, emailSubject);
        };

        <span style="color:#008000;">// open email dialog</span>
        $scope.openEmail = function (sales) {
            <span style="color:#0000ff;">var</span> emailSubject = <span style="color:#a31515;">""</span>;
            <span style="color:#0000ff;">var</span> subjectPrefix = $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_ORDER'</span>);
            <span style="color:#0000ff;">if</span> (sales.customer) {
                emailSubject = $rootScope.createEmailSubject(subjectPrefix, sales.salesOrderNumber, sales.customer.companyName);
            }

            $rootScope.openEmailModal(salesService, sales, sales.salesOrderId, emailSubject);
        };

        $scope.openProposePurchase = function (newSales, isBackdrop, isKeyboard, type, isPackAll) {
            <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">'Propose'</span>) {
                salesService.CheckIfSalesHasDropship(newSales.salesOrderId)
                        .success(function (data) {
                            <span style="color:#0000ff;">if</span> (data) {
                                <span style="color:#0000ff;">var</span> dialog = $modal.open({
                                    backdrop: isBackdrop,
                                    keyboard: isKeyboard,
                                    size: <span style="color:#a31515;">'lg'</span>,
                                    templateUrl: <span style="color:#a31515;">'ORD/Sales/SalesEdit/proposePurchase.modal.html?a=aa'</span>,
                                    controller: [<span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$log'</span>, <span style="color:#a31515;">'$modalInstance'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'purchaseService'</span>,
                                        function ($scope, $log, $modalInstance, $filter, productService, purchaseService) {
                                            $scope.sales = newSales;
                                            $scope.newPurchaseOrders = [];
                                            $scope.loading = <span style="color:#0000ff;">true</span>;
                                            $scope.isBackToBack = <span style="color:#0000ff;">false</span>;
                                            $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                            $scope.selected = {};
                                            $scope.selected.supplier = {};

                                            <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"Propose"</span>) {
                                                salesService.proposePurchase(newSales.salesOrderId)
                                                    .success(function (data) {
                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                                            $scope.loading = <span style="color:#0000ff;">true</span>;

                                                            <span style="color:#0000ff;">if</span> (isPackAll) {
                                                                $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                            }

                                                            angular.forEach(data, function (v, k) {
                                                                v.error = <span style="color:#0000ff;">false</span>;
                                                                v.proposed = <span style="color:#0000ff;">false</span>;
                                                            });
                                                            $scope.newPurchaseOrders = data;
                                                            $scope.isBackToBack = <span style="color:#0000ff;">true</span>;<span style="color:#008000;">// using to detect where conversing B2B or normal PO</span>
                                                            angular.forEach($scope.newPurchaseOrders, function (_po, k) {
                                                                <span style="color:#0000ff;">if</span> (_po.supplier && _po.supplier.currency) {
                                                                    _po.currentCurrencyCode = _po.supplier.currency.symbol;
                                                                }

                                                                <span style="color:#008000;">/* Keep mapping (reserved) qty for later use. */</span>
                                                                angular.forEach(_po.purchaseOrderDetailsList, function (_pod, i) {
                                                                    <span style="color:#0000ff;">if</span> (!_pod.salesPurchaseMappingList || !_pod.salesPurchaseMappingList.length) {
                                                                        <span style="color:#0000ff;">return</span>;
                                                                    }
                                                                    _pod.defaultConvertedProposedQtyFromSOD = (_pod.salesPurchaseMappingList[0].qty ? _pod.salesPurchaseMappingList[0].qty : 0) *
                                                                        (_pod.productUOMValue ? _pod.productUOMValue : 1);
                                                                });
                                                            });

                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $timeout(function () {
                                                                    $rootScope.$itpService.startFromStep(<span style="color:#a31515;">'10_1_4_3'</span>, $scope.callbackArr);

                                                                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                                    $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;
                                                                }, 800);
                                                            }

                                                            $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                        $scope.loading = <span style="color:#0000ff;">false</span>;

                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.$itpService.stopIntroJs();
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#008000;">// Tai: code debt, need test (reason for holding: product edit page stuck)</span>
                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                    window.location = <span style="color:#a31515;">"index.html#/products"</span>;
                                                                }
                                                            } <span style="color:#0000ff;">else</span> {
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                }
                                                                <span style="color:#0000ff;">else</span> {
                                                                    alert($translate.instant(error.message));
                                                                }
                                                            }
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>(function () {

                                                    });
                                            } <span style="color:#0000ff;">else</span> {
                                                salesService.convertToPurchase(newSales.salesOrderId)
                                                    .success(function (data) {

                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                                            $scope.loading = <span style="color:#0000ff;">true</span>;
                                                            $scope.newPurchaseOrders = data;

                                                            <span style="color:#008000;">//add UOM list, set error, proposed = false, </span>
                                                            angular.forEach($scope.newPurchaseOrders, function (v, k) {
                                                                v.error = <span style="color:#0000ff;">false</span>;
                                                                v.proposed = <span style="color:#0000ff;">false</span>;

                                                                angular.forEach(v.purchaseOrderDetailsList, function (_pod, i) {
                                                                    <span style="color:#0000ff;">if</span> (!_pod.salesPurchaseMappingList || !_pod.salesPurchaseMappingList.length) {
                                                                        <span style="color:#0000ff;">return</span>;
                                                                    }
                                                                    _pod.defaultConvertedProposedQtyFromSOD =
                                                                        (_pod.salesPurchaseMappingList[0].qty ? _pod.salesPurchaseMappingList[0].qty : 0) *
                                                                        (_pod.productUOMValue ? _pod.productUOMValue : 1);
                                                                });
                                                            });

                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $timeout(function () {
                                                                    <span style="color:#0000ff;">var</span> nextStepId;
                                                                    <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                            nextStepId = <span style="color:#a31515;">'2_2_1_102'</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">default</span>:
                                                                            <span style="color:#008000;">//lesson-code = OPR_ORD_SO_L1</span>
                                                                            nextStepId = <span style="color:#a31515;">'2_2_1_13'</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                    }

                                                                    $rootScope.$itpService.startFromStep(nextStepId, $scope.callbackArr);

                                                                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                                    $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;
                                                                }, 800);
                                                            }

                                                            $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.$itpService.stopIntroJs();
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#008000;">// Tai: code debt, need test (reason for holding: product edit page stuck)</span>
                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                    window.location = <span style="color:#a31515;">"index.html#/products"</span>;
                                                                }
                                                            } <span style="color:#0000ff;">else</span> {
                                                                <span style="color:#008000;">//errorDisplay.show(error);</span>
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                }
                                                            }
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>(function () {
                                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                    });
                                            }

                                            $scope.type = type;

                                            $scope.onChangedProduct = function (index, item, purchase) {
                                                <span style="color:#0000ff;">var</span> detail = purchase.purchaseOrderDetailsList[index];

                                                detail.product = {};
                                                <span style="color:#008000;">// Get the purchaseOrderDetailsId so able to update the line item</span>
                                                detail.purchaseOrderDetailsId = purchase.purchaseOrderDetailsId;

                                                <span style="color:#0000ff;">if</span> (item.isVariantOfProductId) {
                                                    detail.itemName = $rootScope.getProductVariantName(item.parentProduct, item);
                                                } <span style="color:#0000ff;">else</span> {
                                                    detail.itemName = item.name;
                                                }

                                                <span style="color:#008000;">//set default tax code if it exists</span>
                                                detail.taxCodeId = item.defaultTaxId;

                                                detail.unitPrice = item.priceCost;
                                                detail.description = item.description;
                                                detail.product = item;
                                                <span style="color:#008000;">//detail.product.productUOMList = item.productUOMList;</span>
                                            };

                                            $scope.allPOProposed = function () {
                                                <span style="color:#0000ff;">var</span> result = <span style="color:#0000ff;">true</span>;
                                                <span style="color:#0000ff;">if</span> ($scope.newPurchaseOrders && $scope.newPurchaseOrders.length) {
                                                    angular.forEach($scope.newPurchaseOrders, function (po, poIndex) {
                                                        result = result && po.proposed;
                                                    });
                                                }
                                                <span style="color:#0000ff;">else</span> {
                                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                }
                                                <span style="color:#0000ff;">return</span> result;
                                            };

                                            $scope.removeProposePurchaseItem = function (index) {
                                                <span style="color:#0000ff;">if</span> ($scope.newPurchaseOrders.length &gt;= 1) {
                                                    <span style="color:#0000ff;">var</span> previousButton = $(<span style="color:#a31515;">'.custom-proposePurchase &gt; li.active'</span>).prev();
                                                    <span style="color:#0000ff;">if</span> (previousButton) {
                                                        $timeout(function () {
                                                            angular.element(previousButton.find(<span style="color:#a31515;">'a[data-toggle="tab"]'</span>)).trigger(<span style="color:#a31515;">'click'</span>);
                                                        })
                                                    }
                                                }

                                                $scope.newPurchaseOrders.splice(index, 1);
                                            }

                                            <span style="color:#008000;">//Moved from $scope.savePurchases function</span>
                                            <span style="color:#0000ff;">var</span> message = <span style="color:#a31515;">""</span>;
                                            <span style="color:#0000ff;">var</span> illegalPOs = function () {
                                                <span style="color:#0000ff;">return</span> _.filter($scope.newPurchaseOrders, function (purchase) {
                                                    <span style="color:#0000ff;">if</span> (purchase.purchaseOrderDetailsList.length &lt;= 0) {

                                                        <span style="color:#0000ff;">if</span> (purchase.supplier) {
                                                            message += <span style="color:#a31515;">" "</span> + purchase.supplier.companyName + <span style="color:#a31515;">","</span>
                                                        }
                                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                                    }
                                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                });
                                            }

                                            <span style="color:#008000;">//set callback for propose purchase step</span>
                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                proposeCallback = function () {
                                                    <span style="color:#0000ff;">var</span> result = <span style="color:#0000ff;">true</span>;
                                                    angular.forEach($scope.newPurchaseOrders, function (purchase, x) {
                                                        angular.forEach(purchase.purchaseOrderDetailsList, function (detail, y) {
                                                            <span style="color:#0000ff;">if</span> (!detail.unitPrice) {
                                                                alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.PLEASE_INPUT_DATA_FOR_SALES_DETAILS'</span>));
                                                                result = <span style="color:#0000ff;">false</span>;
                                                                <span style="color:#0000ff;">return</span>;
                                                            }
                                                        });
                                                    });

                                                    <span style="color:#0000ff;">if</span> (illegalPOs() && illegalPOs().length) {
                                                        message = message.substring(0, message.length - 1);
                                                        alert($translate.instant(<span style="color:#a31515;">'ALERT.PUR.PURCHASE_SUPPLIER_DOES_CONTAIN_ITEM'</span>, { name: message }));
                                                        <span style="color:#008000;">//alert("Purchases Orders of Supplier:" + message + " does not contain any Item. Cannot create purchase order.");</span>
                                                        <span style="color:#0000ff;">return</span>;
                                                    }

                                                    <span style="color:#0000ff;">return</span> result;
                                                }

                                                proposeNextCallback = function () {
                                                    $scope.cancel();
                                                    $rootScope.$itpService.removeIntroJsObject();
                                                    $rootScope.$itpService.hideAllModal();

                                                    $timeout(function () {
                                                        <span style="color:#0000ff;">var</span> nextStepId;
                                                        <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                        <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                            <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                nextStepId = <span style="color:#a31515;">'2_2_1_101'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                            <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                                                                nextStepId = <span style="color:#a31515;">'10_1_4_2'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                            <span style="color:#0000ff;">default</span>:
                                                                nextStepId = <span style="color:#a31515;">'2_2_1_12'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                        }

                                                        $rootScope.$itpService.startFromStep(nextStepId, $scope.callbackArr);
                                                    }, 800);
                                                }
                                            }

                                            $scope.savePurchases = function () {
                                                <span style="color:#008000;">//filter Purchases which contain Purchase Details List without any item</span>
                                                message = <span style="color:#a31515;">""</span>;
                                                <span style="color:#0000ff;">var</span> validatePOs = illegalPOs();

                                                <span style="color:#0000ff;">if</span> (validatePOs && validatePOs.length) {
                                                    message = message.substring(0, message.length - 1);
                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.PUR.PURCHASE_SUPPLIER_DOES_CONTAIN_ITEM'</span>, { name: message }));
                                                    <span style="color:#008000;">//alert("Purchases Orders of Supplier:" + message + " does not contain any Item.\n Cannot create purchase order.");</span>
                                                    <span style="color:#0000ff;">return</span>;
                                                }

                                                <span style="color:#0000ff;">var</span> isDataValid = <span style="color:#0000ff;">true</span>;
                                                angular.forEach($scope.newPurchaseOrders, function (po) {
                                                    isDataValid = isDataValid && po.supplierId;
                                                    angular.forEach(po.purchaseOrderDetailsList, function (pod) {
                                                        isDataValid = isDataValid && pod.qty && pod.unitPrice;
                                                    });
                                                });
                                                <span style="color:#0000ff;">if</span> (!isDataValid) {
                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.FORM_ERROR'</span>));
                                                    <span style="color:#0000ff;">return</span>;
                                                }

                                                $scope.busy = <span style="color:#0000ff;">true</span>;
                                                <span style="color:#0000ff;">var</span> _countRequestToWait = $scope.newPurchaseOrders.length;
                                                <span style="color:#0000ff;">var</span> _countSuccess = 0;

                                                angular.forEach($scope.newPurchaseOrders, function (_purchase, k) {
                                                    <span style="color:#008000;">/* Copy mapping (reserved) qty based on updated proposed PO qty.
                                                    Note: we don't need to check againts sod because the default proposed qty = sod qty. */</span>
                                                    angular.forEach(_purchase.purchaseOrderDetailsList, function (_pod, i) {
                                                        <span style="color:#0000ff;">if</span> (_pod.productUOMId == <span style="color:#a31515;">'base'</span>) {
                                                            _pod.productUOMId = <span style="color:#0000ff;">null</span>;
                                                        }
                                                    });
                                                    _purchase.saving = <span style="color:#0000ff;">true</span>;
                                                    _purchase.tax = _purchase.tax / 100;
                                                });
                                                purchaseService.saveAll($scope.newPurchaseOrders, type, (isPackAll ? salesId : <span style="color:#0000ff;">null</span>), isPackAll)
                                                    .success(function (data) {
                                                        $scope.busy = <span style="color:#0000ff;">false</span>;
                                                        $rootScope.doneDashboardCheckListItem(Dashboard.Enum.DashboardCheckListCode.FinishedPurchaseOrder);
                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {

                                                            <span style="color:#0000ff;">if</span> (data & data.length) {
                                                                angular.forEach($scope.newPurchaseOrders, function (po, poIndex) {
                                                                    po.saving = <span style="color:#0000ff;">false</span>;
                                                                    po.error = <span style="color:#0000ff;">false</span>;
                                                                    po.proposed = <span style="color:#0000ff;">true</span>;
                                                                    angular.forEach(data, function (returnedPO, returnedPOindex) {
                                                                        <span style="color:#0000ff;">if</span> (po.supplierId != returnedPO.supplierId) <span style="color:#0000ff;">return</span>;
                                                                        po.newPurchaseOrder = returnedPO;
                                                                    });
                                                                });
                                                            }
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.isLoadingITPData = <span style="color:#0000ff;">true</span>;
                                                                $scope.cancel();
                                                                $scope.$itpService.removeIntroJsObject();
                                                                $rootScope.$itpService.hideAllModal();
                                                                $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);

                                                                $timeout(function () {
                                                                    <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L1'</span>:
                                                                            <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"PurchaseOrder"</span>];;
                                                                            <span style="color:#0000ff;">var</span> documentIds = (_.map(data, function (po) { <span style="color:#0000ff;">return</span> po.purchaseOrderId; })).join(<span style="color:#a31515;">','</span>);

                                                                            $rootScope.$itpService.setDoneLessonITPQuickFlow(documentType, documentIds);
                                                                            $rootScope.finishITPLesson(lessonCode);
                                                                            $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;

                                                                            <span style="color:#008000;">//run after system went to purchase order page</span>
                                                                            $timeout(function () {
                                                                                $rootScope.$itpService.startFromStep(<span style="color:#a31515;">'2_2_1_15'</span>, $scope.callbackArr);
                                                                            }, 500);

                                                                            window.location = <span style="color:#a31515;">"index.html#/purchases?lesson-code=OPR_PUR_ORD_L1"</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                            emergeNotification.success($translate.instant(<span style="color:#a31515;">'LABEL.ITP.ADVANCED_OPERATIONS.SOTOPO.MESSAGE'</span>));

                                                                            <span style="color:#008000;">//we do not use this function anymore, this function uses to update finish lesson in quick ITP flow only</span>
                                                                            <span style="color:#008000;">//$rootScope.finishITPLesson(lessonCode);</span>

                                                                            <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"PurchaseOrder"</span>];
                                                                            <span style="color:#0000ff;">var</span> documentIds = _.map(data, function (po) { <span style="color:#0000ff;">return</span> po.purchaseOrderId; })
                                                                            documentIds = documentIds ? documentIds.join(<span style="color:#a31515;">','</span>) : <span style="color:#a31515;">''</span>;

                                                                            $rootScope.finishITPLessonAndShowBadge(lessonCode, documentType, documentIds);
                                                                            $rootScope.$itpService.stopIntroJs();
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                                                                            $window.location.hash = <span style="color:#a31515;">'#/sales/'</span> + $routeParams.id.toString() + <span style="color:#a31515;">'?lesson-code=AO_ATSO_L4&step-code=10_1_4_5&relearn-lesson=true'</span>;
                                                                            $window.location.replace($window.location.href);
                                                                            <span style="color:#0000ff;">break</span>;
                                                                    }

                                                                }, 800);

                                                            } <span style="color:#0000ff;">else</span> {

                                                                <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"Propose"</span> && $scope.newPurchaseOrders.length) {
                                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.PROPOSE_PURCHASE_SUCCESS'</span>));
                                                                    $scope.cancel();
                                                                    $location.url(<span style="color:#a31515;">'/sales/'</span> + salesId + <span style="color:#a31515;">'?loadDeliveryTabFirst=true'</span>);
                                                                    $route.reload();
                                                                } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (type != <span style="color:#a31515;">"Propose"</span> && $scope.newPurchaseOrders.length) {
                                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.CONVERT_PURCHASE_SUCCESS'</span>));
                                                                    $scope.cancel();
                                                                    $route.reload();
                                                                }

                                                                <span style="color:#0000ff;">if</span> (data == <span style="color:#0000ff;">true</span>) {

                                                                }
                                                            }
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.busy = <span style="color:#0000ff;">false</span>;
                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            errorDisplay.show(error);
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>();
                                            };

                                            $scope.getLineTotal = function (value) {
                                                <span style="color:#0000ff;">var</span> _totalLine = 0;
                                                <span style="color:#0000ff;">var</span> _totalDiscount = 0;

                                                <span style="color:#0000ff;">if</span> (value.unitPrice && value.qty) {
                                                    _totalLine = (value.unitPrice * value.qty);
                                                    <span style="color:#008000;">//console.log(value.product);</span>
                                                    <span style="color:#0000ff;">if</span> (value.product) {
                                                        _totalLine = _totalLine;
                                                    }

                                                    <span style="color:#0000ff;">if</span> (value.discountTypeId) {
                                                        _discountType = value.discountTypeId;

                                                        <span style="color:#0000ff;">if</span> (_discountType == 1) {
                                                            <span style="color:#008000;">// Percentage</span>
                                                            _totalDiscount = (_totalLine * (value.discountAmount)) / 100;
                                                        } <span style="color:#0000ff;">else</span> {
                                                            <span style="color:#008000;">// Fixed</span>
                                                            _totalDiscount = value.discountAmount;
                                                        }
                                                    }

                                                    <span style="color:#0000ff;">return</span> _totalLine - +(Math.round(_totalDiscount + <span style="color:#a31515;">"e+2"</span>) + <span style="color:#a31515;">"e-2"</span>);
                                                }
                                            };

                                            $scope.onChangedUOM = function (productUOMId, uomList, item) {
                                                item.productUOMId = productUOMId;

                                                <span style="color:#0000ff;">if</span> (item.productUOMId === <span style="color:#a31515;">'base'</span>) {
                                                    item.productUOMName = item.product.uom;
                                                    item.productUOMValue = item.product.qtyPerUnit;
                                                    item.unitPrice = item.product.priceSelling;
                                                } <span style="color:#0000ff;">else</span> {
                                                    <span style="color:#0000ff;">var</span> selectedUOM = _.find(uomList, function (uom) {
                                                        <span style="color:#0000ff;">return</span> uom.productUOMId == item.productUOMId;
                                                    });
                                                    <span style="color:#0000ff;">if</span> (selectedUOM) {
                                                        item.productUOMId = selectedUOM.productUOMId;
                                                        item.productUOMName = selectedUOM.name;
                                                        item.productUOMValue = selectedUOM.value || 1;
                                                        item.unitPrice = !selectedUOM.isDeleted ? selectedUOM.priceSelling : selectedUOM.unitPrice;
                                                    }
                                                }
                                            };

                                            $scope.getUOM = function (item) {
                                                <span style="color:#0000ff;">if</span> (!item.productId || !item.product) <span style="color:#0000ff;">return</span>;

                                                <span style="color:#0000ff;">if</span> (!item.productUOMId) <span style="color:#0000ff;">return</span>; <span style="color:#008000;">// It is using base UOM, don't need to proceed further.</span>

                                                <span style="color:#0000ff;">var</span> returnValue = <span style="color:#0000ff;">null</span>;

                                                angular.forEach(item.product.productUOMList, function (key, value) {
                                                    <span style="color:#0000ff;">if</span> (key.productUOMId == item.productUOMId) {
                                                        returnValue = key;
                                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                    }
                                                    ;
                                                });

                                                <span style="color:#0000ff;">return</span> returnValue;
                                            };

                                            $scope.removeItem = function (index, purchase) {
                                                purchase.purchaseOrderDetailsList.splice(index, 1);
                                            };

                                            $scope.onChangedTaxCode = function (item, taxId) {
                                                taxCodeService.updateTaxCodeAndRateOnChanged(item, taxId);
                                            }

                                            $scope.$watch(<span style="color:#a31515;">'newPurchaseOrders'</span>, function (oldVal, newVal) {
                                                $timeout(function () {
                                                    angular.forEach(oldVal, function (purchase, k) {
                                                        <span style="color:#0000ff;">var</span> totalQuantity;
                                                        <span style="color:#0000ff;">var</span> totalPrice = 0;
                                                        <span style="color:#0000ff;">var</span> totalDiscount = 0;
                                                        <span style="color:#0000ff;">var</span> totalAdditional = 0;
                                                        <span style="color:#0000ff;">var</span> totalTax = 0;
                                                        <span style="color:#0000ff;">var</span> totalGrand = 0;

                                                        <span style="color:#008000;">// Total Quantities of all items</span>
                                                        totalQuantity = _.reduce(purchase.purchaseOrderDetailsList, function (memo, num) {
                                                            <span style="color:#0000ff;">var</span> _qty = 0;
                                                            <span style="color:#0000ff;">if</span> (num) {
                                                                _qty = num.qty;
                                                            }

                                                            <span style="color:#0000ff;">return</span> Number(memo) + _qty * 1;
                                                        }, 0);

                                                        <span style="color:#008000;">// Total Price of all items</span>
                                                        angular.forEach(purchase.purchaseOrderDetailsList, function (item) {
                                                            <span style="color:#0000ff;">var</span> _total = 0;
                                                            <span style="color:#0000ff;">var</span> _totalLine = 0;
                                                            <span style="color:#0000ff;">var</span> _totalLineTax = 0;
                                                            <span style="color:#0000ff;">var</span> _totalDiscount = 0;
                                                            <span style="color:#0000ff;">var</span> _totalAdditional = 0;
                                                            <span style="color:#0000ff;">var</span> _discountType = <span style="color:#0000ff;">null</span>;
                                                            item.lineTotal = 0;

                                                            <span style="color:#0000ff;">if</span> (item.unitPrice && item.qty) {
                                                                _totalLine = (item.unitPrice * item.qty);

                                                                <span style="color:#008000;">// calculate discounts</span>
                                                                <span style="color:#0000ff;">if</span> (item.discountTypeId) {
                                                                    _discountType = item.discountTypeId;

                                                                    <span style="color:#0000ff;">if</span> (_discountType == 1) {
                                                                        <span style="color:#008000;">// Percentage</span>
                                                                        _totalDiscount = _totalLine * (item.discountAmount || 0) / 100;
                                                                    } <span style="color:#0000ff;">else</span> {
                                                                        <span style="color:#008000;">// Fixed</span>
                                                                        _totalDiscount = item.discountAmount || 0;
                                                                    }

                                                                    totalDiscount += _totalDiscount;
                                                                }

                                                                _total = _totalLine - +(Math.round(_totalDiscount + <span style="color:#a31515;">"e+2"</span>) + <span style="color:#a31515;">"e-2"</span>); <span style="color:#008000;">// round discount to 2 decimal places</span>

                                                                <span style="color:#0000ff;">if</span> (item.taxRate &gt; 0) {
                                                                    <span style="color:#0000ff;">if</span> (purchase.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                                                                        _totalLineTax = ((item.taxRate / 100) * _total) / (1 + (item.taxRate / 100));
                                                                    } <span style="color:#0000ff;">else</span> {
                                                                        _totalLineTax = _total * ((item.taxRate / 100));
                                                                    }
                                                                    totalTax += _totalLineTax;
                                                                }

                                                                <span style="color:#0000ff;">if</span> (!item.productId) {
                                                                    _totalAdditional += _totalLine;
                                                                    totalAdditional += _totalAdditional;
                                                                }

                                                                item.lineTotal = _total;<span style="color:#008000;">// - _totalDiscount;</span>
                                                            }

                                                            totalPrice += item.productId ? item.lineTotal : 0;
                                                        });

                                                        totalGrand = totalPrice + totalTax; <span style="color:#008000;">// - totalDiscount</span>
                                                        <span style="color:#0000ff;">if</span> (purchase.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                                                            totalGrand -= totalTax;
                                                        }

                                                        purchase.totalPrice = totalPrice;
                                                        purchase.totalQuantity = totalQuantity || 0;
                                                        purchase.totalAdditional = totalAdditional;

                                                        purchase.totalTax = totalTax;
                                                        purchase.totalGrand = totalGrand + totalAdditional;
                                                        purchase.totalDiscount = totalDiscount;
                                                    })

                                                }, 1000);

                                            }, <span style="color:#0000ff;">true</span>);

                                            $scope.ok = function () {
                                                $modalInstance.close();
                                            };

                                            $scope.cancel = function () {
                                                $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);
                                            };
                                        }]
                                });
                            } <span style="color:#0000ff;">else</span> {
                                alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.NO_DROPSHIP_DETAILS_TO_PROPOSE'</span>));
                                <span style="color:#008000;">//purchaseService.saveAll([], type, (isPackAll ? salesId : null), isPackAll)</span>
                                <span style="color:#008000;">//.success(function (data) {</span>
                                <span style="color:#008000;">//    $location.url('/sales/' + salesId + '?loadDeliveryTabFirst=true');</span>
                                <span style="color:#008000;">//    $route.reload();</span>
                                <span style="color:#008000;">//})</span>
                                <span style="color:#008000;">//.error(function (error) {</span>
                                <span style="color:#008000;">//    if (error.message) {</span>
                                <span style="color:#008000;">//        alert($translate.instant(error.message));</span>
                                <span style="color:#008000;">//    }</span>
                                <span style="color:#008000;">//});</span>
                            }
                        })
                        .error(function (error) {
                            <span style="color:#0000ff;">if</span> (error.message) {
                                alert($translate.instant(error.message));
                            }
                        });
            }
            <span style="color:#0000ff;">else</span> {
                salesService.CheckIfSalesIsConvertedToPurchase(newSales.salesOrderId)
                .success(function (data) {
                    <span style="color:#0000ff;">if</span> (data) {
                        alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SALES_IS_ALREADY_CONVERTED_TO_PURCHASE'</span>));
                    }
                    <span style="color:#0000ff;">else</span> {
                        salesService.CheckIfSalesHasDropship(newSales.salesOrderId)
                        .success(function (data) {
                            <span style="color:#0000ff;">if</span> (data) {
                                <span style="color:#0000ff;">var</span> dialog = $modal.open({
                                    backdrop: isBackdrop,
                                    keyboard: isKeyboard,
                                    size: <span style="color:#a31515;">'lg'</span>,
                                    templateUrl: <span style="color:#a31515;">'ORD/Sales/SalesEdit/proposePurchase.modal.html?a=aa'</span>,
                                    controller: [<span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$log'</span>, <span style="color:#a31515;">'$modalInstance'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'purchaseService'</span>,
                                        function ($scope, $log, $modalInstance, $filter, productService, purchaseService) {
                                            $scope.sales = newSales;
                                            $scope.newPurchaseOrders = [];
                                            $scope.loading = <span style="color:#0000ff;">true</span>;
                                            $scope.isBackToBack = <span style="color:#0000ff;">false</span>;
                                            $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                            $scope.selected = {};
                                            $scope.selected.supplier = {};

                                            <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"Propose"</span>) {
                                                salesService.proposePurchase(newSales.salesOrderId)
                                                    .success(function (data) {
                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                                            $scope.loading = <span style="color:#0000ff;">true</span>;

                                                            <span style="color:#0000ff;">if</span> (isPackAll) {
                                                                $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                            }

                                                            angular.forEach(data, function (v, k) {
                                                                v.error = <span style="color:#0000ff;">false</span>;
                                                                v.proposed = <span style="color:#0000ff;">false</span>;
                                                            });
                                                            $scope.newPurchaseOrders = data;
                                                            $scope.isBackToBack = <span style="color:#0000ff;">true</span>;<span style="color:#008000;">// using to detect where conversing B2B or normal PO</span>
                                                            angular.forEach($scope.newPurchaseOrders, function (_po, k) {
                                                                <span style="color:#0000ff;">if</span> (_po.supplier && _po.supplier.currency) {
                                                                    _po.currentCurrencyCode = _po.supplier.currency.symbol;
                                                                }

                                                                <span style="color:#008000;">/* Keep mapping (reserved) qty for later use. */</span>
                                                                angular.forEach(_po.purchaseOrderDetailsList, function (_pod, i) {
                                                                    <span style="color:#0000ff;">if</span> (!_pod.salesPurchaseMappingList || !_pod.salesPurchaseMappingList.length) {
                                                                        <span style="color:#0000ff;">return</span>;
                                                                    }
                                                                    _pod.defaultConvertedProposedQtyFromSOD = (_pod.salesPurchaseMappingList[0].qty ? _pod.salesPurchaseMappingList[0].qty : 0) *
                                                                        (_pod.productUOMValue ? _pod.productUOMValue : 1);
                                                                });
                                                            });

                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $timeout(function () {
                                                                    $rootScope.$itpService.startFromStep(<span style="color:#a31515;">'10_1_4_3'</span>, $scope.callbackArr);

                                                                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                                    $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;
                                                                }, 800);
                                                            }

                                                            $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                        $scope.loading = <span style="color:#0000ff;">false</span>;

                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.$itpService.stopIntroJs();
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                    window.location = <span style="color:#a31515;">"index.html#/products"</span>;
                                                                }
                                                            } <span style="color:#0000ff;">else</span> {
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                }
                                                                <span style="color:#0000ff;">else</span> {
                                                                    alert($translate.instant(error.message));
                                                                }
                                                            }
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>(function () {

                                                    });
                                            } <span style="color:#0000ff;">else</span> {
                                                salesService.convertToPurchase(newSales.salesOrderId)
                                                    .success(function (data) {

                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                                            $scope.loading = <span style="color:#0000ff;">true</span>;
                                                            $scope.newPurchaseOrders = data;

                                                            angular.forEach($scope.newPurchaseOrders, function (v, k) {
                                                                v.error = <span style="color:#0000ff;">false</span>;
                                                                v.proposed = <span style="color:#0000ff;">false</span>;

                                                                angular.forEach(v.purchaseOrderDetailsList, function (_pod, i) {
                                                                    <span style="color:#0000ff;">if</span> (!_pod.salesPurchaseMappingList || !_pod.salesPurchaseMappingList.length) {
                                                                        <span style="color:#0000ff;">return</span>;
                                                                    }
                                                                    _pod.defaultConvertedProposedQtyFromSOD =
                                                                        (_pod.salesPurchaseMappingList[0].qty ? _pod.salesPurchaseMappingList[0].qty : 0) *
                                                                        (_pod.productUOMValue ? _pod.productUOMValue : 1);
                                                                });
                                                            });

                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $timeout(function () {
                                                                    <span style="color:#0000ff;">var</span> nextStepId;
                                                                    <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                            nextStepId = <span style="color:#a31515;">'2_2_1_102'</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">default</span>:
                                                                            <span style="color:#008000;">//lesson-code = OPR_ORD_SO_L1</span>
                                                                            nextStepId = <span style="color:#a31515;">'2_2_1_13'</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                    }

                                                                    $rootScope.$itpService.startFromStep(nextStepId, $scope.callbackArr);

                                                                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                                    $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;
                                                                }, 800);
                                                            }

                                                            $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.loading = <span style="color:#0000ff;">false</span>;
                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.$itpService.stopIntroJs();
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                    window.location = <span style="color:#a31515;">"index.html#/products"</span>;
                                                                }
                                                            } <span style="color:#0000ff;">else</span> {
                                                                
                                                                <span style="color:#0000ff;">if</span> (error && error.message.indexOf(<span style="color:#a31515;">'NO_SUPPLIER_FOR_PRODUCT'</span>) &gt;= 0) {

                                                                    <span style="color:#0000ff;">var</span> errorMessageSplitted = error.message.split(<span style="color:#a31515;">":"</span>);
                                                                    <span style="color:#0000ff;">var</span> errorMessage = $translate.instant(errorMessageSplitted[0], { name: errorMessageSplitted[1] });

                                                                    alert(errorMessage);
                                                                }
                                                            }
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>(function () {
                                                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                                    });
                                            }

                                            $scope.type = type;

                                            $scope.onChangedProduct = function (index, item, purchase) {
                                                <span style="color:#0000ff;">var</span> detail = purchase.purchaseOrderDetailsList[index];

                                                detail.product = {};
                                                <span style="color:#008000;">// Get the purchaseOrderDetailsId so able to update the line item</span>
                                                detail.purchaseOrderDetailsId = purchase.purchaseOrderDetailsId;

                                                <span style="color:#0000ff;">if</span> (item.isVariantOfProductId) {
                                                    detail.itemName = $rootScope.getProductVariantName(item.parentProduct, item);
                                                } <span style="color:#0000ff;">else</span> {
                                                    detail.itemName = item.name;
                                                }

                                                <span style="color:#008000;">//set default tax code if it exists</span>
                                                detail.taxCodeId = item.defaultTaxId;

                                                detail.unitPrice = item.priceCost;
                                                detail.description = item.description;
                                                detail.product = item;
                                                <span style="color:#008000;">//detail.product.productUOMList = item.productUOMList;</span>
                                            };

                                            $scope.allPOProposed = function () {
                                                <span style="color:#0000ff;">var</span> result = <span style="color:#0000ff;">true</span>;
                                                <span style="color:#0000ff;">if</span> ($scope.newPurchaseOrders && $scope.newPurchaseOrders.length) {
                                                    angular.forEach($scope.newPurchaseOrders, function (po, poIndex) {
                                                        result = result && po.proposed;
                                                    });
                                                }
                                                <span style="color:#0000ff;">else</span> {
                                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                }
                                                <span style="color:#0000ff;">return</span> result;
                                            };

                                            $scope.removeProposePurchaseItem = function (index) {
                                                <span style="color:#0000ff;">if</span> ($scope.newPurchaseOrders.length &gt;= 1) {
                                                    <span style="color:#0000ff;">var</span> previousButton = $(<span style="color:#a31515;">'.custom-proposePurchase &gt; li.active'</span>).prev();
                                                    <span style="color:#0000ff;">if</span> (previousButton) {
                                                        $timeout(function () {
                                                            angular.element(previousButton.find(<span style="color:#a31515;">'a[data-toggle="tab"]'</span>)).trigger(<span style="color:#a31515;">'click'</span>);
                                                        })
                                                    }
                                                }

                                                $scope.newPurchaseOrders.splice(index, 1);
                                            }

                                            <span style="color:#0000ff;">var</span> message = <span style="color:#a31515;">""</span>;
                                            <span style="color:#0000ff;">var</span> illegalPOs = function () {
                                                <span style="color:#0000ff;">return</span> _.filter($scope.newPurchaseOrders, function (purchase) {
                                                    <span style="color:#0000ff;">if</span> (purchase.purchaseOrderDetailsList.length &lt;= 0) {

                                                        <span style="color:#0000ff;">if</span> (purchase.supplier) {
                                                            message += <span style="color:#a31515;">" "</span> + purchase.supplier.companyName + <span style="color:#a31515;">","</span>
                                                        }
                                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                                    }
                                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                });
                                            }

                                            <span style="color:#008000;">//set callback for propose purchase step</span>
                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                proposeCallback = function () {
                                                    <span style="color:#0000ff;">var</span> result = <span style="color:#0000ff;">true</span>;
                                                    angular.forEach($scope.newPurchaseOrders, function (purchase, x) {
                                                        angular.forEach(purchase.purchaseOrderDetailsList, function (detail, y) {
                                                            <span style="color:#0000ff;">if</span> (!detail.unitPrice) {
                                                                alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.PLEASE_INPUT_DATA_FOR_SALES_DETAILS'</span>));
                                                                result = <span style="color:#0000ff;">false</span>;
                                                                <span style="color:#0000ff;">return</span>;
                                                            }
                                                        });
                                                    });

                                                    <span style="color:#0000ff;">if</span> (illegalPOs() && illegalPOs().length) {
                                                        message = message.substring(0, message.length - 1);
                                                        alert($translate.instant(<span style="color:#a31515;">'ALERT.PUR.PURCHASE_SUPPLIER_DOES_CONTAIN_ITEM'</span>, { name: message }));
                                            
                                                        <span style="color:#0000ff;">return</span>;
                                                    }

                                                    <span style="color:#0000ff;">return</span> result;
                                                }

                                                proposeNextCallback = function () {
                                                    $scope.cancel();
                                                    $rootScope.$itpService.removeIntroJsObject();
                                                    $rootScope.$itpService.hideAllModal();

                                                    $timeout(function () {
                                                        <span style="color:#0000ff;">var</span> nextStepId;
                                                        <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                        <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                            <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                nextStepId = <span style="color:#a31515;">'2_2_1_101'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                            <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                                                                nextStepId = <span style="color:#a31515;">'10_1_4_2'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                            <span style="color:#0000ff;">default</span>:
                                                                nextStepId = <span style="color:#a31515;">'2_2_1_12'</span>;
                                                                <span style="color:#0000ff;">break</span>;
                                                        }

                                                        $rootScope.$itpService.startFromStep(nextStepId, $scope.callbackArr);
                                                    }, 800);
                                                }
                                            }

                                            $scope.savePurchases = function () {
                                                <span style="color:#008000;">//filter Purchases which contain Purchase Details List without any item</span>
                                                message = <span style="color:#a31515;">""</span>;
                                                <span style="color:#0000ff;">var</span> validatePOs = illegalPOs();

                                                <span style="color:#0000ff;">if</span> (validatePOs && validatePOs.length) {
                                                    message = message.substring(0, message.length - 1);
                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.PUR.PURCHASE_SUPPLIER_DOES_CONTAIN_ITEM'</span>, { name: message }));
                                            
                                                    <span style="color:#0000ff;">return</span>;
                                                }

                                                <span style="color:#0000ff;">var</span> isDataValid = <span style="color:#0000ff;">true</span>;
                                                angular.forEach($scope.newPurchaseOrders, function (po) {
                                                    isDataValid = isDataValid && po.supplierId;
                                                    angular.forEach(po.purchaseOrderDetailsList, function (pod) {
                                                        isDataValid = isDataValid && pod.qty && pod.unitPrice;
                                                    });
                                                });
                                                <span style="color:#0000ff;">if</span> (!isDataValid) {
                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.FORM_ERROR'</span>));
                                                    <span style="color:#0000ff;">return</span>;
                                                }

                                                $scope.busy = <span style="color:#0000ff;">true</span>;
                                                <span style="color:#0000ff;">var</span> _countRequestToWait = $scope.newPurchaseOrders.length;
                                                <span style="color:#0000ff;">var</span> _countSuccess = 0;

                                                angular.forEach($scope.newPurchaseOrders, function (_purchase, k) {
                                            
                                                    angular.forEach(_purchase.purchaseOrderDetailsList, function (_pod, i) {
                                                        <span style="color:#0000ff;">if</span> (_pod.productUOMId == <span style="color:#a31515;">'base'</span>) {
                                                            _pod.productUOMId = <span style="color:#0000ff;">null</span>;
                                                        }
                                                    });
                                                    _purchase.saving = <span style="color:#0000ff;">true</span>;
                                                    _purchase.tax = _purchase.tax / 100;
                                                });
                                                purchaseService.saveAll($scope.newPurchaseOrders, type, (isPackAll ? salesId : <span style="color:#0000ff;">null</span>), isPackAll)
                                                    .success(function (data) {
                                                        $scope.busy = <span style="color:#0000ff;">false</span>;
                                                        $rootScope.doneDashboardCheckListItem(Dashboard.Enum.DashboardCheckListCode.FinishedPurchaseOrder);
                                                        <span style="color:#0000ff;">var</span> callbackFunc = function () {

                                                            <span style="color:#0000ff;">if</span> (data & data.length) {
                                                                angular.forEach($scope.newPurchaseOrders, function (po, poIndex) {
                                                                    po.saving = <span style="color:#0000ff;">false</span>;
                                                                    po.error = <span style="color:#0000ff;">false</span>;
                                                                    po.proposed = <span style="color:#0000ff;">true</span>;
                                                                    angular.forEach(data, function (returnedPO, returnedPOindex) {
                                                                        <span style="color:#0000ff;">if</span> (po.supplierId != returnedPO.supplierId) <span style="color:#0000ff;">return</span>;
                                                                        po.newPurchaseOrder = returnedPO;
                                                                    });
                                                                });
                                                            }
                                                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                                                $rootScope.isLoadingITPData = <span style="color:#0000ff;">true</span>;
                                                                $scope.cancel();
                                                                $scope.$itpService.removeIntroJsObject();
                                                                $rootScope.$itpService.hideAllModal();
                                                                $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);

                                                                $timeout(function () {
                                                                    <span style="color:#0000ff;">var</span> lessonCode = $rootScope.$itpService.getLessonCode();
                                                                    <span style="color:#0000ff;">switch</span> (lessonCode) {
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L1'</span>:
                                                                            <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"PurchaseOrder"</span>];;
                                                                            <span style="color:#0000ff;">var</span> documentIds = (_.map(data, function (po) { <span style="color:#0000ff;">return</span> po.purchaseOrderId; })).join(<span style="color:#a31515;">','</span>);

                                                                            $rootScope.$itpService.setDoneLessonITPQuickFlow(documentType, documentIds);
                                                                            $rootScope.finishITPLesson(lessonCode);
                                                                            $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;

                                                                            <span style="color:#008000;">//run after system went to purchase order page</span>
                                                                            $timeout(function () {
                                                                                $rootScope.$itpService.startFromStep(<span style="color:#a31515;">'2_2_1_15'</span>, $scope.callbackArr);
                                                                            }, 500);

                                                                            window.location = <span style="color:#a31515;">"index.html#/purchases?lesson-code=OPR_PUR_ORD_L1"</span>;
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                                                                            emergeNotification.success($translate.instant(<span style="color:#a31515;">'LABEL.ITP.ADVANCED_OPERATIONS.SOTOPO.MESSAGE'</span>));


                                                                            <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"PurchaseOrder"</span>];
                                                                            <span style="color:#0000ff;">var</span> documentIds = _.map(data, function (po) { <span style="color:#0000ff;">return</span> po.purchaseOrderId; })
                                                                            documentIds = documentIds ? documentIds.join(<span style="color:#a31515;">','</span>) : <span style="color:#a31515;">''</span>;

                                                                            $rootScope.finishITPLessonAndShowBadge(lessonCode, documentType, documentIds);
                                                                            $rootScope.$itpService.stopIntroJs();
                                                                            <span style="color:#0000ff;">break</span>;
                                                                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                                                                            $window.location.hash = <span style="color:#a31515;">'#/sales/'</span> + $routeParams.id.toString() + <span style="color:#a31515;">'?lesson-code=AO_ATSO_L4&step-code=10_1_4_5&relearn-lesson=true'</span>;
                                                                            $window.location.replace($window.location.href);
                                                                            <span style="color:#0000ff;">break</span>;
                                                                    }

                                                                }, 800);

                                                            } <span style="color:#0000ff;">else</span> {

                                                                <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"Propose"</span> && $scope.newPurchaseOrders.length) {
                                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.PROPOSE_PURCHASE_SUCCESS'</span>));
                                                                    $scope.cancel();
                                                                    $location.url(<span style="color:#a31515;">'/sales/'</span> + salesId + <span style="color:#a31515;">'?loadDeliveryTabFirst=true'</span>);
                                                                    $route.reload();
                                                                } <span style="color:#0000ff;">else</span> <span style="color:#0000ff;">if</span> (type != <span style="color:#a31515;">"Propose"</span> && $scope.newPurchaseOrders.length) {
                                                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.CONVERT_PURCHASE_SUCCESS'</span>));
                                                                    $scope.cancel();
                                                                    $route.reload();
                                                                }

                                                                <span style="color:#0000ff;">if</span> (data == <span style="color:#0000ff;">true</span>) {

                                                                }
                                                            }
                                                        }

                                                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                                        } <span style="color:#0000ff;">else</span> {
                                                            callbackFunc();
                                                        }

                                                        $scope.disabledSave = <span style="color:#0000ff;">true</span>;
                                                    })
                                                    .error(function (error) {
                                                        $scope.busy = <span style="color:#0000ff;">false</span>;
                                                        $scope.disabledSave = <span style="color:#0000ff;">false</span>;
                                                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                            $rootScope.openSaaSMessage(error);
                                                        }
                                                        <span style="color:#0000ff;">else</span> {
                                                            errorDisplay.show(error);
                                                        }
                                                    })
                                                    .<span style="color:#0000ff;">finally</span>();
                                            };

                                            $scope.getLineTotal = function (value) {
                                                <span style="color:#0000ff;">var</span> _totalLine = 0;
                                                <span style="color:#0000ff;">var</span> _totalDiscount = 0;

                                                <span style="color:#0000ff;">if</span> (value.unitPrice && value.qty) {
                                                    _totalLine = (value.unitPrice * value.qty);

                                                    <span style="color:#0000ff;">if</span> (value.product) {
                                                        _totalLine = _totalLine;
                                                    }

                                                    <span style="color:#0000ff;">if</span> (value.discountTypeId) {
                                                        _discountType = value.discountTypeId;

                                                        <span style="color:#0000ff;">if</span> (_discountType == 1) {

                                                            _totalDiscount = (_totalLine * (value.discountAmount)) / 100;
                                                        } <span style="color:#0000ff;">else</span> {

                                                            _totalDiscount = value.discountAmount;
                                                        }
                                                    }

                                                    <span style="color:#0000ff;">return</span> _totalLine - +(Math.round(_totalDiscount + <span style="color:#a31515;">"e+2"</span>) + <span style="color:#a31515;">"e-2"</span>);
                                                }
                                            };

                                            $scope.onChangedUOM = function (productUOMId, uomList, item) {
                                                item.productUOMId = productUOMId;

                                                <span style="color:#0000ff;">if</span> (item.productUOMId === <span style="color:#a31515;">'base'</span>) {
                                                    item.productUOMName = item.product.uom;
                                                    item.productUOMValue = item.product.qtyPerUnit;
                                                    item.unitPrice = item.product.priceSelling;
                                                } <span style="color:#0000ff;">else</span> {
                                                    <span style="color:#0000ff;">var</span> selectedUOM = _.find(uomList, function (uom) {
                                                        <span style="color:#0000ff;">return</span> uom.productUOMId == item.productUOMId;
                                                    });
                                                    <span style="color:#0000ff;">if</span> (selectedUOM) {
                                                        item.productUOMId = selectedUOM.productUOMId;
                                                        item.productUOMName = selectedUOM.name;
                                                        item.productUOMValue = selectedUOM.value || 1;
                                                        item.unitPrice = !selectedUOM.isDeleted ? selectedUOM.priceSelling : selectedUOM.unitPrice;
                                                    }
                                                }
                                            };

                                            $scope.getUOM = function (item) {
                                                <span style="color:#0000ff;">if</span> (!item.productId || !item.product) <span style="color:#0000ff;">return</span>;

                                                <span style="color:#0000ff;">if</span> (!item.productUOMId) <span style="color:#0000ff;">return</span>; 

                                                <span style="color:#0000ff;">var</span> returnValue = <span style="color:#0000ff;">null</span>;

                                                angular.forEach(item.product.productUOMList, function (key, value) {
                                                    <span style="color:#0000ff;">if</span> (key.productUOMId == item.productUOMId) {
                                                        returnValue = key;
                                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                                    }
                                                    ;
                                                });

                                                <span style="color:#0000ff;">return</span> returnValue;
                                            };

                                            $scope.removeItem = function (index, purchase) {
                                                purchase.purchaseOrderDetailsList.splice(index, 1);
                                            };

                                            $scope.onChangedTaxCode = function (item, taxId) {
                                                taxCodeService.updateTaxCodeAndRateOnChanged(item, taxId);
                                            }

                                            $scope.$watch(<span style="color:#a31515;">'newPurchaseOrders'</span>, function (oldVal, newVal) {
                                                $timeout(function () {
                                                    angular.forEach(oldVal, function (purchase, k) {
                                                        <span style="color:#0000ff;">var</span> totalQuantity;
                                                        <span style="color:#0000ff;">var</span> totalPrice = 0;
                                                        <span style="color:#0000ff;">var</span> totalDiscount = 0;
                                                        <span style="color:#0000ff;">var</span> totalAdditional = 0;
                                                        <span style="color:#0000ff;">var</span> totalTax = 0;
                                                        <span style="color:#0000ff;">var</span> totalGrand = 0;

                                                        <span style="color:#008000;">// Total Quantities of all items</span>
                                                        totalQuantity = _.reduce(purchase.purchaseOrderDetailsList, function (memo, num) {
                                                            <span style="color:#0000ff;">var</span> _qty = 0;
                                                            <span style="color:#0000ff;">if</span> (num) {
                                                                _qty = num.qty;
                                                            }

                                                            <span style="color:#0000ff;">return</span> Number(memo) + _qty * 1;
                                                        }, 0);

                                                        <span style="color:#008000;">// Total Price of all items</span>
                                                        angular.forEach(purchase.purchaseOrderDetailsList, function (item) {
                                                            <span style="color:#0000ff;">var</span> _total = 0;
                                                            <span style="color:#0000ff;">var</span> _totalLine = 0;
                                                            <span style="color:#0000ff;">var</span> _totalLineTax = 0;
                                                            <span style="color:#0000ff;">var</span> _totalDiscount = 0;
                                                            <span style="color:#0000ff;">var</span> _totalAdditional = 0;
                                                            <span style="color:#0000ff;">var</span> _discountType = <span style="color:#0000ff;">null</span>;
                                                            item.lineTotal = 0;

                                                            <span style="color:#0000ff;">if</span> (item.unitPrice && item.qty) {
                                                                _totalLine = (item.unitPrice * item.qty);

                                                                <span style="color:#008000;">// calculate discounts</span>
                                                                <span style="color:#0000ff;">if</span> (item.discountTypeId) {
                                                                    _discountType = item.discountTypeId;

                                                                    <span style="color:#0000ff;">if</span> (_discountType == 1) {
                                                                        <span style="color:#008000;">// Percentage</span>
                                                                        _totalDiscount = _totalLine * (item.discountAmount || 0) / 100;
                                                                    } <span style="color:#0000ff;">else</span> {
                                                                        <span style="color:#008000;">// Fixed</span>
                                                                        _totalDiscount = item.discountAmount || 0;
                                                                    }

                                                                    totalDiscount += _totalDiscount;
                                                                }

                                                                _total = _totalLine - +(Math.round(_totalDiscount + <span style="color:#a31515;">"e+2"</span>) + <span style="color:#a31515;">"e-2"</span>); 

                                                                <span style="color:#0000ff;">if</span> (item.taxRate &gt; 0) {
                                                                    <span style="color:#0000ff;">if</span> (purchase.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                                                                        _totalLineTax = ((item.taxRate / 100) * _total) / (1 + (item.taxRate / 100));
                                                                    } <span style="color:#0000ff;">else</span> {
                                                                        _totalLineTax = _total * ((item.taxRate / 100));
                                                                    }
                                                                    totalTax += _totalLineTax;
                                                                }

                                                                <span style="color:#0000ff;">if</span> (!item.productId) {
                                                                    _totalAdditional += _totalLine;
                                                                    totalAdditional += _totalAdditional;
                                                                }

                                                                item.lineTotal = _total;
                                                            }

                                                            totalPrice += item.productId ? item.lineTotal : 0;
                                                        });

                                                        totalGrand = totalPrice + totalTax; 
                                                        <span style="color:#0000ff;">if</span> (purchase.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                                                            totalGrand -= totalTax;
                                                        }

                                                        purchase.totalPrice = totalPrice;
                                                        purchase.totalQuantity = totalQuantity || 0;
                                                        purchase.totalAdditional = totalAdditional;

                                                        purchase.totalTax = totalTax;
                                                        purchase.totalGrand = totalGrand + totalAdditional;
                                                        purchase.totalDiscount = totalDiscount;
                                                    })

                                                }, 1000);

                                            }, <span style="color:#0000ff;">true</span>);

                                            $scope.ok = function () {
                                                $modalInstance.close();
                                            };

                                            $scope.cancel = function () {
                                                $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);
                                            };
                                        }]
                                });
                            } <span style="color:#0000ff;">else</span> {
                                purchaseService.saveAll([], type, (isPackAll ? salesId : <span style="color:#0000ff;">null</span>), isPackAll)
                                .success(function (data) {
                                    $location.url(<span style="color:#a31515;">'/sales/'</span> + salesId + <span style="color:#a31515;">'?loadDeliveryTabFirst=true'</span>);
                                    $route.reload();
                                })
                                .error(function (error) {
                                    <span style="color:#0000ff;">if</span> (error.message) {
                                        alert($translate.instant(error.message));
                                    }
                                });
                            }
                        })
                        .error(function (error) {
                            <span style="color:#0000ff;">if</span> (error.message) {
                                alert($translate.instant(error.message));
                            }
                        });
                    }
                })
                .error(function (error) {
                    errorDisplay.show(error);
                })
            }
        }

        $scope.proposePurchase = function (type, isPackAll) {
            <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && !$scope.sales.settings.isApproved) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_NOT_APPROVED'</span>));
                <span style="color:#0000ff;">return</span>;
            }

            <span style="color:#0000ff;">var</span> newSales = {};
            angular.copy($scope.sales, newSales);

            <span style="color:#0000ff;">var</span> _callback = function () {
                <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.PROPOSE_PURCHASE'</span>))) {
                    <span style="color:#0000ff;">var</span> isBackdrop = <span style="color:#0000ff;">true</span>;
                    <span style="color:#0000ff;">var</span> isKeyboard = <span style="color:#0000ff;">true</span>;
                    <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                        $rootScope.$itpService.removeIntroJsObject();
                        $rootScope.$itpService.hideAllModal();

                        isBackdrop = <span style="color:#a31515;">'static'</span>;
                        isKeyboard = <span style="color:#a31515;">'false'</span>;

                        $rootScope.isLoadingITPData = <span style="color:#0000ff;">true</span>;
                    }

                    $scope.openProposePurchase(newSales, isBackdrop, isKeyboard, type, isPackAll);
                };
            };

            _callback();


        };

        $scope.convertToDeliveryOrder = function () {
            <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && !$scope.sales.settings.isApproved) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_NOT_APPROVED'</span>));
                <span style="color:#0000ff;">return</span>;
            }
            <span style="color:#0000ff;">var</span> newSales = {};

            angular.copy($scope.sales, newSales);

            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.ORD.CONVERT_FROM_SALES_TO_DELIVERY'</span>))) {
                $scope.converting = <span style="color:#0000ff;">true</span>;
                salesService.convertToDelivery(salesId)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                <span style="color:#0000ff;">switch</span> ($scope.currentLessonCode) {
                                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                                        emergeNotification.success($translate.instant(<span style="color:#a31515;">'LABEL.ITP.ADVANCED_OPERATIONS.SOTODO.MESSAGE'</span>));
                                        <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"DeliveryOrder"</span>];
                                        <span style="color:#0000ff;">var</span> documentId = data.deliveryOrderId;

                                        $timeout(function () {
                                            $rootScope.finishITPLessonAndShowBadge($scope.currentLessonCode, documentType, documentId);
                                            $rootScope.$itpService.stopIntroJs();
                                        }, 1000);

                                        $location.url(<span style="color:#a31515;">'/deliveries/'</span> + data.deliveryOrderId);
                                        <span style="color:#0000ff;">break</span>;
                                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                                        emergeNotification.success($translate.instant(<span style="color:#a31515;">'LABEL.ITP.ADVANCED_OPERATIONS.SOTODROPSHIP.MESSAGE'</span>));

                                        $timeout(function () {
                                            $rootScope.finishITPLessonAndShowBadge($scope.currentLessonCode);
                                            $rootScope.$itpService.stopIntroJs();
                                        }, 1000);

                                        $location.url(<span style="color:#a31515;">'/deliveries/'</span> + data.deliveryOrderId);
                                        <span style="color:#0000ff;">break</span>;
                                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L2'</span>:
                                        $rootScope.finishITPLesson($scope.currentLessonCode);
                                        <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"DeliveryOrder"</span>];;
                                        <span style="color:#0000ff;">var</span> documentId = data.deliveryOrderId;

                                        $rootScope.$itpService.setDoneLessonITPQuickFlow(documentType, documentId);
                                        $timeout(function () {
                                            $location.url(<span style="color:#a31515;">'/deliveries/'</span> + data.deliveryOrderId + <span style="color:#a31515;">'?lesson-code=OPR_ORD_DO_L2&step-code=2_3_2_1'</span>);
                                        }, 800);
                                        <span style="color:#0000ff;">break</span>;
                                }
                            } <span style="color:#0000ff;">else</span> {
                                $rootScope.doneDashboardCheckListItem(Dashboard.Enum.DashboardCheckListCode.FinishedDeliveryOrder);
                                $scope.myForm.$setPristine();
                                emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.CONVERTED'</span>, { document: <span style="color:#a31515;">'Shipment'</span> }));
                                $location.url(<span style="color:#a31515;">'/sales/'</span> + salesId + <span style="color:#a31515;">'?loadDeliveryTabFirst=true'</span>);
                            }
                        }

                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                        } <span style="color:#0000ff;">else</span> {
                            callbackFunc();
                        }
                    })
                    .error(function (error) {
                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                            $rootScope.openSaaSMessage(error);
                        }
                        <span style="color:#0000ff;">else</span> {
                            <span style="color:#0000ff;">if</span> (error.message) {
                                alert($translate.instant(error.message));
                            }
                            <span style="color:#0000ff;">else</span> {
                                errorDisplay.show(error);
                            }

                        }
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.converting = <span style="color:#0000ff;">false</span>;
                    });
            }
        };

        $scope.convertToInvoice = function () {
            <span style="color:#0000ff;">if</span> ($scope.clicked) <span style="color:#0000ff;">return</span>;

            $scope.clicked = <span style="color:#0000ff;">true</span>;

            <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && !$scope.sales.settings.isApproved) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_NOT_APPROVED'</span>));
                <span style="color:#0000ff;">return</span>;
            }
            <span style="color:#0000ff;">var</span> newSales = {};

            angular.copy($scope.sales, newSales);

            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.CONVERTING'</span>))) {
                salesService.convertToInvoice(salesId, newSales)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                            $scope.myForm.$setPristine();

                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                <span style="color:#0000ff;">switch</span> ($scope.currentLessonCode) {
                                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                                        emergeNotification.success($translate.instant(<span style="color:#a31515;">'LABEL.ITP.ADVANCED_OPERATIONS.SOTOINVOICE.MESSAGE'</span>));

                                        <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"ARInvoice"</span>];
                                        <span style="color:#0000ff;">var</span> documentId = data.invoiceId;

                                        $timeout(function () {
                                            $rootScope.finishITPLessonAndShowBadge($scope.currentLessonCode, documentType, documentId);
                                            $rootScope.$itpService.stopIntroJs();
                                        }, 1000)

                                        $location.url(<span style="color:#a31515;">'/invoices/'</span> + data.invoiceId);
                                        <span style="color:#0000ff;">break</span>;
                                    <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                                        <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"ARInvoice"</span>];;
                                        <span style="color:#0000ff;">var</span> documentId = data.invoiceId;

                                        $rootScope.$itpService.setDoneLessonITPQuickFlow(documentType, documentId);
                                        $rootScope.finishITPLesson($scope.currentLessonCode);
                                        $location.url(<span style="color:#a31515;">'/invoices/'</span> + data.invoiceId + <span style="color:#a31515;">'?lesson-code=ACC_RPT_INV_L2&step-code=5_1_2_1'</span>);
                                        <span style="color:#0000ff;">break</span>;
                                    <span style="color:#0000ff;">default</span>:
                                        <span style="color:#0000ff;">if</span> ($rootScope.$itpService.isRelearnITPLesson()) {
                                            $location.url(<span style="color:#a31515;">'/invoices/'</span> + data.invoiceId + <span style="color:#a31515;">'?lesson-code=ACC_RPT_INV_L2&step-code=5_1_2_1&relearn-lesson=true'</span>);
                                        } <span style="color:#0000ff;">else</span> {
                                            $location.url(<span style="color:#a31515;">'/invoices/'</span> + data.invoiceId + <span style="color:#a31515;">'?lesson-code=ACC_RPT_INV_L2&step-code=5_1_2_1'</span>);
                                        }
                                        <span style="color:#0000ff;">break</span>;
                                }
                            } <span style="color:#0000ff;">else</span> {
                                emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ACC.INVOICE_CONVERTED'</span>));
                                $location.url(<span style="color:#a31515;">'/invoices/'</span> + data.invoiceId + <span style="color:#a31515;">'/edit'</span>);
                            }
                        }

                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                        } <span style="color:#0000ff;">else</span> {
                            callbackFunc();
                        }
                    })
                    .error(function (error) {
                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                            $rootScope.openSaaSMessage(error);
                        }
                        <span style="color:#0000ff;">else</span> {
                            errorDisplay.show(error);
                        }
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.clicked = <span style="color:#0000ff;">false</span>;
                    });
            }
        };

        $scope.closeSalesOrder = function (isAlsoConvertToDelivery) {
            <span style="color:#0000ff;">if</span> (!Auth.hasPermissions(<span style="color:#a31515;">'accounts_create'</span>)) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.UNAUTHORIZED_ERROR'</span>));
                <span style="color:#0000ff;">return</span>;
            }

            <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && !$scope.sales.settings.isApproved) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_NOT_APPROVED'</span>));
                <span style="color:#0000ff;">return</span>;
            }

            salesService.closeSalesOrder($routeParams.id, isAlsoConvertToDelivery)
            .success(function (data) {
                <span style="color:#0000ff;">if</span> (isAlsoConvertToDelivery) {
                    emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.CLOSED'</span>));
                } <span style="color:#0000ff;">else</span> {
                    emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ACC.PAYMENT_CREATED'</span>));
                }

                $route.reload();
            })
            .error(function (error) {
                alert($translate.instant(error.message));
            })
            .<span style="color:#0000ff;">finally</span>(function () {

            });
        }

        $scope.copySalesOrder = function () {
            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.DUPLICATING'</span>))) {
                $scope.duplicating = <span style="color:#0000ff;">true</span>;
                salesService.duplicate(salesId)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                            $scope.myForm.$setPristine();
                            alert($translate.instant(<span style="color:#a31515;">'ALERT.DUPLICATED'</span>));
                            $location.url(<span style="color:#a31515;">'/sales/'</span> + data.salesOrderId + <span style="color:#a31515;">'/edit'</span>);
                        }

                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                        } <span style="color:#0000ff;">else</span> {
                            callbackFunc();
                        }
                    })
                    .error(function (error) {
                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                            $rootScope.openSaaSMessage(error);
                        }
                        <span style="color:#0000ff;">else</span> {
                            errorDisplay.show(error);
                        }
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.duplicating = <span style="color:#0000ff;">false</span>;
                    });
            }
        };

        $scope.cancelSalesOrder = function (salesOrderNumber) {
            <span style="color:#0000ff;">var</span> listpob2b = [];
            angular.forEach(poB2B, function (po, i) {
                <span style="color:#0000ff;">if</span> (po.isBackToBack) {
                    listpob2b.push(po.purchaseOrderNumber);
                }
            });

            <span style="color:#0000ff;">var</span> str = <span style="color:#a31515;">""</span>;
            <span style="color:#0000ff;">if</span> (!listpob2b.length) {
                str = $translate.instant(<span style="color:#a31515;">'ALERT.CANCELLING'</span>);
            } <span style="color:#0000ff;">else</span> {
                str = $translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALESB2B_DELETED'</span>, { delete_so: <span style="color:#a31515;">'('</span> + salesOrderNumber + <span style="color:#a31515;">')'</span> }) + <span style="color:#a31515;">' ('</span> + listpob2b.join() + <span style="color:#a31515;">'). '</span> + $translate.instant(<span style="color:#a31515;">'ALERT.ARE_YOU_SURE'</span>);
            }

            <span style="color:#0000ff;">if</span> (confirm(str)) {
                $scope.cancelling = <span style="color:#0000ff;">true</span>;
                salesService.delete(salesId)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                            $scope.myForm.$setPristine();
                            emergeNotification.success($translate.instant(<span style="color:#a31515;">'ORD.ALERT.SO_CANCELLED'</span>));
                            $location.url(<span style="color:#a31515;">'sales'</span>);
                        };

                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                        } <span style="color:#0000ff;">else</span> {
                            callbackFunc();
                        }
                    })
                    .error(function (error) {
                        errorDisplay.show(error);
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.cancelling = <span style="color:#0000ff;">false</span>;
                    });
            }
        };

        $scope.getShippingAndBillingAttentionContacts = function (customer) {
            $scope.sales.shipContacts = [];
            $scope.sales.billContacts = [];

            <span style="color:#0000ff;">if</span> (customer.contactList) {
                <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> i = 0; i &lt; customer.contactList.length; i++) {
                    <span style="color:#0000ff;">var</span> curCnt = customer.contactList[i];
                    <span style="color:#0000ff;">if</span> ($scope.sales.shipAttn) {
                        <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> j = 0; j &lt; $scope.sales.shipAttn.length; j++) {
                            <span style="color:#0000ff;">var</span> curShipCntId = $scope.sales.shipAttn[j];
                            <span style="color:#0000ff;">if</span> (curShipCntId == curCnt.contactId) {
                                $scope.sales.shipContacts.push(curCnt);
                            }
                        }
                    }
                    <span style="color:#0000ff;">if</span> ($scope.sales.billAttn) {
                        <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> j = 0; j &lt; $scope.sales.billAttn.length; j++) {
                            <span style="color:#0000ff;">var</span> curBillCntId = $scope.sales.billAttn[j];
                            <span style="color:#0000ff;">if</span> (curBillCntId == curCnt.contactId) {
                                $scope.sales.billContacts.push(curCnt);
                            }
                        }
                    }
                }
            }
        }

        $scope.onChangedDropshipSupplier = function (item, dropshipDetails) {

            <span style="color:#0000ff;">var</span> duplicatedSupplierList = _.filter(item.salesOrderDetailsDropShipList, function (dropship) {
                <span style="color:#0000ff;">return</span> dropship.supplierId == dropshipDetails.supplierId;
            });

            <span style="color:#0000ff;">if</span> (duplicatedSupplierList && duplicatedSupplierList.length &gt; 1) {
                alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.DROPSHIP_CANNOT_HAVE_DUPLICATED_SUPPLIER_ID'</span>));
                dropshipDetails.supplierId = <span style="color:#0000ff;">null</span>;
            }
        };

        $scope.$watchGroup(
            [
                function () {
                    <span style="color:#0000ff;">return</span> angular.toJson($scope.sales.salesOrderDetailsList_Items);
                },
                function () {
                    <span style="color:#0000ff;">return</span> angular.toJson($scope.sales.salesOrderDetailsList_Additionals);
                }
            ],
            function (newVal, oldVal, scope) {
                <span style="color:#008000;">// reset the list</span>
                $scope.sales.salesOrderDetailsList = [];

                <span style="color:#0000ff;">if</span> (newVal != oldVal) {
                    <span style="color:#0000ff;">var</span> arr1 = angular.fromJson(newVal[0]);
                    <span style="color:#0000ff;">var</span> arr2 = angular.fromJson(newVal[1]);

                    <span style="color:#0000ff;">if</span> (arr1.length) {
                        $scope.sales.salesOrderDetailsList = arr1;
                    }

                    <span style="color:#0000ff;">if</span> (arr2) {
                        <span style="color:#0000ff;">if</span> (arr2.length) {
                            $scope.sales.salesOrderDetailsList = $scope.sales.salesOrderDetailsList.concat(arr2);
                        }
                    }
                }
            }
        );

        $scope.$watch(<span style="color:#a31515;">'sales'</span>, function (oldVal, newVal) {
            <span style="color:#0000ff;">if</span> (!oldVal) <span style="color:#0000ff;">return</span>;

            <span style="color:#0000ff;">if</span> ($scope.sales.salesOrderDetailsList_Items && $scope.sales.salesOrderDetailsList_Items.length &gt; $rootScope.maxDetailItems) {
                $scope.sales.salesOrderDetailsList_Items.pop();
            }
            <span style="color:#0000ff;">var</span> totalQuantity = 0;
            <span style="color:#0000ff;">var</span> totalPrice = 0;
            <span style="color:#0000ff;">var</span> totalDiscount = 0;
            <span style="color:#0000ff;">var</span> totalAdditional = 0;
            <span style="color:#0000ff;">var</span> totalTax = 0;
            <span style="color:#0000ff;">var</span> totalGrand = 0;
            <span style="color:#0000ff;">var</span> sales = $scope.sales;

            totalQuantity = _.reduce($scope.sales.salesOrderDetailsList_Items, function (memo, num) {
                <span style="color:#0000ff;">var</span> _qty = 0;
                <span style="color:#0000ff;">if</span> (!isNaN(num.qty) && num.productId) {
                    _qty = num.qty;
                }

                <span style="color:#0000ff;">return</span> Number(memo) + _qty * 1;
            }, 0);

            totalPrice = 0;
            <span style="color:#0000ff;">var</span> calculateLineTotal = function (item) {
                <span style="color:#0000ff;">var</span> _total = 0;
                <span style="color:#0000ff;">var</span> _totalLine = 0;
                <span style="color:#0000ff;">var</span> _totalLineTax = 0;
                <span style="color:#0000ff;">var</span> _totalDiscount = 0;
                <span style="color:#0000ff;">var</span> _totalAdditional = 0;
                <span style="color:#0000ff;">var</span> _discountType = <span style="color:#0000ff;">null</span>;
                item.lineTotal = 0;

                <span style="color:#0000ff;">if</span> (item.unitPrice && item.qty) {
                    _totalLine = (item.unitPrice * item.qty);

                    <span style="color:#0000ff;">if</span> (item.discountTypeId) {
                        _discountType = item.discountTypeId;

                        <span style="color:#0000ff;">if</span> (_discountType == 1) {
                            _totalDiscount = _totalLine * (item.discountAmount || 0) / 100;
                        } <span style="color:#0000ff;">else</span> {

                            _totalDiscount = item.discountAmount || 0;
                        }

                        totalDiscount += _totalDiscount;
                    }

                    _total = Number(Math.round((_totalLine - _totalDiscount) + <span style="color:#a31515;">'e2'</span>) + <span style="color:#a31515;">'e-2'</span>); <span style="color:#008000;">// round discount to 2 decimal places</span>

                    <span style="color:#0000ff;">if</span> (item.taxRate &gt; 0) {
                        <span style="color:#0000ff;">if</span> ($scope.sales.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                            _totalLineTax = ((item.taxRate / 100) * _total) / (1 + (item.taxRate / 100));
                        } <span style="color:#0000ff;">else</span> {
                            _totalLineTax = _total * ((item.taxRate / 100));
                        }
                        totalTax += _totalLineTax;
                    }

                    <span style="color:#0000ff;">if</span> (!item.productId) {
                        _totalAdditional += _totalLine;
                        totalAdditional += _totalAdditional;
                    }

                    item.lineTotal = _total;
                }

                totalPrice += item.productId ? item.lineTotal : 0;
            };

            _.forEach($scope.sales.salesOrderDetailsList_Items, function (item) {
                calculateLineTotal(item);
            }, 0);

            _.forEach($scope.sales.salesOrderDetailsList_Additionals, function (item) {
                calculateLineTotal(item);
            }, 0);


            totalGrand = totalPrice + totalTax;
            <span style="color:#0000ff;">if</span> ($scope.sales.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                totalGrand -= totalTax;
            }

            $scope.totalPrice = totalPrice;
            $scope.totalQuantity = totalQuantity || 0;
            $scope.totalAdditional = totalAdditional;

            $scope.totalTax = totalTax;
            $scope.totalGrand = totalGrand + totalAdditional;
            $scope.totalDiscount = totalDiscount;
        }, <span style="color:#0000ff;">true</span>);


        $scope.currentLessonCode;
        $scope.callbackArr;
        <span style="color:#0000ff;">var</span> proposeCallback;
        <span style="color:#0000ff;">var</span> proposeNextCallback;
        <span style="color:#0000ff;">var</span> pdfCloseModalCallback;
        $scope.menuIds = {};
        $scope.menuStatus = {};
        $scope.itpFocusMenu = {};
        $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;

        $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
        $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;

        $scope.addFinalStep = function () {
            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                $rootScope.$itpService.startFromStep(<span style="color:#a31515;">"OPR_ORD_SO_L1_S6"</span>, $scope.callbackArr);
            }
        }

        $scope.itpNextStepDOTab = function () {
            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                $rootScope.$itpService.startFromStep(<span style="color:#a31515;">"2_2_3_4"</span>, $scope.callbackArr);
            }
        }

        $scope.itpUpdateFormWhenClickingCheckBox = function () {
            $timeout(function () {
                $rootScope.$itpService.getIntroJs().refresh();
            });
        }

        $scope.runIntroJS = function () {
            $scope.currentLessonCode = $rootScope.$itpService.getLessonCode();
            <span style="color:#0000ff;">if</span> (!$scope.currentLessonCode.length) {
                $rootScope.isITPRunning = <span style="color:#0000ff;">false</span>;
                <span style="color:#0000ff;">return</span>;
            }

            $rootScope.$itpService.hideAllModal();
            $rootScope.actionMenuTopValue = <span style="color:#a31515;">"actionMenuTop"</span>;
            $rootScope.isLoadingITPData = <span style="color:#0000ff;">true</span>;

            <span style="color:#0000ff;">switch</span> ($scope.currentLessonCode) {
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L2'</span>:
                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">'2_2_2_2'</span>,
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales?lesson-code=OPR_ORD_SO_L2&step-code=2_2_2_1&relearn-lesson=true'</span>;
                                    $window.location.replace($window.location.href);
                                },
                                onafterchange: function () {
                                    $scope.itpFocusMenu = { showQuickConvertDO: <span style="color:#0000ff;">true</span> };
                                    $(<span style="color:#a31515;">'#convertDeliveryBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.menuStatus = { delivery: <span style="color:#0000ff;">true</span> };
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"285px"</span> });
                                }
                            }
                        ];
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_DO_L2'</span>:
                    $scope.callbackArr = [
                        {
                            stepCode: <span style="color:#a31515;">'2_3_2_2'</span>,
                            backButtonCallback: function () {
                                $window.location.hash = <span style="color:#a31515;">'#/sales?lesson-code=OPR_ORD_DO_L2&step-code=10_1_1_1&relearn-lesson=true'</span>;
                                $window.location.replace($window.location.href);
                            },
                            onafterchange: function () {
                                $rootScope.$itpService.adjustCSSTooltip({}, { left: <span style="color:#a31515;">"665px"</span>, top: <span style="color:#a31515;">"20px"</span>, width: <span style="color:#a31515;">"285px"</span> });
                            }
                        }
                    ];
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_101"</span>,
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales/?lesson-code=AO_ATSO_L3&step-code=2_2_1_100&relearn-lesson=true'</span>;
                                    $window.location.replace($window.location.href);
                                },
                                onafterchange: function () {
                                    $(<span style="color:#a31515;">'#backOrderBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.itpFocusMenu = { showQuickConvertPO: <span style="color:#0000ff;">true</span> };
                                    $scope.menuStatus = { backOrder: <span style="color:#0000ff;">true</span> };
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"285px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_102"</span>,
                                nextButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeCallback == <span style="color:#a31515;">"function"</span>) {
                                        <span style="color:#0000ff;">return</span> proposeCallback();
                                    }

                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                },
                                backButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeNextCallback == <span style="color:#a31515;">"function"</span>) {
                                        $rootScope.$itpService.hideAllModal();

                                        <span style="color:#0000ff;">return</span> proposeNextCallback();
                                    }
                                },
                                onafterchange: function () {
                                    $scope.menuStatus = {};
                                    $scope.$apply();
                                    $rootScope.$itpService.getIntroJs().refresh();
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_103"</span>,
                                onafterchange: function () {
                                    $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                                    $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
                                }
                            }
                        ];
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                    $scope.menuStatus = { delivery: <span style="color:#0000ff;">true</span> };
                    $scope.itpFocusMenu = { showCreateDropshipping: <span style="color:#0000ff;">true</span> };

                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"10_1_4_2"</span>,
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales/?lesson-code=AO_ATSO_L4&step-code=10_1_4_1&relearn-lesson=true'</span>;
                                    $window.location.replace($window.location.href);
                                },
                                onafterchange: function () {
                                    $(<span style="color:#a31515;">'#backOrderBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"285px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"10_1_4_3"</span>,
                                nextButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeCallback == <span style="color:#a31515;">"function"</span>) {
                                        <span style="color:#0000ff;">return</span> proposeCallback();
                                    }

                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                },
                                backButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeNextCallback == <span style="color:#a31515;">"function"</span>) {
                                        $rootScope.$itpService.hideAllModal();

                                        <span style="color:#0000ff;">return</span> proposeNextCallback();
                                    }
                                },
                                onafterchange: function () {
                                    $scope.menuStatus = {};
                                    $scope.$apply();
                                    $rootScope.$itpService.getIntroJs().refresh();
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"10_1_4_4"</span>,
                                onafterchange: function () {
                                    $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                                    $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"210px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"10_1_4_5"</span>,
                                onafterchange: function () {
                                    $(<span style="color:#a31515;">'#convertDeliveryBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.itpFocusMenu = { showQuickConvertDO: <span style="color:#0000ff;">true</span> };
                                    $scope.menuStatus = { delivery: <span style="color:#0000ff;">true</span> };
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"285px"</span> });
                                }
                            }
                        ];
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                    $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                    $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
                    $rootScope.skipTrainingName = <span style="color:#a31515;">'LABEL.ITP.GENERAL.END_TRAINING'</span>;

                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"2_2_3_3"</span>,
                                onafterchange: function () {
                                    $scope.itpFocusMenu = { showQuickConvertInvoice: <span style="color:#0000ff;">true</span> };
                                    $scope.menuStatus = { invoice: <span style="color:#0000ff;">true</span> };
                                    $(<span style="color:#a31515;">'#convertInvoiceBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"280px"</span> });
                                },
                                nextButtonCallback: function () {
                                    $scope.menuStatus = {};
                                    $scope.$apply();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales?lesson-code='</span> + $scope.currentLessonCode + <span style="color:#a31515;">'&step-code=2_2_3_2'</span>;
                                    $window.location.replace($window.location.href);
                                },
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_3_4"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({ minWidth: <span style="color:#a31515;">"295px"</span> }, { width: <span style="color:#a31515;">"250"</span> });
                                },
                            }
                        ]
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                    $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                    $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
                    $rootScope.skipTrainingName = <span style="color:#a31515;">'LABEL.ITP.GENERAL.END_TRAINING'</span>;

                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"10_1_1_2"</span>,
                                onafterchange: function () {
                                    $scope.itpFocusMenu = { showQuickConvertDO: <span style="color:#0000ff;">true</span> };
                                    $scope.menuStatus = { delivery: <span style="color:#0000ff;">true</span> };
                                    $(<span style="color:#a31515;">'#convertDeliveryBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"280px"</span> });
                                },
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales?lesson-code='</span> + $scope.currentLessonCode + <span style="color:#a31515;">'&step-code=10_1_1_1&relearn-lesson=true'</span>;
                                    $window.location.replace($window.location.href);
                                },
                            },
                            {
                                stepCode: <span style="color:#a31515;">"10_1_1_3"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({ minWidth: <span style="color:#a31515;">"295px"</span> }, { left: <span style="color:#a31515;">"665px"</span>, top: <span style="color:#a31515;">"22px"</span>, width: <span style="color:#a31515;">"250"</span> });
                                },
                                backButtonCallback: function () {
                                    $scope.menuIds.convertInvoice.isInvoiceContentShowing = <span style="color:#0000ff;">false</span>;
                                    $rootScope.actionMenuTopValue = <span style="color:#a31515;">""</span>;
                                    $scope.$apply();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                }
                            }
                        ]
                    <span style="color:#0000ff;">break</span>;

                <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                    $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                    $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;
                    $rootScope.skipTrainingName = <span style="color:#a31515;">'LABEL.ITP.GENERAL.END_TRAINING'</span>;

                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"10_1_2_3"</span>,
                                onafterchange: function () {
                                    $scope.itpFocusMenu = { showQuickConvertInvoice: <span style="color:#0000ff;">true</span> };
                                    $(<span style="color:#a31515;">'#convertInvoiceBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.menuStatus = { invoice: <span style="color:#0000ff;">true</span> };
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"280px"</span> });
                                },
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales?lesson-code='</span> + $scope.currentLessonCode + <span style="color:#a31515;">'&step-code=10_1_2_2&relearn-lesson=true'</span>;
                                    $window.location.replace($window.location.href);
                                },
                            },
                            {
                                stepCode: <span style="color:#a31515;">"10_1_2_4"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({ minWidth: <span style="color:#a31515;">"295px"</span> }, { width: <span style="color:#a31515;">"250"</span> });
                                },
                            }
                        ]
                    <span style="color:#0000ff;">break</span>;
                <span style="color:#0000ff;">default</span>:
                    $scope.callbackArr =
                        [
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_2"</span>,
                                onbeforechange: function () {
                                    $rootScope.$itpService.updateHelperClass({ element: <span style="color:#a31515;">"#customerDDL"</span> });
                                    $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                                    $scope.$apply();
                                },
                                nextButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (!$scope.sales.customerId) {
                                        alert($translate.instant(<span style="color:#a31515;">'ALERT.CRM.PLEASE_SELECT_CUSTOMER'</span>));
                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                    }
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales/?lesson-code='</span> + $scope.currentLessonCode
                                    $window.location.replace($window.location.href);
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_3"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { top: <span style="color:#a31515;">"initial"</span>, bottom: <span style="color:#a31515;">"0px"</span>, width: <span style="color:#a31515;">"200px"</span> });
                                },
                                nextButtonCallback: function () {
                                    $rootScope.$itpService.updateHelperClass({ element: <span style="color:#a31515;">"#addItemSOD"</span> });

                                    <span style="color:#0000ff;">if</span> (!$scope.myForm.$valid) {
                                        alert($translate.instant(<span style="color:#a31515;">'ORD.ALERT.PLEASE_INPUT_DATA_FOR_SALES_DETAILS'</span>));
                                        <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                    }
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_4"</span>,
                                onbeforechange: function () {
                                    <span style="color:#0000ff;">if</span> ($(<span style="color:#a31515;">'.introjs-tooltip.emerge-45'</span>).<span style="color:#0000ff;">is</span>(<span style="color:#a31515;">':visible'</span>)) {
                                        $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"500px"</span> });
                                    };
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_5"</span>,
                                backButtonCallback: function () {
                                    $window.location.hash = <span style="color:#a31515;">'#/sales/new?lesson-code='</span> + $scope.currentLessonCode;
                                    $window.location.replace($window.location.href);
                                },
                                onafterchange: function () {
                                    angular.element(document).scrollTop(0);
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_6"</span>,
                                nextButtonCallback: function () {
                                    $rootScope.$itpService.hideAllModal();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"220px;"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_7"</span>,
                                backButtonCallback: function () {
                                    $scope.openSalesPDF($scope.sales);
                                    $scope.addFinalStep();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_8"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"350px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_10"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"325px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_9"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"500px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_11"</span>,
                                nextButtonCallback: function () {
                                    $rootScope.$itpService.hideAllModal();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"350px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_12"</span>,
                                backButtonCallback: function () {
                                    $scope.menuStatus = {};
                                    $scope.$apply();
                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                                },
                                onafterchange: function () {
                                    $scope.itpFocusMenu = { showQuickConvertPO: <span style="color:#0000ff;">true</span> };
                                    $scope.menuStatus = { backOrder: <span style="color:#0000ff;">true</span> };
                                    $(<span style="color:#a31515;">'#backOrderBtn'</span>).trigger(<span style="color:#a31515;">'click'</span>);
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"290px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_13"</span>,
                                nextButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeCallback == <span style="color:#a31515;">"function"</span>) {
                                        <span style="color:#0000ff;">return</span> proposeCallback();
                                    }

                                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                                },
                                backButtonCallback: function () {
                                    <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">typeof</span> proposeNextCallback == <span style="color:#a31515;">"function"</span>) {
                                        $rootScope.$itpService.hideAllModal();

                                        <span style="color:#0000ff;">return</span> proposeNextCallback();
                                    }
                                },
                                onafterchange: function () {
                                    $scope.menuStatus = {};
                                    $scope.$apply();
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"200px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_14"</span>,
                                onafterchange: function () {
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"210px"</span> });
                                }
                            },
                            {
                                stepCode: <span style="color:#a31515;">"2_2_1_15"</span>,
                                onafterchange: function () {
                                    $rootScope.skipModuleName = $translate.instant(<span style="color:#a31515;">'LABEL.ORD.DELIVERY'</span>);
                                    $rootScope.skipModuleLink = <span style="color:#a31515;">"#/sales?lesson-code=OPR_ORD_SO_L2&step-code=2_2_2_1"</span>;
                                    $rootScope.$itpService.adjustCSSTooltip({}, { width: <span style="color:#a31515;">"400px"</span> });
                                }
                            },
                        ];
                    <span style="color:#0000ff;">break</span>;
            }


            $timeout(function () {
                <span style="color:#0000ff;">if</span> ($routeParams.id) {
                    <span style="color:#0000ff;">var</span> initStepCode = <span style="color:#a31515;">"2_2_1_5"</span>;
                    <span style="color:#0000ff;">var</span> queryStepCode = $rootScope.$itpService.getStepCode();

                    <span style="color:#0000ff;">if</span> (queryStepCode) {
                        initStepCode = queryStepCode;
                    }

                    $rootScope.skipModuleName = <span style="color:#a31515;">''</span>;
                    $rootScope.skipModuleLink = <span style="color:#a31515;">''</span>;

                    <span style="color:#0000ff;">switch</span> ($scope.currentLessonCode) {
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L1'</span>:
                            $scope.menuIds = {}
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_DO_L2'</span>:
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_DO_L1'</span>:
                            $scope.menuIds = {
                                convertDO: {
                                    menuId: <span style="color:#a31515;">'convertToDO'</span>,
                                    subMenuClass: <span style="color:#a31515;">'is-DO-content-showing'</span>,
                                    actionId: <span style="color:#a31515;">'convertToDOContent_QuickConvert'</span>,
                                    isDOContentShowing: <span style="color:#0000ff;">true</span>
                                }
                            }
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L2'</span>:
                            $scope.menuIds = {
                                convertDO: {
                                    menuId: <span style="color:#a31515;">'convertToDO'</span>,
                                    subMenuClass: <span style="color:#a31515;">'is-DO-content-showing'</span>,
                                    actionId: <span style="color:#a31515;">'convertToDOContent_QuickConvert'</span>,
                                    isDOContentShowing: <span style="color:#0000ff;">true</span>
                                }
                            }
                            $rootScope.skipModuleName = $translate.instant(<span style="color:#a31515;">'LABEL.ACC.INVOICE'</span>);
                            $rootScope.skipModuleLink = <span style="color:#a31515;">"#/sales?lesson-code=OPR_ORD_SO_L3&step-code=2_2_3_1"</span>;
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'OPR_ORD_SO_L3'</span>:
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_SOTOINV'</span>:
                            $scope.menuIds = {
                                convertInvoice: {
                                    menuId: <span style="color:#a31515;">'convertToInvoice'</span>,
                                    subMenuClass: <span style="color:#a31515;">'is-Invoice-content-showing'</span>,
                                    actionId: <span style="color:#a31515;">'convertToInvoiceContent_QuickConvert'</span>,
                                    isInvoiceContentShowing: <span style="color:#0000ff;">true</span>
                                }
                            }
                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L4'</span>:
                            $scope.menuIds = {
                                convertPO: {
                                    menuId: <span style="color:#a31515;">'convertToPO'</span>,
                                    subMenuClass: <span style="color:#a31515;">'is-PO-content-showing'</span>,
                                    isPOContentShowing: <span style="color:#0000ff;">true</span>
                                },
                                convertDropShip: {
                                    actionId: <span style="color:#a31515;">'convertToDropShipContent_CreateDropShip'</span>,
                                }
                            }

                            <span style="color:#0000ff;">var</span> currentStepCode = $rootScope.$itpService.getStepCode();
                            <span style="color:#0000ff;">if</span> (currentStepCode == <span style="color:#a31515;">"10_1_4_5"</span>) {
                                $scope.menuIds = {
                                    convertDO: {
                                        menuId: <span style="color:#a31515;">'convertToDO'</span>,
                                        subMenuClass: <span style="color:#a31515;">'is-DO-content-showing'</span>,
                                        actionId: <span style="color:#a31515;">'convertToDOContent_QuickConvert'</span>,
                                        isDOContentShowing: <span style="color:#0000ff;">true</span>
                                    }
                                }
                            }

                            <span style="color:#0000ff;">break</span>;
                        <span style="color:#0000ff;">case</span> <span style="color:#a31515;">'AO_ATSO_L3'</span>:
                        <span style="color:#0000ff;">default</span>:
                         
                            $rootScope.skipModuleName = <span style="color:#a31515;">""</span>;
                            $rootScope.skipModuleLink = <span style="color:#a31515;">""</span>;

                            $scope.menuIds = {
                                convertPO: {
                                    menuId: <span style="color:#a31515;">'convertToPO'</span>,
                                    subMenuClass: <span style="color:#a31515;">'is-PO-content-showing'</span>,
                                    actionId: <span style="color:#a31515;">'convertToPOContent_QuickConvert'</span>,
                                    isPOContentShowing: <span style="color:#0000ff;">true</span>
                                }
                            }
                            <span style="color:#0000ff;">break</span>;
                    }

                    
                    <span style="color:#0000ff;">var</span> watchSalesOrderId = $scope.$watch(<span style="color:#a31515;">'sales.salesOrderId'</span>, function (newVal, oldVal) {
                        <span style="color:#0000ff;">if</span> (!newVal) <span style="color:#0000ff;">return</span>;

                    
                        $timeout(function () {
                            angular.element(document).ready(function () {
                                $rootScope.$itpService.startFromStep(initStepCode, $scope.callbackArr);
                                $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                            })
                        }, 1000);

                    
                        watchSalesOrderId();
                    });

                } <span style="color:#0000ff;">else</span> {
                    
                    $timeout(function () {
                        angular.element(document).ready(function () {
                            $rootScope.$itpService.startFromStep(<span style="color:#a31515;">"OPR_ORD_SO_L1_S2"</span>, $scope.callbackArr);
                            $rootScope.isLoadingITPData = <span style="color:#0000ff;">false</span>;
                        });
                    }, 500);
                }
            }, 500);
        };


        $scope._init();

        $scope.runIntroJS();
    }]);

     
       

        $scope.selectStatus = function (statusId) {
            $scope.changingStatus = <span style="color:#0000ff;">true</span>;

            salesService.updateStatus(salesId, statusId)
                .success(function (data) {
                    $scope.sales.salesOrderStatusId = statusId;
                    $scope.sales.settings.isApproved = statusId == 4 ? <span style="color:#0000ff;">true</span> : <span style="color:#0000ff;">false</span>;

                    emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_UPDATED'</span>));

                    <span style="color:#0000ff;">if</span> (!data && data != <span style="color:#0000ff;">true</span>) {
                        <span style="color:#0000ff;">return</span>;
                    }

                    $timeout(function () {
                        $scope.converting = <span style="color:#0000ff;">true</span>;
                        salesService.convertToDelivery(salesId, <span style="color:#0000ff;">true</span>)
                        .success(function (data) {
                            <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.DELIVERY_CONVERTED'</span>));
                            }

                            <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                            } <span style="color:#0000ff;">else</span> {
                                callbackFunc();
                            }
                        })
                        .error(function (error) {
                            <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                $rootScope.openSaaSMessage(error);
                            }
                            <span style="color:#0000ff;">else</span> {
                                errorDisplay.show(error);
                            }
                        })
                        .<span style="color:#0000ff;">finally</span>(function () {
                            $scope.converting = <span style="color:#0000ff;">false</span>;
                        });
                    });
                })
                .error(function (error, status) {
                    errorDisplay.show(error);
                    $log.error(error);
                })
                .<span style="color:#0000ff;">finally</span>(function () {
                    $scope.changingStatus = <span style="color:#0000ff;">false</span>;
                });
        };

       
        <span style="color:#0000ff;">var</span> processBeforeSave = function () {
            <span style="color:#0000ff;">var</span> i = $scope.sales.salesOrderDetailsList_Items.length;
            <span style="color:#0000ff;">while</span> (i--) {
                <span style="color:#0000ff;">var</span> item = $scope.sales.salesOrderDetailsList_Items[i];

                <span style="color:#0000ff;">if</span> ((!item.productId && item.isItem != <span style="color:#0000ff;">false</span> && !item.salesOrderDetailsId) || (item.isItem == <span style="color:#0000ff;">true</span> && !item.productId)) {
                    $scope.sales.salesOrderDetailsList_Items.splice(i, 1);
                }
            }

            <span style="color:#008000;">// remove from quotationDetailsList (affects the API)</span>
            <span style="color:#0000ff;">var</span> i = $scope.sales.salesOrderDetailsList.length;
            <span style="color:#0000ff;">while</span> (i--) {
                <span style="color:#0000ff;">var</span> item = $scope.sales.salesOrderDetailsList[i];

                <span style="color:#0000ff;">if</span> (!item) {
                    $scope.sales.salesOrderDetailsList.splice(i, 1);

                } <span style="color:#0000ff;">else</span> {
                    <span style="color:#0000ff;">if</span> ((!item.productId && item.isItem != <span style="color:#0000ff;">false</span> && !item.salesOrderDetailsId) || (item.isItem == <span style="color:#0000ff;">true</span> && !item.productId)) {
                        $scope.sales.salesOrderDetailsList.splice(i, 1);
                    }
                }
            }

            <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> i = 0; i &lt; $scope.sales.salesOrderDetailsList.length; i++) {
                <span style="color:#0000ff;">var</span> details = $scope.sales.salesOrderDetailsList[i];

                <span style="color:#0000ff;">if</span> (details) {
                    <span style="color:#0000ff;">if</span> (!validateDropshipDetailsQty(details)) <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                }
            }

            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
        };

        <span style="color:#008000;">// process the form</span>
        $scope.saveSales = function () {
            <span style="color:#0000ff;">if</span> ($scope.busy) {
                <span style="color:#0000ff;">return</span>;
            }

            <span style="color:#0000ff;">if</span> (!processBeforeSave()) <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;

            $timeout(function () {
                <span style="color:#0000ff;">var</span> newSales = {};
                angular.copy($scope.sales, newSales);
                newSales.priceList = <span style="color:#0000ff;">null</span>;
                newSales.tax = newSales.tax / 100;
                $scope.busy = <span style="color:#0000ff;">true</span>;
                <span style="color:#008000;">// set scope variable submitted to true to force validation</span>
                $scope.submitted = <span style="color:#0000ff;">true</span>;
                <span style="color:#0000ff;">if</span> (newSales.shipAttn) {
                    newSales.shipAttn = newSales.shipAttn.toString();
                }
                <span style="color:#0000ff;">if</span> (newSales.billAttn) {
                    newSales.billAttn = newSales.billAttn.toString();
                }
                newSales.tags = newSales.tags ? newSales.tags.join() : <span style="color:#a31515;">''</span>;
                <span style="color:#0000ff;">if</span> (!$scope.myForm.$valid) {
                    $scope.busy = <span style="color:#0000ff;">false</span>;
                    alert($translate.instant(<span style="color:#a31515;">'ALERT.FORM_ERROR'</span>));
                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                }
       
                <span style="color:#0000ff;">if</span> (salesId) {
                    <span style="color:#0000ff;">var</span> list = [];
                    angular.forEach(poB2B, function (po, i) {
                        <span style="color:#0000ff;">if</span> (po.isBackToBack) {
                            list.push(po.purchaseOrderNumber);
                        }
                    });
                    <span style="color:#0000ff;">var</span> isBackToBack = <span style="color:#0000ff;">false</span>;
                    <span style="color:#0000ff;">if</span> (newSales.purchaseOrders && newSales.purchaseOrders.length) {
                        <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> i = 0; i &lt; newSales.purchaseOrders.length; i++) {
                            <span style="color:#0000ff;">var</span> cur = newSales.purchaseOrders[i];
                            <span style="color:#0000ff;">if</span> (cur.isBackToBack) {
                                isBackToBack = <span style="color:#0000ff;">true</span>;
                                <span style="color:#0000ff;">break</span>;
                            }
                        }
                    }
                    <span style="color:#0000ff;">if</span> (isBackToBack) {
                        <span style="color:#0000ff;">var</span> str = $translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALESB2B_UPDATING'</span>, { edit_so: <span style="color:#a31515;">'('</span> + newSales.salesOrderNumber + <span style="color:#a31515;">')'</span> }) + <span style="color:#a31515;">'('</span> + list.join() + <span style="color:#a31515;">'). '</span> + $translate.instant(<span style="color:#a31515;">'ALERT.ARE_YOU_SURE'</span>);
                        <span style="color:#0000ff;">if</span> (confirm(str)) {
                        } <span style="color:#0000ff;">else</span> {
                            $scope.busy = <span style="color:#0000ff;">false</span>;
                            <span style="color:#0000ff;">return</span>;
                        }
                    }

                    <span style="color:#0000ff;">if</span> (newSales.settings.isApprovalRequired && newSales.settings.isApproved) {
                        <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_APPROVAL_RESEND'</span>))) {

                        } <span style="color:#0000ff;">else</span> {
                            $scope.busy = <span style="color:#0000ff;">false</span>;
                            <span style="color:#0000ff;">return</span>;
                        }
                    }

                    salesService.put(salesId, newSales)
                        .success(function (data) {
                            emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_UPDATED'</span>));
                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                $timeout(function () {
                                    $rootScope.$itpService.startFromStep(<span style="color:#a31515;">"2_2_1_5"</span>, $scope.callbackArr);
                                }, 800);
                            } <span style="color:#0000ff;">else</span> {
                                $location.url(<span style="color:#a31515;">'/sales/'</span> + salesId);
                            }

                            $timeout(function () {
                                <span style="color:#0000ff;">if</span> ($scope.myForm) {
                                    $scope.myForm.$setPristine();
                                }
                            }, 1000);
                        })
                        .error(function (error) {
                            errorDisplay.show(error);
                            $rootScope.showTranslatedErrorMessage(error);
                        })
                        .<span style="color:#0000ff;">finally</span>(function () {
                            $scope.busy = <span style="color:#0000ff;">false</span>;
                        });
                } <span style="color:#0000ff;">else</span> {
                    salesService.add(newSales)
                    .success(function (data) {
                        <span style="color:#0000ff;">var</span> callbackFunc = function () {
                            $scope.myForm.$setPristine();
                            emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_CREATED'</span>));

                            <span style="color:#0000ff;">if</span> ($rootScope.isITPRunning) {
                                <span style="color:#0000ff;">var</span> documentType = $rootScope.$itpService.getITPDocumentType()[<span style="color:#a31515;">"SalesOrder"</span>];
                                <span style="color:#0000ff;">var</span> documentId = data.salesOrderId;

                                $rootScope.$itpService.setDoneLessonITPQuickFlow(documentType, documentId);
                                $location.url(<span style="color:#a31515;">'/sales/'</span> + data.salesOrderId + <span style="color:#a31515;">"?lesson-code="</span> + $scope.currentLessonCode);
                            } <span style="color:#0000ff;">else</span> {
                                $rootScope.doneDashboardCheckListItem(Dashboard.Enum.DashboardCheckListCode.FinishedSalesOrder);

                                <span style="color:#0000ff;">if</span> (data.autoConvertToDOAfterSOCreated) {
                                    <span style="color:#0000ff;">var</span> dropshipItems = _.filter($scope.sales.salesOrderDetailsList, function (detail) {
                                        <span style="color:#0000ff;">return</span> detail.salesOrderDetailsDropShipList && detail.salesOrderDetailsDropShipList.length &gt; 0
                                    });
                                    <span style="color:#0000ff;">if</span> (dropshipItems.length) {
                                        swal({
                                            title: <span style="color:#a31515;">'Error'</span>,
                                            text: <span style="color:#a31515;">'Sales Order cannot be converted automatically when there is any dropship item(s).'</span>,
                                            customClass: <span style="color:#a31515;">'greenConfirmationButton'</span>,
                                            type: <span style="color:#a31515;">'warning'</span>,
                                            showCancelButton: <span style="color:#0000ff;">false</span>
                                        });
                                    } <span style="color:#0000ff;">else</span> {
                                        $scope.converting = <span style="color:#0000ff;">true</span>;
                                        salesService.convertToDelivery(data.salesOrderId, <span style="color:#0000ff;">true</span>)
                                        .success(function (data) {
                                            <span style="color:#0000ff;">var</span> callbackFunc = function () {
                                                emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.ORD.DELIVERY_CONVERTED'</span>));
                                                $timeout(function () {
                                                    $route.reload();
                                                });
                                            }

                                            <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                                                $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                                            } <span style="color:#0000ff;">else</span> {
                                                callbackFunc();
                                            }
                                        })
                                        .error(function (error) {
                                            <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                                                $rootScope.openSaaSMessage(error);
                                            }
                                            <span style="color:#0000ff;">else</span> {
                                                errorDisplay.show(error);
                                            }
                                        })
                                        .<span style="color:#0000ff;">finally</span>(function () {
                                            $scope.converting = <span style="color:#0000ff;">false</span>;
                                        });
                                    }
                                }

                                $location.url(<span style="color:#a31515;">'/sales/'</span> + data.salesOrderId);
                            }
                        }

                        <span style="color:#0000ff;">if</span> ($emerge.isRunningSaaS()) {
                            $rootScope.saasUpdateDocumentsLeft(callbackFunc);
                        } <span style="color:#0000ff;">else</span> {
                            callbackFunc();
                        }
                    })
                    .error(function (error) {
                        <span style="color:#0000ff;">if</span> (error && _.contains($rootScope.saasStatuses, error) && $emerge.isRunningSaaS()) {
                            $rootScope.openSaaSMessage(error);
                        }
                        <span style="color:#0000ff;">else</span> {
                            errorDisplay.show(error);
                        }
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.busy = <span style="color:#0000ff;">false</span>;
                    });
                }
            });
        };

        $scope.cancel = function () {
            $location.url(<span style="color:#a31515;">'/sales'</span>);
        }

        $scope.createProformaInvoice = function () {
            console.log(<span style="color:#a31515;">"creating proforma"</span>);
        };

        $scope.toggleDisplayReservation = function () {
            <span style="color:#0000ff;">if</span> ($scope.isReservation) {
                $scope.isReservation = <span style="color:#0000ff;">false</span>;
            } <span style="color:#0000ff;">else</span> {
                $scope.isReservation = <span style="color:#0000ff;">true</span>;
            }
        };

        <span style="color:#008000;">//??</span>

        $scope.preview = function (sales) {
            <span style="color:#0000ff;">var</span> dialog = $modal.open({
                backdrop: <span style="color:#0000ff;">true</span>,
                windowClass: <span style="color:#a31515;">'modal-preview'</span>,
                keyboard: <span style="color:#0000ff;">true</span>,
                templateUrl: <span style="color:#a31515;">'ORD/Sales/sales.print.html?a=a'</span>,
                controller: [<span style="color:#a31515;">"$scope"</span>, <span style="color:#a31515;">"$log"</span>, <span style="color:#a31515;">"$modalInstance"</span>, <span style="color:#a31515;">"productService"</span>, <span style="color:#a31515;">"$filter"</span>,
                    function ($scope, $log, $modalInstance, productService, $filter) {

                        $scope.sales = sales;

                        $scope.getTotalPrice = function () {
                            <span style="color:#0000ff;">return</span> getTotalPrice;
                        }
                        $scope.getTotalQuantity = function () {
                            <span style="color:#0000ff;">return</span> getTotalQuantity;
                        }

                        $scope.ok = function () {
                            $modalInstance.close();
                        }

                        $scope.cancel = function () {
                            $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);
                        };
                    }],
                resolve: {
                    getTotalPrice: function () {
                        <span style="color:#0000ff;">return</span> $scope.getTotalPrice();
                    },
                    getTotalQuantity: function () {
                        <span style="color:#0000ff;">return</span> $scope.getTotalQuantity();
                    }
                }
            });
        };

          <span style="color:#008000;">// Add item into $scope.sales.salesOrderDetailsList</span>
        $scope.addItem = function () {
            <span style="color:#0000ff;">var</span> newItem = { isItem: <span style="color:#0000ff;">true</span>, productId: <span style="color:#0000ff;">null</span> };

            <span style="color:#008000;">//add current discountType and discountAmount of Customer if exist</span>
            <span style="color:#0000ff;">if</span> ($scope.customer && $scope.customer.defaultDiscountAmount &gt; 0) {
                newItem.discountTypeId = $scope.customer.defaultDiscountType;
                newItem.discountAmount = $scope.customer.defaultDiscountAmount;
            }

            $scope.sales.salesOrderDetailsList_Items.push(newItem);
        }

        <span style="color:#008000;">// Add item into $scope.quotation.quotationDetailsList</span>
        $scope.addAdditional = function () {
            $scope.sales.salesOrderDetailsList_Additionals.push({ isItem: <span style="color:#0000ff;">false</span>, productId: <span style="color:#0000ff;">null</span>, order: 99, qty: 1 });
        }

        $scope.removeItem = function (index, item, type) {
            <span style="color:#0000ff;">var</span> salesOrderDetailsId = item ? item.salesOrderDetailsId : <span style="color:#0000ff;">null</span>;
            <span style="color:#0000ff;">if</span> (salesOrderDetailsId) {
                <span style="color:#0000ff;">var</span> salesId = $routeParams.id;
                <span style="color:#0000ff;">var</span> list = [];
                angular.forEach(poB2B, function (po, i) {
                    <span style="color:#0000ff;">if</span> (po.isBackToBack) {
                        list.push(po.purchaseOrderNumber);
                    }
                });

                <span style="color:#0000ff;">var</span> str = $translate.instant(<span style="color:#a31515;">'ALERT.DELETING'</span>);

                <span style="color:#0000ff;">if</span> (list.length) {
                    $translate.instant(<span style="color:#a31515;">'ALERT.EDITTINGSOB2B'</span>, { edit_so: <span style="color:#a31515;">'('</span> + $scope.sales.salesOrderNumber + <span style="color:#a31515;">')'</span> }) + <span style="color:#a31515;">'('</span> + list.join() + <span style="color:#a31515;">'). '</span> + $translate.instant(<span style="color:#a31515;">'ALERT.ARE_YOU_SURE'</span>);
                }

                <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && $scope.sales.settings.isApproved) {
                    str = $translate.instant(<span style="color:#a31515;">'ALERT.ORD.SALES_APPROVAL_RESEND'</span>, { type: $translate.instant(<span style="color:#a31515;">'LABEL.ORD.SALES_ORDER'</span>) });
                }

                <span style="color:#0000ff;">if</span> (confirm(str)) {
                    item.isDeleting = <span style="color:#0000ff;">true</span>;

                    salesService.deleteItem(salesId, salesOrderDetailsId)
                        .success(function (data) {
                            <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"additionals"</span>) {
                                $scope.sales.salesOrderDetailsList_Additionals.splice(index, 1);
                            } <span style="color:#0000ff;">else</span> {
                                $scope.sales.salesOrderDetailsList_Items.splice(index, 1);
                            }

                            <span style="color:#0000ff;">if</span> ($scope.sales.settings.isApprovalRequired && $scope.sales.settings.isApproved && $scope.sales.salesOrderStatusId == 4) {
                                $scope.sales.salesOrderStatusId = 2;
                            }
                        })
                        .error(function (data) {
                            errorDisplay.show(data);
                        })
                        .<span style="color:#0000ff;">finally</span>(function () {
                            item.isDeleting = <span style="color:#0000ff;">false</span>;
                        });
                }
            } <span style="color:#0000ff;">else</span> {
                <span style="color:#0000ff;">if</span> (type == <span style="color:#a31515;">"additionals"</span>) {
                    <span style="color:#0000ff;">var</span> index = $scope.sales.salesOrderDetailsList_Additionals.indexOf(item);
                    $scope.sales.salesOrderDetailsList_Additionals.splice(index, 1);
                } <span style="color:#0000ff;">else</span> {

                    <span style="color:#0000ff;">var</span> index = $scope.sales.salesOrderDetailsList_Items.indexOf(item);
                    $scope.sales.salesOrderDetailsList_Items.splice(index, 1);
                }
            }
        }

        $scope.getUOM = function (item) {
            <span style="color:#0000ff;">if</span> (!item.productId) <span style="color:#0000ff;">return</span>;

            <span style="color:#0000ff;">var</span> returnValue = <span style="color:#0000ff;">null</span>;

            angular.forEach(item.product.productUOMList, function (key, value) {
                <span style="color:#0000ff;">if</span> (key.productUOMId == item.productUOMId) {
                    returnValue = key;
                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                };
            });

            <span style="color:#0000ff;">return</span> returnValue;
        };

        $scope.openPODSelection = function (sod, index) {
            <span style="color:#0000ff;">var</span> sales = $scope.sales;
            <span style="color:#0000ff;">var</span> salesOrderDetailsId = sod.salesOrderDetailsId;
            <span style="color:#0000ff;">var</span> crrPurchaseOrderNumber = <span style="color:#a31515;">''</span>;
            <span style="color:#0000ff;">var</span> itemOjbWhenCloseModal = [];

            <span style="color:#0000ff;">var</span> dialog = $modal.open({
                backdrop: <span style="color:#0000ff;">true</span>,
                keyboard: <span style="color:#0000ff;">true</span>,
                size: <span style="color:#a31515;">'lg'</span>,
                templateUrl: <span style="color:#a31515;">'ORD/Sales/SalesEdit/salesEdit.modal.html?a=a'</span>,
                controller: [<span style="color:#a31515;">"$scope"</span>, <span style="color:#a31515;">"$modalInstance"</span>, <span style="color:#a31515;">"purchaseService"</span>, function ($scope, $modalInstance, purchaseService) {
                    $scope.poArr = {};
                    $scope.poArr.purchaseOrderDetailsList = [];
                    $scope.RemoveList = [];

                    purchaseService.query().then(function (data) {
                        <span style="color:#0000ff;">if</span> (data.data.length &lt;= 0) {
                            alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.PLEASE_ADD_PURCHASE_FIRST'</span>));
                            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;
                        }
                        $scope.poArr = (data.data.results);
                    });

                    $scope.onChangePurchaseOrder = function (purchase) {
                        <span style="color:#0000ff;">if</span> (purchase) {
                            purchase = angular.fromJson(purchase);
                            $scope.poArr.purchaseOrderDetailsList = purchase.purchaseOrderDetailsList;

                            crrPurchaseOrderNumber = purchase.purchaseOrderNumber;

                            angular.forEach(sod.salesPurchaseMappingList, function (k, v) {
                                angular.forEach($scope.poArr.purchaseOrderDetailsList, function (pod, v1) {

                                    <span style="color:#0000ff;">if</span> (pod.purchaseOrderDetailsId == k.purchaseOrderDetailsId && k.isDeleted != <span style="color:#0000ff;">true</span>) {
                                        pod.<span style="color:#0000ff;">checked</span> = <span style="color:#0000ff;">true</span>;
                                    }
                                });
                            });
                        }
                    };

                    $scope.onChangeReserveQty = function (item) {
                        <span style="color:#0000ff;">var</span> purchaseOrderDetailsId = item.purchaseOrderDetailsId;
                        <span style="color:#0000ff;">if</span> (salesId) {

                            <span style="color:#0000ff;">var</span> itemArr = sales.salesOrderDetailsList_Items;
                            <span style="color:#0000ff;">var</span> existsArr = _.filter(itemArr, function (e) {
                                <span style="color:#0000ff;">return</span> e.salesOrderDetailsId === salesOrderDetailsId;
                            });

                            angular.forEach(existsArr, function (k, v) {
                                angular.forEach(k.salesPurchaseMappingList, function (k1, v1) {
                                    <span style="color:#0000ff;">if</span> (k1.salesOrderDetailsId == salesOrderDetailsId && k1.purchaseOrderDetailsId == purchaseOrderDetailsId && k1.isDeleted != <span style="color:#0000ff;">true</span>) {
                                        k1.qty = item.reserveQty;
                                    }
                                });
                            });
                        } <span style="color:#0000ff;">else</span> {
                            angular.forEach(sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList, function (k, v) {

                                <span style="color:#0000ff;">if</span> (k.purchaseOrderDetailsId == purchaseOrderDetailsId && k.isDeleted != <span style="color:#0000ff;">true</span>) {
                                    k.qty = item.reserveQty;
                                }
                            });
                        }

                        itemOjbWhenCloseModal = existsArr;
                    }

                    $scope.selectPurchaseOrderDetails = function (item) {

                        <span style="color:#0000ff;">var</span> purchaseOrderDetailsId = item.purchaseOrderDetailsId;

                        <span style="color:#0000ff;">var</span> itemArr = sales.salesOrderDetailsList_Items;

                        <span style="color:#0000ff;">var</span> existsArr = _.filter(itemArr, function (e) {
                            <span style="color:#0000ff;">return</span> e.salesOrderDetailsId === salesOrderDetailsId;
                        });


                        <span style="color:#0000ff;">var</span> insert = <span style="color:#0000ff;">true</span>;

                        <span style="color:#0000ff;">if</span> (salesId) {

                            <span style="color:#0000ff;">var</span> exists = <span style="color:#0000ff;">false</span>;
                            angular.forEach(existsArr, function (k, v) {

                                <span style="color:#0000ff;">if</span> (k.salesPurchaseMappingList == <span style="color:#0000ff;">null</span> || angular.isUndefined(k.salesPurchaseMappingList)) {

                                    <span style="color:#0000ff;">var</span> salesPurchaseMappingList = [];

                                    salesPurchaseMappingList.purchaseOrderNumber = crrPurchaseOrderNumber;
                                    salesPurchaseMappingList.salesOrderDetailsId = salesOrderDetailsId;
                                    salesPurchaseMappingList.purchaseOrderDetailsId = purchaseOrderDetailsId;
                                    salesPurchaseMappingList.qty = item.reserveQty;

                                    k.salesPurchaseMappingList = salesPurchaseMappingList;
                                }

                                angular.forEach(k.salesPurchaseMappingList, function (k1, v1) {

                                    <span style="color:#0000ff;">if</span> (k1.salesOrderDetailsId == salesOrderDetailsId && k1.purchaseOrderDetailsId == purchaseOrderDetailsId && k1.isDeleted != <span style="color:#0000ff;">true</span>) {
                                        k1.isDeleted = <span style="color:#0000ff;">true</span>;
                                        exists = <span style="color:#0000ff;">true</span>;
                                        item.reserveQty = <span style="color:#a31515;">''</span>;
                                        <span style="color:#0000ff;">if</span> (k1.isNewInsert) {
                                            k.salesPurchaseMappingList.splice(k.salesPurchaseMappingList.indexOf(k1), 1);
                                        }
                                    }
                                });
                            });

                            <span style="color:#0000ff;">if</span> (!exists) {
                                angular.forEach(existsArr, function (k, v) {
                                    insert = <span style="color:#0000ff;">true</span>;
                                    angular.forEach(k.salesPurchaseMappingList, function (k1, v1) {
                                        <span style="color:#0000ff;">if</span> (k1.salesOrderDetailsId == salesOrderDetailsId && k1.purchaseOrderDetailsId == purchaseOrderDetailsId && k1.isDeleted == <span style="color:#0000ff;">true</span>) {
                                            k1.isDeleted = <span style="color:#0000ff;">null</span>;
                                            k1.isDeletePo = <span style="color:#0000ff;">null</span>;
                                            k1.qty = <span style="color:#a31515;">''</span>;
                                            insert = <span style="color:#0000ff;">false</span>;
                                        }
                                    });

                                    <span style="color:#0000ff;">if</span> (insert) {
                                        k.salesPurchaseMappingList.push({
                                            purchaseOrderNumber: crrPurchaseOrderNumber,
                                            salesOrderDetailsId: salesOrderDetailsId,
                                            purchaseOrderDetailsId: purchaseOrderDetailsId,
                                            qty: item.reserveQty,
                                            isNewInsert: <span style="color:#0000ff;">true</span>
                                        });
                                    }
                                });
                            }

                        } <span style="color:#0000ff;">else</span> {

                            insert = <span style="color:#0000ff;">true</span>;

                            <span style="color:#0000ff;">if</span> (sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList == <span style="color:#0000ff;">null</span> || angular.isUndefined(sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList)) {

                                <span style="color:#0000ff;">var</span> salesPurchaseMappingList = [];

                                salesPurchaseMappingList.purchaseOrderNumber = crrPurchaseOrderNumber;
                                salesPurchaseMappingList.purchaseOrderDetailsId = purchaseOrderDetailsId;

                                sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList = salesPurchaseMappingList;
                            } <span style="color:#0000ff;">else</span> {
                                angular.forEach(sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList, function (k, v) {
                                    <span style="color:#0000ff;">if</span> (k.purchaseOrderDetailsId == purchaseOrderDetailsId && k.isDeleted != <span style="color:#0000ff;">true</span>) {
                                        k.isDeleted = <span style="color:#0000ff;">true</span>;
                                        insert = <span style="color:#0000ff;">false</span>;
                                        item.reserveQty = <span style="color:#a31515;">''</span>;

                                        sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList.splice(sales.salesOrderDetailsList_Items[index].salesPurchaseMappingList.indexOf(k), 1);

                                    }
                                });
                            }

                            <span style="color:#0000ff;">if</span> (insert) {
                                sales.salesOrderDetailsList[index].salesPurchaseMappingList.push({
                                    purchaseOrderNumber: crrPurchaseOrderNumber,
                                    purchaseOrderDetailsId: purchaseOrderDetailsId,
                                    qty: item.reserveQty,
                                    isNewInsert: <span style="color:#0000ff;">true</span>
                                });
                            }
                        }

                        itemOjbWhenCloseModal = existsArr;
                    };

                    $scope.cancel = function (item) {

                        <span style="color:#0000ff;">var</span> returnOk = <span style="color:#0000ff;">true</span>;
                        angular.forEach(itemOjbWhenCloseModal, function (k, v) {

                            <span style="color:#0000ff;">var</span> total = 0;
                            angular.forEach(k.salesPurchaseMappingList, function (k1, v1) {


                                <span style="color:#0000ff;">if</span> (!k1.isDeleted) {
                                    total += k1.qty;
                                }

                                <span style="color:#0000ff;">if</span> (total &gt; sod.qty) {
                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.TOTAL_RESERVED_QTY_IS_MORE_THAN_INTENT_SALES_QTY'</span>));
                                    returnOk = <span style="color:#0000ff;">false</span>;
                                    <span style="color:#0000ff;">return</span>;
                                }

                                <span style="color:#0000ff;">if</span> (angular.isUndefined(k1.qty)) {
                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.PLEASE_CHECK_RESERVED_QTY'</span>));
                                    returnOk = <span style="color:#0000ff;">false</span>;
                                    <span style="color:#0000ff;">return</span>;
                                }

                                <span style="color:#0000ff;">if</span> (k1.qty == 0) {
                                    alert($translate.instant(<span style="color:#a31515;">'ALERT.ORD.RESERVE_QTY_CANNOT_BE_ZERO'</span>));
                                    alert(<span style="color:#a31515;">'Reserve qty cannot be 0!'</span>);
                                    returnOk = <span style="color:#0000ff;">false</span>;
                                    <span style="color:#0000ff;">return</span>;
                                }
                            });
                        });

                        <span style="color:#0000ff;">if</span> (returnOk) {
                            $modalInstance.dismiss(<span style="color:#a31515;">'cancel'</span>);
                        }
                    };
                }]
            });

            dialog.result.then(function () {
            }, function () {
            });
        };

        $scope.deleteSalesPurchaseMapping = function (index, mapping, item) {
            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.DELETING'</span>))) {
                salesService.deleteSalesPurchaseMapping(salesId, mapping.salesOrderDetailsId, mapping.purchaseOrderDetailsId)
                    .success(function () {
                        item.salesPurchaseMappingList.splice(index, 1);

                        emergeNotification.success($translate.instant(<span style="color:#a31515;">'ALERT.PRD.ITEM_DELETED'</span>));
                    })
            }
        };

        function getUOMPrice(productUOMId, uomList, product) {
            <span style="color:#0000ff;">if</span> (productUOMId === <span style="color:#a31515;">'base'</span>) {
                <span style="color:#0000ff;">return</span> product.priceSelling;
            }

            <span style="color:#0000ff;">var</span> selectedUOM = _.find(uomList, function (uom) {
                <span style="color:#0000ff;">return</span> uom.productUOMId == productUOMId;
            });

            <span style="color:#0000ff;">if</span> (selectedUOM) {
                <span style="color:#0000ff;">return</span> !selectedUOM.isDeleted ? selectedUOM.priceSelling : selectedUOM.unitPrice;
            }

            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">null</span>;
        }

        $scope.onChangedUOM = function (index, productUOMId, uomList, item) {
            <span style="color:#0000ff;">if</span> ($scope.initializing) <span style="color:#0000ff;">return</span>;

            item.productUOMId = productUOMId;

            <span style="color:#0000ff;">if</span> (item.productUOMId === <span style="color:#a31515;">'base'</span>) {
                item.productUOMName = item.product.uom;
                item.productUOMValue = item.product.qtyPerUnit;
                item.unitPrice = item.product.priceSelling;
            } <span style="color:#0000ff;">else</span> {
                <span style="color:#0000ff;">var</span> selectedUOM = _.find(uomList, function (uom) {
                    <span style="color:#0000ff;">return</span> uom.productUOMId == item.productUOMId;
                });
                <span style="color:#0000ff;">if</span> (selectedUOM) {
                    item.productUOMId = selectedUOM.productUOMId;
                    item.productUOMName = selectedUOM.name;
                    item.productUOMValue = selectedUOM.value || 1;
                    item.unitPrice = !selectedUOM.isDeleted ? selectedUOM.priceSelling : selectedUOM.unitPrice;
                }
            }

            <span style="color:#0000ff;">if</span> ($scope.sales.priceList && $scope.sales.priceListId) {
                $scope.priceListChangedPerSaleDetail($scope.sales.priceListId, $scope.sales.salesOrderDetailsList_Items[index]);
            }

            $scope.updateTierPrices();
            item = $scope.getAvaiQtyTooltipText(item.qtyOverview, item);
        };

        $scope.onChangedTaxCode = function (item, taxId) {
            taxCodeService.updateTaxCodeAndRateOnChanged(item, taxId);
        };
        $scope.onChangedQtyForTooltipText = function (item) {
            item = $scope.getAvaiQtyTooltipText(item.qtyOverview, item);
        };

        $scope.onChangedProduct = function (index, item) {
            <span style="color:#0000ff;">if</span> (!item) {
                <span style="color:#0000ff;">return</span>;
            }

            item.isFocus = <span style="color:#0000ff;">true</span>;

            <span style="color:#0000ff;">var</span> newItem = {};
            newItem.product = {};

            productService.publicGetProductAndAvaiQty(item.productId, <span style="color:#0000ff;">false</span>)
            .success(function (data) {
                <span style="color:#0000ff;">var</span> product = data.product;
                <span style="color:#0000ff;">var</span> qtyOverview = data.productOverviewItem;

                <span style="color:#0000ff;">var</span> d = <span style="color:#0000ff;">new</span> Date();
                newItem.idForCheckBox = d.getTime();
                newItem.isService = product.isService;
                newItem.isTaxable = product.isTaxable;

                newItem.productId = product.productId;
                <span style="color:#0000ff;">if</span> (product.isVariantOfProductId) {
                    newItem.itemName = $rootScope.getProductVariantName(product.parentProduct, product);
                } <span style="color:#0000ff;">else</span> {
                    newItem.itemName = product.name;
                }

                newItem.unitPrice = product.priceSelling;
                newItem.description = product.description;
                newItem.itemCode = product.itemCode;
                newItem.qty = 1;

                newItem.taxCodeId = product.defaultTaxId;

                newItem.product = product;
                newItem.isFocus = <span style="color:#0000ff;">true</span>;
                newItem.isItem = <span style="color:#0000ff;">true</span>;
                newItem.salesOrderDetailsDropShipList = [];

                <span style="color:#0000ff;">if</span> (!newItem.salesOrderDetailsId) {
                    newItem.productUOMId = <span style="color:#a31515;">'base'</span>;
                    newItem.productUOMName = newItem.product.uom;
                    newItem.productUOMValue = newItem.product.qtyPerUnit;
                }

                <span style="color:#008000;">//assign AvaiQty tooltip text</span>
                <span style="color:#0000ff;">if</span> (qtyOverview) {
                    newItem.qtyOverview = qtyOverview;
                    newItem = $scope.getAvaiQtyTooltipText(qtyOverview, newItem);
                }

                <span style="color:#0000ff;">var</span> SODetailList = $scope.sales.salesOrderDetailsList_Items;
                <span style="color:#0000ff;">var</span> tempDiscountAmount = <span style="color:#0000ff;">null</span>;
                <span style="color:#0000ff;">var</span> tempDiscountTypeId = <span style="color:#0000ff;">null</span>;

                <span style="color:#0000ff;">if</span> (SODetailList[index]) {
                    tempDiscountAmount = SODetailList[index].discountAmount;
                    tempDiscountTypeId = SODetailList[index].discountTypeId;
                }

                newItem.discountAmount = tempDiscountAmount;
                newItem.discountTypeId = tempDiscountTypeId;

                $scope.sales.salesOrderDetailsList_Items[index] = newItem;

                <span style="color:#0000ff;">if</span> (++index == $scope.sales.salesOrderDetailsList_Items.length && !$scope.currentLessonCode) {
                    $scope.sales.salesOrderDetailsList_Items.push({ isItem: <span style="color:#0000ff;">true</span>, discountAmount: tempDiscountAmount, discountTypeId: tempDiscountTypeId });
                }

                <span style="color:#0000ff;">if</span> ($scope.sales.priceList && $scope.sales.priceListId) {
                    $scope.priceListChangedPerSaleDetail($scope.sales.priceListId, newItem);
                }

                $scope.updateTierPrices(<span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">false</span>);
            })
            .error(function (error) {
                alert($translate.instant(<span style="color:#a31515;">'ALERT.NOT_FOUND'</span>));
                <span style="color:#0000ff;">return</span>;
            })
            .<span style="color:#0000ff;">finally</span>(function () {

            });
        };

        $scope.onChangedDiscountAmount = function (item, type, amount, applyAll) {
            <span style="color:#0000ff;">if</span> (amount)
                item.discountAmount = amount;

            <span style="color:#0000ff;">if</span> (type)
                item.discountTypeId = type;

            <span style="color:#0000ff;">if</span> (applyAll) {
                angular.forEach($scope.sales.salesOrderDetailsList_Items, function (sod) {
                    sod.discountAmount = amount;
                    sod.discountTypeId = type;
                });
            }
        };

        $scope.getTotalReservedProduct = function (salesOrderDetail) {
            <span style="color:#0000ff;">var</span> result = 0;
            angular.forEach(salesOrderDetail.salesPurchaseMappingList, function (mapping, mappingIndex) {
                result += mapping.qty * mapping.purchaseOrderDetails.productUOMValue;
            });
            <span style="color:#0000ff;">return</span> result;
        };


        <span style="color:#0000ff;">var</span> firstLoadCurrency = <span style="color:#0000ff;">true</span>;
        $scope.currencyChanged = function () {
            <span style="color:#0000ff;">if</span> (salesId) {
                <span style="color:#0000ff;">if</span> (!firstLoadCurrency) {
                    $scope.sales.priceListId = <span style="color:#0000ff;">null</span>;
                    $scope.sales.priceList = <span style="color:#0000ff;">null</span>;
                    $timeout(function () {
                        $rootScope.$broadcast(<span style="color:#a31515;">'currencyChange'</span>, { currencyId: $scope.sales.currencyId, setDefault: <span style="color:#0000ff;">true</span> });
                        $scope.sales.exchangeRate = (initialCurrencyExchangeRate && $scope.sales.currencyId == initialCurrencyId) ? initialCurrencyExchangeRate : $scope.selected.currency.exchangeRate;
                    }, 10);
                }

                firstLoadCurrency = <span style="color:#0000ff;">false</span>;
            } <span style="color:#0000ff;">else</span> {
                $scope.sales.priceListId = <span style="color:#0000ff;">null</span>;
                $scope.sales.priceList = <span style="color:#0000ff;">null</span>;
                $timeout(function () {
                    $rootScope.$broadcast(<span style="color:#a31515;">'currencyChange'</span>, { currencyId: $scope.sales.currencyId, setDefault: <span style="color:#0000ff;">true</span> });
                    $scope.sales.exchangeRate = $scope.selected.currency.exchangeRate;
                }, 10);

            }
        };

        $scope.updateModel = function (priceList) {
            $scope.sales.priceListId = priceList.priceListId;
            $scope.sales.priceList = priceList;
            $scope.priceListChanged($scope.sales.priceListId);
        }

        <span style="color:#0000ff;">var</span> firstLoadPriceList = <span style="color:#0000ff;">true</span>;
        $scope.priceListChanged = function (priceListId) {
            <span style="color:#0000ff;">if</span> (firstLoadPriceList) {
                firstLoadPriceList = <span style="color:#0000ff;">false</span>;
                <span style="color:#0000ff;">return</span>;
            }

            <span style="color:#0000ff;">if</span> (!$scope.sales.salesOrderDetailsList_Items || $scope.sales.salesOrderDetailsList_Items.length == 0) {
                <span style="color:#0000ff;">return</span>;
            }

            $scope.sales.salesOrderDetailsList_Items.forEach(function (salesDetail) {
                <span style="color:#0000ff;">if</span> (salesDetail && salesDetail.product) {
                    <span style="color:#0000ff;">if</span> (!$scope.sales.priceList || !priceListId) {
                        <span style="color:#0000ff;">if</span> (salesDetail.product.productUOMList && salesDetail.product.productUOMList.length &gt; 0) {
                            salesDetail.unitPrice = getUOMPrice(salesDetail.productUOMId, salesDetail.product.productUOMList, salesDetail.product);
                        } <span style="color:#0000ff;">else</span> {
                            salesDetail.unitPrice = salesDetail.product.priceSelling;
                        }
                    } <span style="color:#0000ff;">else</span> {
                        <span style="color:#0000ff;">if</span> ($scope.sales.priceList.priceListProductSections && $scope.sales.priceList.priceListProductSections.length &gt; 0) {
                            <span style="color:#0000ff;">var</span> priceListProductSections = $scope.sales.priceList.priceListProductSections.filter(
                               function (priceListProductSection) {
                                   <span style="color:#0000ff;">return</span> priceListProductSection.priceListProductSectionProducts && priceListProductSection.priceListProductSectionProducts.filter(
                                     function (priceListProductSectionProduct) {
                                         <span style="color:#0000ff;">if</span> (salesDetail.productUOMId == <span style="color:#a31515;">'base'</span>) {
                                             <span style="color:#0000ff;">return</span> priceListProductSectionProduct.productId == salesDetail.productId && priceListProductSectionProduct.productUOMId == 0;
                                         }

                                         <span style="color:#0000ff;">return</span> priceListProductSectionProduct.productId == salesDetail.productId && priceListProductSectionProduct.productUOMId == salesDetail.productUOMId;
                                     }).length &gt; 0
                               });

                            <span style="color:#0000ff;">if</span> (priceListProductSections.length &gt; 0) {
                                salesDetail.unitPrice = priceListProductSections[0].price;
                            } <span style="color:#0000ff;">else</span> {
                                <span style="color:#0000ff;">if</span> (salesDetail.product.productUOMList && salesDetail.product.productUOMList.length &gt; 0) {
                                    salesDetail.unitPrice = getUOMPrice(salesDetail.productUOMId, salesDetail.product.productUOMList, salesDetail.product);
                                } <span style="color:#0000ff;">else</span> {
                                    salesDetail.unitPrice = salesDetail.product.priceSelling;
                                }
                            };
                        }
                    }
                }
            });
        }

        $scope.priceListChangedPerSaleDetail = function (priceListId, salesDetail) {
            <span style="color:#0000ff;">if</span> (salesDetail && salesDetail.product) {
                <span style="color:#0000ff;">if</span> (!$scope.sales.priceList || !priceListId) {
                    <span style="color:#0000ff;">if</span> (salesDetail.product.productUOMList && salesDetail.product.productUOMList.length &gt; 0) {
                        salesDetail.unitPrice = getUOMPrice(salesDetail.productUOMId, salesDetail.product.productUOMList, salesDetail.product);
                    } <span style="color:#0000ff;">else</span> {
                        salesDetail.unitPrice = salesDetail.product.priceSelling;
                    }
                } <span style="color:#0000ff;">else</span> {
                    <span style="color:#0000ff;">if</span> ($scope.sales.priceList.priceListProductSections && $scope.sales.priceList.priceListProductSections.length &gt; 0) {
                        <span style="color:#0000ff;">var</span> priceListProductSections = $scope.sales.priceList.priceListProductSections.filter(
                           function (priceListProductSection) {
                               <span style="color:#0000ff;">return</span> priceListProductSection.priceListProductSectionProducts && priceListProductSection.priceListProductSectionProducts.filter(
                                 function (priceListProductSectionProduct) {
                                     <span style="color:#0000ff;">if</span> (salesDetail.productUOMId == <span style="color:#a31515;">'base'</span>) {
                                         <span style="color:#0000ff;">return</span> priceListProductSectionProduct.productId == salesDetail.productId && priceListProductSectionProduct.productUOMId == 0;
                                     }

                                     <span style="color:#0000ff;">return</span> priceListProductSectionProduct.productId == salesDetail.productId && priceListProductSectionProduct.productUOMId == salesDetail.productUOMId;
                                 }).length &gt; 0
                           });

                        <span style="color:#0000ff;">if</span> (priceListProductSections.length &gt; 0) {
                            salesDetail.unitPrice = priceListProductSections[0].price;
                        } <span style="color:#0000ff;">else</span> {
                            <span style="color:#0000ff;">if</span> (salesDetail.product.productUOMList && salesDetail.product.productUOMList.length &gt; 0) {
                                salesDetail.unitPrice = getUOMPrice(salesDetail.productUOMId, salesDetail.product.productUOMList, salesDetail.product);
                            } <span style="color:#0000ff;">else</span> {
                                salesDetail.unitPrice = salesDetail.product.priceSelling;
                            }
                        };
                    }
                }
            }
        };
        <span style="color:#0000ff;">var</span> prefillData = function (customer) {
            <span style="color:#0000ff;">if</span> (!salesId) {
                $scope.sales.deliveryMethodId = customer.defaultDeliveryMethodId || <span style="color:#0000ff;">null</span>;
                $scope.sales.deliveryTermId = customer.defaultDeliveryTermId || <span style="color:#0000ff;">null</span>;

                $scope.sales.creditTermId = customer.defaultCreditTermId || <span style="color:#0000ff;">null</span>;
                $scope.sales.currencyId = customer.defaultCurrencyId || <span style="color:#0000ff;">null</span>;
                $scope.currencyChanged();

                $scope.sales.discountAmount = customer.defaultDiscountAmount || <span style="color:#0000ff;">null</span>;
                $scope.sales.discountTypeId = customer.defaultDiscountType || <span style="color:#0000ff;">null</span>;

                $scope.showHideDiscount();
            }

            $scope.getShippingAndBillingAttentionContacts($scope.customer);


            $timeout(function () {
                <span style="color:#0000ff;">if</span> ($scope.myForm) {
                    $scope.myForm.$setPristine();
                }
            }, 1000);
        };

        $scope.$watch(<span style="color:#a31515;">'selected.customer'</span>, function (newVal, oldVal) {
            <span style="color:#0000ff;">if</span> (newVal) {
                <span style="color:#0000ff;">var</span> selectedCustomer = newVal;
                <span style="color:#0000ff;">var</span> customerId = newVal.customerId;

                <span style="color:#0000ff;">if</span> (isNaN(customerId)) {
                    <span style="color:#0000ff;">return</span>;
                }

                <span style="color:#0000ff;">if</span> (selectedCustomer != <span style="color:#0000ff;">null</span>) {
                    $scope.customer = selectedCustomer;
                }

                <span style="color:#0000ff;">var</span> resetDiscount = function () {
                    <span style="color:#0000ff;">if</span> ($scope.sales.salesOrderDetailsList_Items) {
                        angular.forEach($scope.sales.salesOrderDetailsList_Items, function (node, index) {
                            <span style="color:#0000ff;">if</span> (!_.isEmpty(oldVal) || !$routeParams.id) {
                                node.discountTypeId = $scope.customer.defaultDiscountType;
                                node.discountAmount = $scope.customer.defaultDiscountAmount;
                            }
                        });
                    }
                }

                $scope.previousCustomerId = customerId;

                <span style="color:#008000;">//reset discount</span>
                resetDiscount();

                prefillData($scope.customer);

                <span style="color:#0000ff;">if</span> (!firstLoad) {
                    $scope.updateTierPrices(<span style="color:#0000ff;">true</span>);
                }

                firstLoad = <span style="color:#0000ff;">false</span>;
            }
        });

        $scope._init();


    }]);

ORD.controller(<span style="color:#a31515;">'SalesDeliveryListCtrl'</span>, [
    <span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$emerge'</span>, <span style="color:#a31515;">'$interval'</span>, <span style="color:#a31515;">'$rootScope'</span>, <span style="color:#a31515;">'$firebaseObject'</span>, <span style="color:#a31515;">'$http'</span>, <span style="color:#a31515;">'$route'</span>,
    <span style="color:#a31515;">'$routeParams'</span>, <span style="color:#a31515;">'$timeout'</span>, <span style="color:#a31515;">'$location'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'$modal'</span>, <span style="color:#a31515;">'$translate'</span>, <span style="color:#a31515;">'hotkeys'</span>,
    <span style="color:#a31515;">'errorDisplay'</span>, <span style="color:#a31515;">'salesService'</span>, <span style="color:#a31515;">'purchaseService'</span>, <span style="color:#a31515;">'customerService'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'$log'</span>,
    <span style="color:#a31515;">'deliveryService'</span>, <span style="color:#a31515;">'deliveryB2BService'</span>,
    function ($scope, $emerge, $interval, $rootScope, $firebaseObject, $http, $route,
        $routeParams, $timeout, $location, $filter, $modal, $translate, hotkeys, errorDisplay,
        salesService, purchaseService, customerService, productService, $log, deliveryService, deliveryB2BService) {
        <span style="color:#0000ff;">var</span> salesOrderId = <span style="color:#0000ff;">null</span>;
        $scope.deliveryOrderArr = [];

        $scope.readOnly = <span style="color:#0000ff;">true</span>;
        $scope.deliveryDO = function (delivery) {
            $scope.updatingDelivery = <span style="color:#0000ff;">true</span>;

            <span style="color:#0000ff;">var</span> updatingDO = {};

            angular.copy(delivery, updatingDO);

            updatingDO.deliveryOrderStatusId = 4;

            <span style="color:#0000ff;">if</span> (delivery.isDropship) {
                deliveryB2BService.update(updatingDO.deliveryOrderId, updatingDO)
                .success(function (data) {
                    delivery.deliveryOrderStatusId = 4;
                })
                .error(function (error) {
                    <span style="color:#0000ff;">if</span> (error.message) {
                        alert($translate.instant(error.message));
                    }
                })
                .<span style="color:#0000ff;">finally</span>(function () {
                    $scope.updatingDelivery = <span style="color:#0000ff;">false</span>;
                });
            }
            <span style="color:#0000ff;">else</span> {
                deliveryService.update(updatingDO.deliveryOrderId, updatingDO)
                .success(function (data) {
                    delivery.deliveryOrderStatusId = 4;
                })
                .error(function (error) {
                    <span style="color:#0000ff;">if</span> (error.message) {
                        alert($translate.instant(error.message));
                    }
                })
                .<span style="color:#0000ff;">finally</span>(function () {
                    $scope.updatingDelivery = <span style="color:#0000ff;">false</span>;
                });
            }
        }

        $scope.voidDO = function (id, isDropship, index) {
            <span style="color:#0000ff;">if</span> (confirm($translate.instant(<span style="color:#a31515;">'ALERT.CANCELLING'</span>))) {
                $scope.updatingDelivery = <span style="color:#0000ff;">true</span>;
                <span style="color:#0000ff;">if</span> (isDropship) {
                    deliveryB2BService.delete(id)
                    .success(function (data) {
                        $scope.allDOsList.splice(index, 1);
                        $scope.num.delivery = $scope.allDOsList.length;
                    })
                    .error(function (error) {
                        errorDisplay.show(error);
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.updatingDelivery = <span style="color:#0000ff;">false</span>;
                    });
                }
                <span style="color:#0000ff;">else</span> {
                    deliveryService.delete(id)
                    .success(function (data) {
                        $scope.allDOsList.splice(index, 1);
                        $scope.num.delivery = $scope.allDOsList.length;
                    })
                    .error(function (error) {
                        errorDisplay.show(error);
                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.updatingDelivery = <span style="color:#0000ff;">false</span>;
                    });
                }
            }
        }

        $scope.$watch(<span style="color:#a31515;">'delivery.deliveryOrderDetailsList'</span>, function (newval, oldval) {
            <span style="color:#0000ff;">if</span> ($scope.delivery && $scope.delivery.deliveryOrderDetailsList && $scope.delivery.deliveryOrderDetailsList.length) {
                <span style="color:#0000ff;">var</span> sum = _.reduce($scope.delivery.deliveryOrderDetailsList, function (memo, num) { <span style="color:#0000ff;">return</span> Number(memo) + Number(num.qty); }, 0);
                $scope.getTotalQuantity = sum;
            }
        }, <span style="color:#0000ff;">true</span>);

        <span style="color:#0000ff;">var</span> refineDOData = function (doList, isDropship) {
            <span style="color:#0000ff;">if</span> (!doList.length) {
                <span style="color:#0000ff;">return</span>;
            }
            angular.forEach(doList, function (obj) {
                obj.isDropship = isDropship;
                obj.dateDelivered = $filter(<span style="color:#a31515;">'date'</span>)(obj.dateDelivered, <span style="color:#a31515;">"dd/MM/yyyy"</span>);
                obj.tags = obj.tags ? (obj.tags.split(<span style="color:#a31515;">','</span>) || <span style="color:#a31515;">''</span>) : <span style="color:#a31515;">''</span>;
                <span style="color:#0000ff;">if</span> (obj.billAttn) {
                    obj.billAttn = obj.billAttn.split(<span style="color:#a31515;">','</span>);
                }
                <span style="color:#0000ff;">if</span> (obj.shipAttn) {
                    obj.shipAttn = obj.shipAttn.split(<span style="color:#a31515;">','</span>);
                }
            });
        }

        <span style="color:#0000ff;">var</span> _init = function () {
            salesOrderId = $routeParams.id;
            $scope.isLoadingDelivery = <span style="color:#0000ff;">true</span>;
            <span style="color:#0000ff;">if</span> (salesOrderId) {
                salesService.<span style="color:#0000ff;">get</span>(salesOrderId + <span style="color:#a31515;">'/deliveryOrders'</span>)
                    .success(function (data) {
                        $scope.doData = data;

                        refineDOData($scope.doData.doList);
                        refineDOData($scope.doData.doB2BList, <span style="color:#0000ff;">true</span>);

                        $scope.allDOsList = $scope.doData.doList.concat($scope.doData.doB2BList);
                        $scope.num.delivery = $scope.allDOsList.length || 0;
                    })
                    .error(function (error) {

                    })
                    .<span style="color:#0000ff;">finally</span>(function () {
                        $scope.isLoadingDelivery = <span style="color:#0000ff;">false</span>;
                    });
            }
        }

        _init();
    }
]);

ORD.controller(<span style="color:#a31515;">'SalesInvoiceListCtrl'</span>, [
    <span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$emerge'</span>, <span style="color:#a31515;">'$interval'</span>, <span style="color:#a31515;">'$rootScope'</span>, <span style="color:#a31515;">'$firebaseObject'</span>, <span style="color:#a31515;">'$http'</span>, <span style="color:#a31515;">'$route'</span>,
    <span style="color:#a31515;">'$routeParams'</span>, <span style="color:#a31515;">'$timeout'</span>, <span style="color:#a31515;">'$location'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'$modal'</span>, <span style="color:#a31515;">'$translate'</span>, <span style="color:#a31515;">'hotkeys'</span>, <span style="color:#a31515;">'errorDisplay'</span>, <span style="color:#a31515;">'salesService'</span>, <span style="color:#a31515;">'purchaseService'</span>, <span style="color:#a31515;">'customerService'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'$log'</span>,
    function ($scope, $emerge, $interval, $rootScope, $firebaseObject, $http, $route, $routeParams, $timeout, $location, $filter, $modal, $translate, hotkeys, errorDisplay, salesService, purchaseService, customerService, productService, $log) {

        $scope.showInvoiceDetails = <span style="color:#0000ff;">false</span>;
        <span style="color:#0000ff;">var</span> salesOrderId;
        $scope.invoiceArr = [];
        $scope.invoiceView = {};
        $scope.readOnly = <span style="color:#0000ff;">true</span>;
        $scope.onSelectInvoice = function (invoice) {
            $scope.invoice = invoice;
            $scope.showInvoiceDetails = <span style="color:#0000ff;">true</span>;

        };

        $scope.getInvoiceTotal = function (invoiceId, salesOrderId) {
            <span style="color:#0000ff;">var</span> item = _.find($scope.salesOrderCharges, function (e) { <span style="color:#0000ff;">return</span> e.salesOrderId === salesOrderId; });

            <span style="color:#0000ff;">return</span> item;
        }

        $scope.$watch(<span style="color:#a31515;">'invoice'</span>, function (oldVal, newVal) {
            <span style="color:#0000ff;">var</span> invoice = angular.copy($scope.invoice);
            $scope.salesOrderCharges = [];
            $scope.invoiceView.totalGrand = 0;
            $scope.invoiceView.totalAmountDue = 0;

            <span style="color:#0000ff;">var</span> salesOrdersDistinct = [];
            <span style="color:#0000ff;">var</span> salesOrderDetails = [];
            <span style="color:#0000ff;">var</span> test = [];
            <span style="color:#0000ff;">if</span> (invoice) {

                invoice.invoiceDetailsList = $filter(<span style="color:#a31515;">'orderBy'</span>)($scope.invoice.invoiceDetailsList, <span style="color:#a31515;">'salesOrderDetails.salesOrder.salesOrderNumber'</span>);

                salesOrdersDistinct = (_.groupBy(invoice.invoiceDetailsList, function (e) { <span style="color:#0000ff;">return</span> e.salesOrderDetails.salesOrder.salesOrderNumber; }));
                angular.forEach(salesOrdersDistinct, function (v, k) {

                    _.map(v, function (node) {
                        test.push(node);
                    });

                    <span style="color:#0000ff;">var</span> _salesOrder;
                    <span style="color:#0000ff;">var</span> grandTotal = 0;
                    <span style="color:#0000ff;">var</span> totalLine = 0;
                    <span style="color:#0000ff;">var</span> totalDiscountAmount = 0;
                    <span style="color:#0000ff;">var</span> totalTaxAmount = 0;
                    <span style="color:#0000ff;">var</span> _createdHeaders = [];

                    angular.forEach(v, function (v1, k1) {

                        <span style="color:#0000ff;">var</span> salesOrderNumber = v1.salesOrderDetails.salesOrder.salesOrderNumber;

                        <span style="color:#0000ff;">var</span> headerExists = _createdHeaders.indexOf(salesOrderNumber) &gt;= 0;
                        <span style="color:#0000ff;">if</span> (!headerExists) {
                            _createdHeaders.push(salesOrderNumber);
                            v1.showHeader = <span style="color:#0000ff;">true</span>;
                        } <span style="color:#0000ff;">else</span> {
                            v1.showHeader = <span style="color:#0000ff;">false</span>;
                        }

                        _salesOrder = v1.salesOrderDetails.salesOrder;
                        totalLine += ((v1.unitPrice) - v1.unitDiscount) * v1.qty;

                        totalDiscountAmount += (v1.salesOrderDetails.unitDiscount) * v1.qty;

                        <span style="color:#0000ff;">var</span> totalPrice = v1.qty * (v1.unitPrice - v1.unitDiscount);
                        <span style="color:#0000ff;">if</span> (_salesOrder.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                            totalTaxAmount += ((v1.salesOrderDetails.taxRate / 100) * totalPrice) / (1 + (v1.salesOrderDetails.taxRate / 100));
                        } <span style="color:#0000ff;">else</span> {
                            totalTaxAmount += totalPrice * (v1.salesOrderDetails.taxRate / 100);
                        }
                    });

                    <span style="color:#0000ff;">if</span> (_salesOrder == <span style="color:#0000ff;">null</span>) {
                        <span style="color:#0000ff;">return</span>;
                    }

                    totalGrand = parseFloat(totalLine.toFixed(2)) + parseFloat(totalTaxAmount.toFixed(2)); 

                    <span style="color:#0000ff;">if</span> (_salesOrder.isTaxInclusive == <span style="color:#0000ff;">true</span>) {
                        totalGrand -= totalTaxAmount.toFixed(2);
                    }

                    $scope.salesOrderCharges.push({
                        salesOrderId: _salesOrder.salesOrderId,
                        salesOrderNumber: _salesOrder.salesOrderNumber,
                        totalLine: totalLine,
                        totalDiscount: totalDiscountAmount,
                        totalTax: totalTaxAmount,
                        totalGrand: totalGrand,
                        isTaxInclusive: _salesOrder.isTaxInclusive
                    });
                });

                <span style="color:#008000;">// Total Quantities of all items</span>
                $scope.invoiceView.totalQuantity = _.reduce($scope.invoice.invoiceDetailsList, function (memo, num) {
                    <span style="color:#0000ff;">var</span> _qty = 0;
                    <span style="color:#0000ff;">if</span> (num) {
                        _qty = num.qty;
                    }

                    <span style="color:#0000ff;">return</span> Number(memo) + _qty;
                }, 0);

                <span style="color:#0000ff;">if</span> ($scope.salesOrderCharges.length) {
                    $scope.invoiceView.totalGrand = (_.reduce($scope.salesOrderCharges, function (e, so) { <span style="color:#0000ff;">return</span> Number(e) + so.totalGrand; }, 0));
                }

                $scope.invoiceView.totalAmountDue = $scope.invoiceView.totalGrand;

                <span style="color:#008000;">//minus the receipt amount</span>
                <span style="color:#0000ff;">if</span> ($scope.invoice.invoiceReceiptsList) {
                    <span style="color:#0000ff;">var</span> totalReceiptAmount = _.reduce($scope.invoice.invoiceReceiptsList, function (memo, node) {
                        <span style="color:#0000ff;">return</span> memo + node.amount;
                    }, 0);

                    $scope.invoiceView.totalAmountDue -= totalReceiptAmount.toFixed(2);
                }

            }
        }, <span style="color:#0000ff;">true</span>);

        $scope.createFooter = function (index) {
            <span style="color:#0000ff;">var</span> invDetailsList = $filter(<span style="color:#a31515;">'orderBy'</span>)($scope.invoice.invoiceDetailsList, <span style="color:#a31515;">'salesOrderDetails.salesOrder.salesOrderNumber'</span>);

            <span style="color:#0000ff;">var</span> totalIndex = invDetailsList.length - 1;
            <span style="color:#0000ff;">var</span> nextIndex = (index + 1) &lt; totalIndex ? index + 1 : totalIndex;
            <span style="color:#0000ff;">var</span> currentSOID = invDetailsList[index].salesOrderDetails.salesOrderId;
            <span style="color:#0000ff;">var</span> nextSOID = invDetailsList[nextIndex].salesOrderDetails.salesOrderId;

            showHeader2 = (currentSOID != nextSOID || ((index + 1) == invDetailsList.length));

            <span style="color:#0000ff;">return</span> showHeader2;
        }

        <span style="color:#0000ff;">var</span> _init = function () {
            salesOrderId = $routeParams.id;
            <span style="color:#0000ff;">if</span> (salesOrderId) {
                salesService.<span style="color:#0000ff;">get</span>(salesOrderId + <span style="color:#a31515;">'/Invoices'</span>)
                    .success(function (data) {
                        $scope.invoiceArr = data;
                        $scope.num.invoice = data.length;

                        <span style="color:#0000ff;">if</span> (data.length) {
                            angular.forEach(data, function (obj) {
                                <span style="color:#008000;">// set tags by scope tags populated via tagsChanged method</span>
                                obj.tags = obj.tags ? (obj.tags.split(<span style="color:#a31515;">','</span>) || <span style="color:#a31515;">''</span>) : <span style="color:#a31515;">''</span>;

                                <span style="color:#008000;">// convert shipping & billing attention to array</span>
                                <span style="color:#0000ff;">if</span> (obj.billAttn) {
                                    obj.billAttn = obj.billAttn.split(<span style="color:#a31515;">','</span>);
                                }
                                <span style="color:#0000ff;">if</span> (obj.shipAttn) {
                                    obj.shipAttn = obj.shipAttn.split(<span style="color:#a31515;">','</span>);
                                }

                                <span style="color:#0000ff;">if</span> (obj.customer.contactList) {
                                    <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> i = 0; i &lt; obj.customer.contactList.length; i++) {
                                        <span style="color:#0000ff;">var</span> curCnt = obj.customer.contactList[i];
                                        <span style="color:#0000ff;">if</span> (obj.shipAttn) {
                                            <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> j = 0; j &lt; obj.shipAttn.length; j++) {
                                                <span style="color:#0000ff;">var</span> curShipCntId = obj.shipAttn[j];
                                                <span style="color:#0000ff;">if</span> (curShipCntId == curCnt.contactId) {
                                                    <span style="color:#0000ff;">if</span> (!obj.shipContacts)
                                                        obj.shipContacts = [];
                                                    obj.shipContacts.push(curCnt);
                                                }
                                            }
                                        }
                                        <span style="color:#0000ff;">if</span> (obj.billAttn) {
                                            <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">var</span> j = 0; j &lt; obj.billAttn.length; j++) {
                                                <span style="color:#0000ff;">var</span> curBillCntId = obj.billAttn[j];
                                                <span style="color:#0000ff;">if</span> (curBillCntId == curCnt.contactId) {
                                                    <span style="color:#0000ff;">if</span> (!obj.billContacts)
                                                        obj.billContacts = [];
                                                    obj.billContacts.push(curCnt);
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    })
                    .error(function (error) {

                    });
            }
        }

        _init();
    }
]);

ORD.controller(<span style="color:#a31515;">'SalesPackingListCtrl'</span>, [
    <span style="color:#a31515;">'$scope'</span>, <span style="color:#a31515;">'$emerge'</span>, <span style="color:#a31515;">'$interval'</span>, <span style="color:#a31515;">'$rootScope'</span>, <span style="color:#a31515;">'$firebaseObject'</span>, <span style="color:#a31515;">'$http'</span>, <span style="color:#a31515;">'$route'</span>,
    <span style="color:#a31515;">'$routeParams'</span>, <span style="color:#a31515;">'$timeout'</span>, <span style="color:#a31515;">'$location'</span>, <span style="color:#a31515;">'$filter'</span>, <span style="color:#a31515;">'$modal'</span>, <span style="color:#a31515;">'$translate'</span>, <span style="color:#a31515;">'hotkeys'</span>, <span style="color:#a31515;">'errorDisplay'</span>, <span style="color:#a31515;">'salesService'</span>, <span style="color:#a31515;">'purchaseService'</span>, <span style="color:#a31515;">'customerService'</span>, <span style="color:#a31515;">'productService'</span>, <span style="color:#a31515;">'$log'</span>, <span style="color:#a31515;">'packingListService'</span>,
    function ($scope, $emerge, $interval, $rootScope, $firebaseObject, $http, $route, $routeParams, $timeout, $location, $filter, $modal, $translate, hotkeys, errorDisplay, salesService, purchaseService, customerService, productService, $log, packingListService) {
        $scope.showPackingListDetails = <span style="color:#0000ff;">false</span>;
        $scope.packingListArr = [];
        $scope.totalPackedQty = 0;
        $scope.currentPakTotalQty = 0;
        $scope.totalSalesQty = 0;

        <span style="color:#0000ff;">var</span> salesOrderId = <span style="color:#0000ff;">null</span>;

        $scope.onSelectPackingList = function (packingList) {
            $scope.packingList = packingList;
            $scope.showPackingListDetails = <span style="color:#0000ff;">true</span>;

            salesService.getSalesOrderPackingTotal($scope.packingList.salesOrderId)
                .success(function (data) {
                    $scope.packingList.salesOrder = $scope.$parent.$parent.$parent.$parent.sales;
                    $scope.packingList.salesOrder.salesOrderPackingTotal = data;
                })
                .error(function (error) {
                    console.log(error);
                });
        }

        $scope.$watch(<span style="color:#a31515;">'sales.salesOrderDetailsList_Items'</span>, function (newVal, oldVal) {
            <span style="color:#0000ff;">var</span> totalSalesQty = 0;
            <span style="color:#0000ff;">if</span> (newVal && newVal != oldVal) {
                angular.forEach(newVal, function (obj) {
                    totalSalesQty += obj.qty;
                });
            }

            $scope.totalSalesQty = totalSalesQty;
        });

        <span style="color:#0000ff;">var</span> _init = function () {
            salesOrderId = $routeParams.id;
            <span style="color:#0000ff;">if</span> (salesOrderId) {
                salesService.<span style="color:#0000ff;">get</span>(salesOrderId + <span style="color:#a31515;">'/PackingLists'</span>)
                    .success(function (data) {
                        $scope.packingListArr = data;
                        $scope.num.packingList = data.length;
                        angular.forEach($scope.packingListArr, function (obj) {
                            obj.tags = obj.tags.split(<span style="color:#a31515;">','</span>) || <span style="color:#a31515;">''</span>;
                        });
                    })
                    .error(function (error) {

                    });
            }
        };

        _init();

    }
]);</code></pre>

          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="row">
        <div class="col-md-3 bg-primary" data-aos="fade-right" data-aos-offset="50" data-aos-duration="500">
          <div class="card-body cc-experience-header">
            <p>Microsoft .NET</p>
            <div class="h5">C#</div>
          </div>
        </div>
        <div class="col-md-9" data-aos="fade-left" data-aos-offset="50" data-aos-duration="500" style="background-color:#888; color:white;">
          <div class="card-body">
            <div class="h5">Sales Order Processing Sample Code (Repository Design Pattern)</div>
            
<pre style="margin:0em; overflow:auto; background-color:#ffffff; max-height: 200px;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;">
<span style="color:#0000ff;">namespace</span> Emerge.Framework
{
    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> SalesOrderRepository
    {
        <span style="color:#008000;">/// &lt;summary&gt;total</span>
        <span style="color:#008000;">/// Date        :   03/07/2018</span>
        <span style="color:#008000;">/// Purpose     :   Get SalesOrder by Id</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#008000;">/// </span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> SalesOrder GetSalesOrder_ById_WithoutUserRestriction(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            
            SalesOrder salesOrder = repository.Queryable().AsNoTracking()
                .Where(p =&gt; p.SalesOrderId == salesOrderId && p.IsDeleted != <span style="color:#0000ff;">true</span>)
                .Select(a =&gt; <span style="color:#0000ff;">new</span>
                {
                    SalesOrder = a,
                    Customer = a.Customer,
                    CustomerAddressList = a.Customer.AddressList, 
                    SalesOrderDetailsList = a.SalesOrderDetailsList.Where(sd =&gt; sd.IsDeleted != <span style="color:#0000ff;">true</span>).OrderBy(c =&gt; c.Order),
                    SalesOrderDetailsList_Product = a.SalesOrderDetailsList.Select(pr =&gt; pr.Product),
                    SalesOrderDetailsList_Product_ProductUOMList = a.SalesOrderDetailsList.Select(sod =&gt; sod.Product).Select(prd =&gt; prd.ProductUOMList.Where(uom =&gt; uom.IsDeleted != <span style="color:#0000ff;">true</span>)),
                    SalesOrderDetailsList_SalesPurchaseMappingList = a.SalesOrderDetailsList.Where(d =&gt; d.IsDeleted != <span style="color:#0000ff;">true</span>)
                                                                                        .Select(c =&gt; c.SalesPurchaseMappingList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>
                                                                                            && b.PurchaseOrderDetails.IsDeleted != <span style="color:#0000ff;">true</span>
                                                                                            && b.SalesOrderDetails.IsDeleted != <span style="color:#0000ff;">true</span>)),
                    SalesOrderDetailsList_DeliveryOrderDetailsList = a.SalesOrderDetailsList.Select(d =&gt; d.DeliveryOrderDetailsList.Where(del =&gt; del.IsDeleted != <span style="color:#0000ff;">true</span>)),
                    SalesOrderDetailsList_InvoiceDetails = a.SalesOrderDetailsList.Select(d =&gt; d.InvoiceDetailsList.Where(del =&gt; del.IsDeleted != <span style="color:#0000ff;">true</span> && del.Invoice.IsDeleted != <span style="color:#0000ff;">true</span>)),
                    UserCreated = a.UserCreated,


                    SalesPurchaseMapping_PurchaseOrderDetails = a.SalesOrderDetailsList.Where(d =&gt; d.IsDeleted != <span style="color:#0000ff;">true</span>)
                                                                                        .Select(c =&gt; c.SalesPurchaseMappingList.Select(pod =&gt; pod.PurchaseOrderDetails)),
                    SalesPurchaseMapping_PurchaseOrderDetails_PurchaseOrder = a.SalesOrderDetailsList.Where(d =&gt; d.IsDeleted != <span style="color:#0000ff;">true</span>).Select(c =&gt; c.SalesPurchaseMappingList.Select(pod =&gt; pod.PurchaseOrderDetails.PurchaseOrder)),
                    a.Quotation
                })
                .ToList()
                .Select(p =&gt; p.SalesOrder)
                .FirstOrDefault();

            <span style="color:#0000ff;">return</span> salesOrder;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> SalesOrder GetSalesOrder_ById(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, IPrincipal currUser, <span style="color:#0000ff;">int</span> salesOrderId,
            <span style="color:#0000ff;">bool</span> includeQO = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includeCustomerContact = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includeCurrency = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includeUserCreated = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includePriceListSectionProduct = <span style="color:#0000ff;">false</span>,
            <span style="color:#0000ff;">bool</span> includeSODProduct = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includePO = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includePOD = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includeDOD = <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">bool</span> includeInvoiceD = <span style="color:#0000ff;">false</span>)
        {
            <span style="color:#008000;">// If user has SOAdmin, just return all customers instead of filtering by customer access view</span>
            <span style="color:#0000ff;">bool</span> isAdmin = <span style="color:#0000ff;">true</span>; 
            <span style="color:#0000ff;">int</span> currUserId = <span style="color:#0000ff;">int</span>.Parse(currUser.Identity.GetUserId());

            <span style="color:#0000ff;">var</span> query = repository.Queryable().AsNoTracking()
                .Where(s =&gt; s.SalesOrderId == salesOrderId && s.IsDeleted != <span style="color:#0000ff;">true</span>)
                .Where(s =&gt; (isAdmin || s.Customer.OwnerId == <span style="color:#0000ff;">null</span> ||
                    (s.Customer.OwnerId == currUserId && (s.Customer.ViewAccessType == CustomerViewAccessType.Owner || s.Customer.ViewAccessType == CustomerViewAccessType.User)) ||
                    s.Customer.ViewAccessType == <span style="color:#0000ff;">null</span> || s.Customer.ViewAccessType == CustomerViewAccessType.Everyone ||
                    (s.Customer.ViewAccessType == CustomerViewAccessType.User && s.Customer.ViewAccessList.Any(access =&gt; access.AllowedUserId == currUserId && access.CustomerId == s.CustomerId))))
                .Include(a =&gt; a.SalesOrderDetailsList.Select(z =&gt; z.SalesOrderDetailsDropShipList))
                .Include(a =&gt; a.Customer); 

            #region Include other data.
            <span style="color:#0000ff;">if</span> (includeQO)
            {
                query = query.Include(a =&gt; a.Quotation);
            }
            <span style="color:#0000ff;">if</span> (includeCustomerContact)
            {
                query = query.Include(a =&gt; a.Customer.ContactList);
            }
            <span style="color:#0000ff;">if</span> (includeCurrency)
            {
                query = query.Include(a =&gt; a.Currency);
            }
            <span style="color:#0000ff;">if</span> (includeUserCreated)
            {
                query = query.Include(a =&gt; a.UserCreated);
            }
            <span style="color:#0000ff;">if</span> (includePriceListSectionProduct)
            {
                query = query.Include(a =&gt; a.PriceList.PriceListProductSections.Select(b =&gt; b.PriceListProductSectionProducts));
            }
            <span style="color:#0000ff;">if</span> (includeSODProduct)
            {
                query = query.Include(a =&gt; a.SalesOrderDetailsList.Select(b =&gt; b.Product.ProductUOMList)); 
            }
            <span style="color:#0000ff;">if</span> (includePO) 
            {
                query = query.Include(a =&gt; a.PurchaseOrders); 
            }
            <span style="color:#0000ff;">if</span> (includePOD)
            {
                query = query.Include(a =&gt; a.PurchaseOrders.Select(b =&gt; b.PurchaseOrderDetailsList));
            }
            <span style="color:#0000ff;">if</span> (includeDOD)
            {
                query = query.Include(a =&gt; a.SalesOrderDetailsList.Select(b =&gt; b.DeliveryOrderDetailsList));
                query = query.Include(a =&gt; a.SalesOrderDetailsList.Select(b =&gt; b.DeliveryOrderDetailsB2BList));
            }
            <span style="color:#0000ff;">if</span> (includeInvoiceD)
            {
                query = query.Include(a =&gt; a.SalesOrderDetailsList.Select(b =&gt; b.InvoiceDetailsList.Select(c =&gt; c.Invoice)));
            }
            #endregion

            <span style="color:#0000ff;">var</span> result = query.FirstOrDefault();
            <span style="color:#0000ff;">if</span> (result == <span style="color:#0000ff;">null</span>)
            {
                <span style="color:#0000ff;">return</span> result;
            }

            #region Filter IsDeleted = <span style="color:#0000ff;">true</span> data <span style="color:#0000ff;">out</span>.
            <span style="color:#0000ff;">if</span> (result.Quotation != <span style="color:#0000ff;">null</span> && result.Quotation.IsDeleted == <span style="color:#0000ff;">true</span>)
            {
                result.Quotation = <span style="color:#0000ff;">null</span>;
            }
            <span style="color:#0000ff;">if</span> (result.Customer != <span style="color:#0000ff;">null</span> && result.Customer.ContactList != <span style="color:#0000ff;">null</span>)
            {
                result.Customer.ContactList = result.Customer.ContactList.Where(a =&gt; a.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
            }
            <span style="color:#0000ff;">if</span> (result.PriceList != <span style="color:#0000ff;">null</span> && result.PriceList.PriceListProductSections != <span style="color:#0000ff;">null</span>)
            {
                result.PriceList.PriceListProductSections = result.PriceList.PriceListProductSections.Where(a =&gt; a.IsDeleted != <span style="color:#0000ff;">true</span>)
                    .Select(a =&gt; 
                    {
                        <span style="color:#0000ff;">if</span> (a.PriceListProductSectionProducts != <span style="color:#0000ff;">null</span>)
                        {
                            a.PriceListProductSectionProducts = a.PriceListProductSectionProducts.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                        }
                        <span style="color:#0000ff;">return</span> a;
                    })
                    .ToList();
            }
            <span style="color:#0000ff;">if</span> (result.PurchaseOrders != <span style="color:#0000ff;">null</span>)
            {
                result.PurchaseOrders = result.PurchaseOrders.Where(a =&gt; a.IsDeleted != <span style="color:#0000ff;">true</span>)
                    .Select(a =&gt;
                    {
                        <span style="color:#0000ff;">if</span> (a.PurchaseOrderDetailsList != <span style="color:#0000ff;">null</span>)
                        {
                            a.PurchaseOrderDetailsList = a.PurchaseOrderDetailsList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                        }
                        <span style="color:#0000ff;">return</span> a;
                    })
                    .ToList();
            }
            result.SalesOrderDetailsList = result.SalesOrderDetailsList.Where(a =&gt; a.IsDeleted != <span style="color:#0000ff;">true</span>)
                .Select(a =&gt;
                {
                    <span style="color:#0000ff;">if</span> (a.DeliveryOrderDetailsList != <span style="color:#0000ff;">null</span>)
                    {
                        a.DeliveryOrderDetailsList = a.DeliveryOrderDetailsList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    }
                    <span style="color:#0000ff;">if</span> (a.DeliveryOrderDetailsB2BList != <span style="color:#0000ff;">null</span>)
                    {
                        a.DeliveryOrderDetailsB2BList = a.DeliveryOrderDetailsB2BList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    }
                    <span style="color:#0000ff;">if</span> (a.InvoiceDetailsList != <span style="color:#0000ff;">null</span>)
                    {
                        a.InvoiceDetailsList = a.InvoiceDetailsList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    }
                    <span style="color:#0000ff;">if</span> (a.SalesOrderDetailsDropShipList != <span style="color:#0000ff;">null</span>)
                    {
                        a.SalesOrderDetailsDropShipList = a.SalesOrderDetailsDropShipList.Where(z =&gt; z.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();

                        <span style="color:#0000ff;">var</span> supplierIdList = a.SalesOrderDetailsDropShipList.Select(z =&gt; z.SupplierId).Distinct().ToList();

                        <span style="color:#0000ff;">var</span> supplierList = repository.GetRepository&lt;Supplier&gt;().Queryable().AsNoTracking()
                            .Where(x =&gt; supplierIdList.Contains(x.SupplierId)).ToList();

                        a.SalesOrderDetailsDropShipList.ForEach(x =&gt;
                        {
                            x.Supplier = supplierList.FirstOrDefault(z =&gt; z.SupplierId == x.SupplierId);
                        });
                    }
                    <span style="color:#0000ff;">if</span>(a.InvoiceDetailsList != <span style="color:#0000ff;">null</span>)
                    {
                        a.InvoiceDetailsList = a.InvoiceDetailsList.Where(b =&gt; b.IsDeleted != <span style="color:#0000ff;">true</span> && b.Invoice.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    }

                    <span style="color:#0000ff;">return</span> a;
                }).ToList();
            #endregion

            <span style="color:#0000ff;">return</span> result;
            
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> SalesOrder GetSalesOrder_ByQuotationId(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> quotationId)
        {
            
            SalesOrder SalesOrder = repository.Queryable()
                                              .Where(p =&gt; p.QuotationId == quotationId && p.IsDeleted != <span style="color:#0000ff;">true</span>)
                                              .Select(g =&gt; <span style="color:#0000ff;">new</span>
                                              {
                                                  SalesOrder = g,
                                                  SalesOrderDetailsList = g.SalesOrderDetailsList.Where(d =&gt; d.IsDeleted != <span style="color:#0000ff;">true</span>),
                                                  UserCreated = g.UserCreated
                                              })
                                              .ToList()
                                              .Select(p =&gt; p.SalesOrder)
                                              .FirstOrDefault();

            <span style="color:#0000ff;">return</span> SalesOrder;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#008000;">/// </span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> List&lt;SalesOrder&gt; GetAllSalesOrders_PendingInvoice(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span>? customerId = <span style="color:#0000ff;">null</span>)
        {
            
            <span style="color:#0000ff;">var</span> SalesOrders = repository.Queryable()
                                        .AsNoTracking()
                                        .Where(so =&gt; so.IsDeleted != <span style="color:#0000ff;">true</span> && (customerId == <span style="color:#0000ff;">null</span> || so.CustomerId == customerId))
                                        .Include(so =&gt; so.SalesOrderDetailsList)
                                        .Include(so =&gt; so.SalesOrderDetailsList.Select(a =&gt; a.InvoiceDetailsList.Select(b =&gt; b.Invoice)))
                                        .ToList();

            <span style="color:#0000ff;">foreach</span> (<span style="color:#0000ff;">var</span> so <span style="color:#0000ff;">in</span> SalesOrders)
            {
                <span style="color:#0000ff;">foreach</span> (<span style="color:#0000ff;">var</span> sod <span style="color:#0000ff;">in</span> so.SalesOrderDetailsList)
                {
                    sod.InvoiceDetailsList = sod.InvoiceDetailsList.Where(a =&gt; a.Invoice.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                }

                so.SalesOrderDetailsList = so.SalesOrderDetailsList.Where(a =&gt; a.IsDeleted != <span style="color:#0000ff;">true</span> && a.QtyInvoiceInProgress &gt; 0).ToList();
            }

            SalesOrders = SalesOrders.Where(so =&gt; so.SalesOrderDetailsList.Any()).ToList();

            <span style="color:#0000ff;">return</span> SalesOrders;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> SalesOrderTotal GetSalesOrder_Total(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span>? salesOrderId, SalesOrder salesOrder, <span style="color:#0000ff;">bool</span>? forceGet = <span style="color:#0000ff;">true</span>)
        {
            SalesOrderTotal result = <span style="color:#0000ff;">new</span> SalesOrderTotal();
            result.TotalLine = 0;
            result.TotalQuantity = 0;
            result.TotalDiscount = 0;
            result.TotalTax = 0;
            result.TotalGrand = 0;

            <span style="color:#0000ff;">if</span> ((salesOrder == <span style="color:#0000ff;">null</span> || forceGet == <span style="color:#0000ff;">true</span>) && (salesOrderId != <span style="color:#0000ff;">null</span> && salesOrderId != 0))
            {
                salesOrder = repository.Queryable()
                                       .AsNoTracking()
                                       .Where(p =&gt; p.SalesOrderId == salesOrderId && p.IsDeleted != <span style="color:#0000ff;">true</span>)
                                       .Include(a =&gt; a.SalesOrderDetailsList)
                                       .FirstOrDefault();
            }

            <span style="color:#0000ff;">if</span> (salesOrder != <span style="color:#0000ff;">null</span>)
            {
                <span style="color:#0000ff;">if</span> (salesOrder.SalesOrderDetailsList != <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">if</span> (salesOrder.SalesOrderDetailsList.Any())
                    {
                        result.TotalQuantity = (from x <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList where (x.IsDeleted != <span style="color:#0000ff;">true</span> && x.ProductId != <span style="color:#0000ff;">null</span>) select (x.Qty)).Sum();
                        result.TotalLine = Math.Round((from x <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList where x.IsDeleted != <span style="color:#0000ff;">true</span> select (x.TotalPrice)).Sum(), 2, MidpointRounding.AwayFromZero);

                        <span style="color:#0000ff;">decimal</span> totalTax = 0;
                        <span style="color:#0000ff;">if</span> (salesOrder.IsTaxInclusive == <span style="color:#0000ff;">true</span>)
                        {
                            totalTax = (from x <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList where x.IsDeleted != <span style="color:#0000ff;">true</span> && x.TaxRate &gt; 0 select ((((<span style="color:#0000ff;">decimal</span>)x.TaxRate / 100) * x.TotalPrice) / (1 + ((<span style="color:#0000ff;">decimal</span>)x.TaxRate / 100)))).Sum();
                        }
                        <span style="color:#0000ff;">else</span>
                        {
                            totalTax = (from x <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList where x.IsDeleted != <span style="color:#0000ff;">true</span> && x.TaxRate &gt; 0 select (x.TotalPrice * (<span style="color:#0000ff;">decimal</span>)(x.TaxRate / 100))).Sum();
                        }

                        result.TotalTax = Math.Round(totalTax, 2, MidpointRounding.AwayFromZero);
                        result.TotalDiscount = (from x <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList where x.IsDeleted != <span style="color:#0000ff;">true</span> select (x.TotalDiscount)).Sum();
                    }

                    result.TotalGrand = Math.Round((result.TotalLine) + (result.TotalTax), 2, MidpointRounding.AwayFromZero); 

                    <span style="color:#0000ff;">if</span> (salesOrder.IsTaxInclusive == <span style="color:#0000ff;">true</span>)
                    {
                        result.TotalGrand -= result.TotalTax;
                    }

                    <span style="color:#0000ff;">if</span> (salesOrder.ExchangeRate != <span style="color:#0000ff;">null</span>)
                    {
                        result.TotalGrandBaseCurrency = Math.Round(result.TotalGrand * ((<span style="color:#0000ff;">decimal</span>)salesOrder.ExchangeRate), 2, MidpointRounding.AwayFromZero);
                    }
                    <span style="color:#0000ff;">else</span>
                    {
                        result.TotalGrandBaseCurrency = result.TotalGrand;
                    }
                }
            }

            <span style="color:#0000ff;">return</span> result;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsActive(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            <span style="color:#0000ff;">bool</span> IsValid = <span style="color:#0000ff;">false</span>;
            SalesOrder salesOrder =
                repository.Queryable().Where(so =&gt;
                                                    so.SalesOrderId == salesOrderId
                                                    && so.IsDeleted != <span style="color:#0000ff;">true</span>
                                                    )
                                    .AsNoTracking()
                                    .FirstOrDefault();

            IsValid = (salesOrder == <span style="color:#0000ff;">null</span> ? <span style="color:#0000ff;">false</span> : <span style="color:#0000ff;">true</span>);

            <span style="color:#0000ff;">return</span> IsValid;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// Purpose : When SO line item has Delivery Order Pending, it is Approved, Confirmed, Completed or </span>
        <span style="color:#008000;">/// line item has been Invoiced or SO Paid, </span>
        <span style="color:#008000;">/// do not allow to modify, change or delete line items</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsUpdatable(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            SalesOrder salesOrder = repository.Queryable()
                                    .Where(so =&gt;
                                        so.SalesOrderId == salesOrderId)
                                    .AsNoTracking()
                                    .FirstOrDefault();

            <span style="color:#0000ff;">if</span> (salesOrder == <span style="color:#0000ff;">null</span>)
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> BusinessLayerException(HttpStatusCode.BadRequest, <span style="color:#a31515;">"Sales Order not found."</span>);

            <span style="color:#0000ff;">if</span> (salesOrder.IsDeleted == <span style="color:#0000ff;">true</span>)
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> BusinessLayerException(HttpStatusCode.BadRequest, <span style="color:#a31515;">"Sales Order Deleted."</span>);

            <span style="color:#008000;">// check if any invoice </span>
            <span style="color:#0000ff;">if</span> (repository.GetSalesOrder_IsInvoiced(salesOrderId))
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> BusinessLayerException(HttpStatusCode.BadRequest, <span style="color:#a31515;">"Item has been invoiced, unable to update"</span>);

            <span style="color:#008000;">// check if any delivery </span>
            <span style="color:#0000ff;">if</span> (repository.GetSalesOrder_IsDelivery(salesOrderId))
                <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> BusinessLayerException(HttpStatusCode.BadRequest, <span style="color:#a31515;">"Item has been delivered, unable to update"</span>);

            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsApproved(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId, SalesOrderStatus? newStatusId = <span style="color:#0000ff;">null</span>)
        {
            SalesOrder salesOrder = repository.Queryable()
                                                        .AsNoTracking()
                                                        .Where(so =&gt;
                                                            so.SalesOrderId == salesOrderId)
                                                        .FirstOrDefault();

            <span style="color:#0000ff;">return</span> _IsApproved(salesOrder, newStatusId);
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsApproved(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, SalesOrder currentSalesOrder, SalesOrderStatus? newStatusId = <span style="color:#0000ff;">null</span>)
        {
            <span style="color:#0000ff;">return</span> _IsApproved(currentSalesOrder, newStatusId);
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// Used by     : Sales repository</span>
        <span style="color:#008000;">/// Requirement : When QO or SO line item has been Invoiced or SO Paid, do not allow to modify, change or delete line items </span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="InvoiceDetailsRepository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsInvoiced(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            <span style="color:#0000ff;">bool</span> IsValid = <span style="color:#0000ff;">false</span>;

            InvoiceDetails invoice = repository.GetRepository&lt;InvoiceDetails&gt;().Queryable()
                                                                     .AsNoTracking()
                                                                     .Where(invd =&gt; invd.SalesOrderDetails.SalesOrder.SalesOrderId == salesOrderId
                                                                         && invd.IsDeleted != <span style="color:#0000ff;">true</span>
                                                                         && invd.Invoice.IsDeleted != <span style="color:#0000ff;">true</span>)
                                                                     .FirstOrDefault();

            IsValid = (invoice == <span style="color:#0000ff;">null</span> ? <span style="color:#0000ff;">false</span> : <span style="color:#0000ff;">true</span>);

            <span style="color:#0000ff;">return</span> IsValid;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// purpose :    SO line item has Delivery Order Pending, do not allow to modify, change or delete line items</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsDelivery(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId, <span style="color:#0000ff;">bool</span> alsoCheckDropshipDO = <span style="color:#0000ff;">false</span>)
        {
            <span style="color:#0000ff;">bool</span> exists = repository.GetRepository&lt;DeliveryOrderDetails&gt;().Queryable().AsNoTracking()
                .Any(d =&gt; d.IsDeleted != <span style="color:#0000ff;">true</span>
                    && d.DeliveryOrder.IsDeleted != <span style="color:#0000ff;">true</span>
                    && d.DeliveryOrder.DeliveryOrderStatusId != DeliveryOrderStatus.Cancelled
                    && d.SalesOrderDetails.SalesOrderId == salesOrderId);
            <span style="color:#0000ff;">if</span> (!alsoCheckDropshipDO) <span style="color:#0000ff;">return</span> exists;

            <span style="color:#0000ff;">var</span> existsB2B = repository.GetRepository&lt;DeliveryOrderDetailsB2B&gt;().Queryable().AsNoTracking()
                .Any(x =&gt; x.IsDeleted != <span style="color:#0000ff;">true</span> && 
                    x.DeliveryOrder.IsDeleted != <span style="color:#0000ff;">true</span> &&
                    x.SalesOrderDetails.SalesOrderId == salesOrderId);

            <span style="color:#0000ff;">return</span> exists || existsB2B;
        }


        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// purpose :    Check if Sales Order has already converted to Shipment</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderIds"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsConvertedToShipment(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            <span style="color:#0000ff;">var</span> isConvertedToDelivery = repository.GetRepository&lt;DeliveryOrderDetails&gt;()
                .Queryable().AsNoTracking()
                .Any(a =&gt; a.SalesOrderDetails.SalesOrder.SalesOrderId == salesOrderId &&
                            a.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.DeliveryOrder.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.SalesOrderDetails.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.SalesOrderDetails.SalesOrder.IsDeleted != <span style="color:#0000ff;">true</span>);

            <span style="color:#0000ff;">return</span> isConvertedToDelivery;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// purpose :    Check if Sales Order has already converted to Invoice</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsConvertedToInvoice(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            <span style="color:#0000ff;">var</span> isConvertedToInvoice = repository.GetRepository&lt;InvoiceDetails&gt;()
                .Queryable().AsNoTracking()
                .Any(a =&gt; a.SalesOrderDetails.SalesOrder.SalesOrderId == salesOrderId &&
                            a.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.Invoice.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.SalesOrderDetails.IsDeleted != <span style="color:#0000ff;">true</span> &&
                            a.SalesOrderDetails.SalesOrder.IsDeleted != <span style="color:#0000ff;">true</span>);

            <span style="color:#0000ff;">return</span> isConvertedToInvoice;
        }



        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// purpose     :   Before convert SO to pack</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> GetSalesOrder_IsPacked(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            <span style="color:#0000ff;">return</span> repository.GetRepository&lt;SalesOrder&gt;()
                             .Queryable()
                             .AsNoTracking()
                             .Where(so =&gt; so.SalesOrderId == salesOrderId
                                 && so.IsDeleted != <span style="color:#0000ff;">true</span>)
                             .Any();
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// Used by     : salesorder create, duplicate quotation cnvert methods</span>
        <span style="color:#008000;">/// Purpoe      : to create sales orcer number in sequence</span>
        <span style="color:#008000;">/// Purpose     : need to pass the starting string to create SONumber based on customer need</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="quotationNo"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;Saleorder number string value&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> CommonFunction.NumberClass GetSalesOrder_NewSalesOrderNumber(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository)
        {
            <span style="color:#0000ff;">var</span> settingsRepo = repository.GetRepository&lt;Setting&gt;();
            <span style="color:#0000ff;">string</span> settingCustomerFormat = settingsRepo.Settings().AdminSalesOrderNumber;

            <span style="color:#0000ff;">var</span> numberClass = CommonFunction.GetSequenceFormatNumber&lt;SalesOrder&gt;(repository, settingCustomerFormat);

            <span style="color:#0000ff;">return</span> numberClass;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="salesOrderId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> ICollection&lt;DeliveryOrderDetails&gt; GetSalesOrder_GetAllDeliverOrders_BySalesOrderId(<span style="color:#0000ff;">this</span> IRepository&lt;DeliveryOrderDetails&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId)
        {
            ICollection&lt;DeliveryOrderDetails&gt; deliveryOrders = <span style="color:#0000ff;">new</span> Collection&lt;DeliveryOrderDetails&gt;();

            deliveryOrders = repository.Queryable()
                                       .AsNoTracking()
                                       .Include(c =&gt; c.UserCreated)
                                       .Where(s =&gt; (s.SalesOrderDetails.SalesOrderId == salesOrderId && s.IsDeleted != <span style="color:#0000ff;">true</span>))
                                       .OrderByDescending(c =&gt; c.DateCreated)
                                       .ToList();

            <span style="color:#0000ff;">return</span> deliveryOrders;
        }

        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">int</span> GetSalesOrders_TotalCount_ByCustomerId(
              <span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository,
              <span style="color:#0000ff;">int</span> customerId)
        {
            <span style="color:#0000ff;">int</span> totalPurchase = 0;
            totalPurchase = repository.Queryable()
                                      .AsNoTracking()
                                      .Where(so =&gt; so.CustomerId == customerId && so.IsDeleted != <span style="color:#0000ff;">true</span>)
                                      .Count();

            <span style="color:#0000ff;">return</span> totalPurchase;
        }

        <span style="color:#008000;">/// &lt;summary&gt;</span>
        <span style="color:#008000;">/// need to get total Sales Amount by the Customer exclude cancelled and deleted sales records</span>
        <span style="color:#008000;">/// &lt;/summary&gt;</span>
        <span style="color:#008000;">/// &lt;param name="repository"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;param name="customerId"&gt;&lt;/param&gt;</span>
        <span style="color:#008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">decimal</span> GetSalesOrders_TotalAmount_ByCustomerId(
              <span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository,
              <span style="color:#0000ff;">int</span> customerId)
        {

            <span style="color:#0000ff;">var</span> totalSalesAmount = repository.Queryable()
                                                  .AsNoTracking()
                                                  .Include(so =&gt; so.SalesOrderDetailsList)
                                                  .Where(so =&gt; so.CustomerId == customerId
                                                      && so.IsDeleted != <span style="color:#0000ff;">true</span>)
                                                  .ToList()
                                                  .Select(a =&gt;
                                                  {
                                                      a.Total = GetSalesOrder_Total(repository, a.SalesOrderId, a);
                                                      <span style="color:#0000ff;">return</span> a;
                                                  })
                                                  .Sum(c =&gt; c.Total.TotalGrandBaseCurrency);

            <span style="color:#0000ff;">return</span> totalSalesAmount;
        }

        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> _IsApproved(SalesOrder currentSalesOrder, SalesOrderStatus? newStatusId = <span style="color:#0000ff;">null</span>)
        {
        
            <span style="color:#008000;">// check whether isApproval is required</span>
            <span style="color:#0000ff;">if</span> (currentSalesOrder.IsApprovalRequired)
            {
                <span style="color:#008000;">// placed this here so don't have to waste resource to check role if approval is not required</span>
                <span style="color:#0000ff;">bool</span> isSalesAdmin = Thread.CurrentPrincipal.IsInRole(<span style="color:#a31515;">"sales_approval"</span>);

                <span style="color:#0000ff;">if</span> (isSalesAdmin)
                {
                    <span style="color:#008000;">// this user is admin, don't need validate</span>
                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
                }

                <span style="color:#008000;">// if approval required proceed to validate</span>

                <span style="color:#008000;">// check whether the input data status is more than PendingApproval</span>
                <span style="color:#008000;">// if newStatusId is null AND isApproved is false, we'll throw error</span>
                <span style="color:#0000ff;">if</span> ((newStatusId &gt; SalesOrderStatus.NotApproved && !currentSalesOrder.IsApproved) || (newStatusId == <span style="color:#0000ff;">null</span> && currentSalesOrder.IsApproved == <span style="color:#0000ff;">false</span>))
                {
                    <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> BusinessLayerException(HttpStatusCode.BadRequest, <span style="color:#a31515;">"This Sales Order does not full fill delivery."</span>);
                }
            }

            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;
        }

        <span style="color:#008000;">///&lt;summary&gt;</span>
        <span style="color:#008000;">/// Get the quantity of packinglist that's belong to Sales Order</span>
        <span style="color:#008000;">///&lt;/summary&gt;</span>
        <span style="color:#008000;">/// </span>
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> SalesOrderPackingTotal GetSalesOrderPackingTotal(<span style="color:#0000ff;">this</span> IRepository&lt;SalesOrder&gt; repository, <span style="color:#0000ff;">int</span> salesOrderId, <span style="color:#0000ff;">int</span>? packingListId)
        {
            <span style="color:#0000ff;">var</span> salesOrderPackingTotal = <span style="color:#0000ff;">new</span> SalesOrderPackingTotal();

            <span style="color:#0000ff;">var</span> _totalQty = 0M;
            <span style="color:#0000ff;">var</span> _totalQtyPacked = 0M;

            <span style="color:#0000ff;">var</span> salesOrder = repository.Queryable().AsNoTracking()
                .Where(x =&gt; x.IsDeleted != <span style="color:#0000ff;">true</span> && x.SalesOrderId == salesOrderId)
                .Include(x =&gt; x.SalesOrderDetailsList.Select(b =&gt; b.Product))
                .Include(x =&gt; x.PackingLists)
                .Include(x =&gt; x.PackingLists.Select(y =&gt; y.PackingSectionList))
                .Include(x =&gt; x.PackingLists.Select(y =&gt; y.PackingSectionList.Select(z =&gt; z.PackingSectionDetailsList)))
                .FirstOrDefault();

            <span style="color:#0000ff;">if</span> (salesOrder != <span style="color:#0000ff;">null</span>)
            {
                salesOrder.PackingLists = salesOrder.PackingLists.Where(x =&gt; x.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                salesOrder.PackingLists.ForEach(x =&gt;
                {
                    x.PackingSectionList = x.PackingSectionList.Where(z =&gt; z.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    x.PackingSectionList.ForEach(z =&gt;
                    {
                        z.PackingSectionDetailsList =
                            z.PackingSectionDetailsList.Where(p =&gt; p.IsDeleted != <span style="color:#0000ff;">true</span>).ToList();
                    });
                });
                <span style="color:#008000;">// calculate total qty & total qty packed</span>
                _totalQty = salesOrder.SalesOrderDetailsList.Where(x =&gt; x.Product != <span style="color:#0000ff;">null</span> && !x.Product.IsService && x.IsDeleted != <span style="color:#0000ff;">true</span>).Sum(x =&gt; x.Qty * x.ProductUOMValue);

                <span style="color:#0000ff;">var</span> sum = salesOrder.PackingLists.Where(a =&gt; (a.PackingListId != packingListId && packingListId != <span style="color:#0000ff;">null</span>) || (packingListId == <span style="color:#0000ff;">null</span> && a.PackingListId == a.PackingListId)).Sum(
                    x =&gt;
                        x.PackingSectionList.Sum(
                            y =&gt; y.PackingSectionDetailsList.Sum(z =&gt; z.ContainerQty * z.ProductUOMValue)));
                _totalQtyPacked = sum ?? 0;
                salesOrderPackingTotal.TotalQuantity = _totalQty;
                salesOrderPackingTotal.TotalQuantityPacked = _totalQtyPacked;

                <span style="color:#0000ff;">foreach</span> (<span style="color:#0000ff;">var</span> salesOrderDetailse <span style="color:#0000ff;">in</span> salesOrder.SalesOrderDetailsList.Where(x =&gt; x.Product != <span style="color:#0000ff;">null</span> && !x.Product.IsService && x.IsDeleted != <span style="color:#0000ff;">true</span>))
                {
                    <span style="color:#0000ff;">var</span> itemQtyPacked = salesOrder.
                        PackingLists.Where(a =&gt; (a.PackingListId != packingListId && packingListId != <span style="color:#0000ff;">null</span>) || (packingListId == <span style="color:#0000ff;">null</span> && a.PackingListId == a.PackingListId)).Sum(x =&gt;
                            x.PackingSectionList.Sum(y =&gt;
                                y.PackingSectionDetailsList.Where(z =&gt; z.ProductId == salesOrderDetailse.ProductId)
                                .Sum(z =&gt; z.ContainerQty * z.ProductUOMValue)));

                    <span style="color:#0000ff;">var</span> salesOrderDetailsQtyPacked = <span style="color:#0000ff;">new</span> SalesOrderDetailsQtyPacked();
                    salesOrderDetailsQtyPacked.ProductId = salesOrderDetailse.ProductId.Value; 
                    salesOrderDetailsQtyPacked.Name = salesOrderDetailse.ItemName;
                    salesOrderDetailsQtyPacked.ProductUOMName = salesOrderDetailse.ProductUOMName;
                    salesOrderDetailsQtyPacked.ProductUOMValue = salesOrderDetailse.ProductUOMValue;
                    salesOrderDetailsQtyPacked.Qty = salesOrderDetailse.Qty * salesOrderDetailse.ProductUOMValue;
                    salesOrderDetailsQtyPacked.QtyPacked = itemQtyPacked ?? 0;

                    salesOrderPackingTotal.SalesOrderDetailsPackedList.Add(salesOrderDetailsQtyPacked);
                }
            }

            <span style="color:#0000ff;">return</span> salesOrderPackingTotal;
        }
    }
}</code></pre>


          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="row">
        <div class="col-md-3 bg-primary" data-aos="fade-right" data-aos-offset="50" data-aos-duration="500">
          <div class="card-body cc-experience-header">
            <p>Microsoft .NET</p>
            <div class="h5">C#</div>
          </div>
        </div>
        <div class="col-md-9" data-aos="fade-left" data-aos-offset="50" data-aos-duration="500" style="background-color:#888; color:white;">
          <div class="card-body">
            <div class="h5">Web API- various end point implementation</div>
            
<pre style="margin:0em; overflow:auto; background-color:#ffffff; max-height: 200px;"><code style="font-family:Consolas,&quot;Courier New&quot;,Courier,Monospace; font-size:10pt; color:#000000;">
<span style="color:#0000ff;">namespace</span> PropertyCRM.WebApi.Controllers
{
    [RoutePrefix(<span style="color:#a31515;">"api/Template"</span>)]
    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> TemplateController : BaseController
    {

        <span style="color:#0000ff;">public</span> TemplateController()
        {
        }

        #region GetByType
        [HttpPost]
        [Route(<span style="color:#a31515;">"GetByType"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateLookupResponse&gt;&gt; GetByType(ServiceRequest&lt;TemplateLookupRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateLookupResponse response = <span style="color:#0000ff;">new</span> TemplateLookupResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateLookupRequest, TemplateLookupResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateLookupRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.GetTemplatesByTypeIdAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_GETBYTYPE).ConfigureAwait(<span style="color:#0000ff;">false</span>);
               
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateLookupRequest, TemplateLookupResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region LoadContent
        [HttpPost]
        [Route(<span style="color:#a31515;">"LoadContent"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateLoadContentResponse&gt;&gt; LoadContent(ServiceRequest&lt;TemplateLoadContentRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateLoadContentResponse response = <span style="color:#0000ff;">new</span> TemplateLoadContentResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateLoadContentRequest, TemplateLoadContentResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateLoadContentRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.GetTemplateContentByIdAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_LOADCONTENT, BaseDownloadFolder).ConfigureAwait(<span style="color:#0000ff;">false</span>);

            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateLoadContentRequest, TemplateLoadContentResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Initial Request
        [HttpPost]
        [Route(<span style="color:#a31515;">"GetSearchInitialData"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateSearchInitialResponse&gt;&gt; GetSearchInitialData(ServiceRequest&lt;TemplateSearchInitialRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateSearchInitialResponse response = <span style="color:#0000ff;">new</span> TemplateSearchInitialResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateSearchInitialRequest, TemplateSearchInitialResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateSearchInitialRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.GetSearchInitialDataAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_LOOKUP).ConfigureAwait(<span style="color:#0000ff;">false</span>);

            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateSearchInitialRequest, TemplateSearchInitialResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Search
        [HttpPost]
        [Route(<span style="color:#a31515;">"Search"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateSearchResponse&gt;&gt; Search(ServiceRequest&lt;TemplateSearchRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateSearchResponse response = <span style="color:#0000ff;">new</span> TemplateSearchResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateSearchRequest, TemplateSearchResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateSearchRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.SearchTemplatesAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_SEARCH).ConfigureAwait(<span style="color:#0000ff;">false</span>);
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateSearchRequest, TemplateSearchResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Summary
        [HttpPost]
        [Route(<span style="color:#a31515;">"Summary"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateSummaryResponse&gt;&gt; Summary(ServiceRequest&lt;TemplateSummaryRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateSummaryResponse response = <span style="color:#0000ff;">new</span> TemplateSummaryResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateSummaryRequest, TemplateSummaryResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateSummaryRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.GetTemplateSummaryAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_SUMMARY).ConfigureAwait(<span style="color:#0000ff;">false</span>);

            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateSummaryRequest, TemplateSummaryResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Edit
        [HttpPost]
        [Route(<span style="color:#a31515;">"Edit"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateEditResponse&gt;&gt; Edit(ServiceRequest&lt;TemplateEditRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateEditResponse response = <span style="color:#0000ff;">new</span> TemplateEditResponse();
            <span style="color:#0000ff;">var</span> token = request?.Token;
            <span style="color:#0000ff;">try</span>
            {

                request.EnsureAuthorizedRequest&lt;TemplateEditRequest, TemplateEditResponse&gt;();


                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateEditRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">var</span> resp = <span style="color:#0000ff;">await</span> BusinessRuleManager.GetTemplateAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_EDIT, BaseDownloadFolder).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">var</span> lookupReq = <span style="color:#0000ff;">new</span> ServiceRequest&lt;TemplateSearchInitialRequest&gt;();
                lookupReq.Token = token;
                lookupReq.Data = <span style="color:#0000ff;">new</span> TemplateSearchInitialRequest();
                <span style="color:#0000ff;">var</span> lookupResp = <span style="color:#0000ff;">await</span> GetSearchInitialData(lookupReq).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">if</span> (resp != <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">if</span> (resp.Data == <span style="color:#0000ff;">null</span>)
                        resp.Data = <span style="color:#0000ff;">new</span> TemplateEditResponse();

                    <span style="color:#0000ff;">if</span> (lookupResp != <span style="color:#0000ff;">null</span> && lookupResp.Data != <span style="color:#0000ff;">null</span>)
                    {
                        resp.Data.LookupData = lookupResp.Data.LookupData;
                        resp.Data.UserData = lookupResp.Data.UserData;
                    }

                }

                <span style="color:#0000ff;">return</span> resp;
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateEditRequest, TemplateEditResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Save
        [HttpPost]
        [Route(<span style="color:#a31515;">"Save"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;TemplateSaveResponse&gt;&gt; Save(ServiceRequest&lt;TemplateSaveRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            TemplateSaveResponse response = <span style="color:#0000ff;">new</span> TemplateSaveResponse();

            <span style="color:#0000ff;">try</span>
            {
                request.EnsureAuthorizedRequest&lt;TemplateSaveRequest, TemplateSaveResponse&gt;();
                <span style="color:#0000ff;">await</span> ParseToken&lt;TemplateSaveRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">await</span> BusinessRuleManager.SaveTemplateAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_TEMPLATE_SAVE, TempUploadFolder, WordAddInUploadFolder).ConfigureAwait(<span style="color:#0000ff;">false</span>);

            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;TemplateSaveRequest, TemplateSaveResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region Generate
        [HttpPost]
        [Route(<span style="color:#a31515;">"Generate"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;FileDownloadResponse&gt;&gt; Generate(ServiceRequest&lt;GenerateDocumentRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            FileDownloadResponse response = <span style="color:#0000ff;">new</span> FileDownloadResponse();
            <span style="color:#0000ff;">var</span> token = request?.Token;
            <span style="color:#0000ff;">try</span>
            {

                <span style="color:#0000ff;">if</span> (request != <span style="color:#0000ff;">null</span> && request.Data != <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">var</span> chartSetting = GetChartSetting();
                    <span style="color:#0000ff;">var</span> reportOption = <span style="color:#0000ff;">await</span> GetReportOption(request.Data, token).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                    <span style="color:#0000ff;">if</span> (!<span style="color:#0000ff;">string</span>.IsNullOrEmpty(request.Data.BrochureFor) && request.Data.BrochureFor.ToUpper().Equals(<span style="color:#a31515;">"DNG"</span>))
                    {
                        response = <span style="color:#0000ff;">await</span> BusinessRuleManager.CreateDocumentForDNGAsync(request.Data, reportOption, chartSetting).ConfigureAwait(<span style="color:#0000ff;">false</span>);
                    }
                    <span style="color:#0000ff;">else</span>
                    {
                        response = <span style="color:#0000ff;">await</span> BusinessRuleManager.CreateDocumentAsync(request.Data, reportOption, chartSetting).ConfigureAwait(<span style="color:#0000ff;">false</span>);
                    }
                }

                <span style="color:#0000ff;">if</span> (response == <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> CRMBusinessRuleValidationException(ResxError.ERR_018_UnableToGenerate);
                }


                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;GenerateDocumentRequest, FileDownloadResponse&gt;(<span style="color:#0000ff;">null</span>, response, totalRecords, UserSession.Session.UserId, <span style="color:#0000ff;">true</span>);
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;GenerateDocumentRequest, FileDownloadResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion

        #region MergeField
        [HttpPost]
        [Route(<span style="color:#a31515;">"MergeField"</span>)]
        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">async</span> Task&lt;ServiceResponse&lt;MergeFieldResponse&gt;&gt; MergeField(ServiceRequest&lt;MergeFieldRequest&gt; request)
        {
            <span style="color:#0000ff;">int</span> totalRecords = 0;
            MergeFieldResponse response = <span style="color:#0000ff;">new</span> MergeFieldResponse();
            <span style="color:#0000ff;">var</span> token = request?.Token;
            <span style="color:#0000ff;">try</span>
            {

                request.EnsureAuthorizedRequest&lt;MergeFieldRequest, MergeFieldResponse&gt;();


                <span style="color:#0000ff;">await</span> ParseToken&lt;MergeFieldRequest&gt;(request).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">var</span> resp = <span style="color:#0000ff;">await</span> BusinessRuleManager.GetMergeFieldAsync(request, UserSession, ServiceUrl + SchemaConstants.ENDPOINT_MERGE_FIELD_LOOKUP).ConfigureAwait(<span style="color:#0000ff;">false</span>);

                <span style="color:#0000ff;">if</span> (resp != <span style="color:#0000ff;">null</span>)
                {
                    <span style="color:#0000ff;">if</span> (resp.Data == <span style="color:#0000ff;">null</span>)
                        resp.Data = <span style="color:#0000ff;">new</span> MergeFieldResponse();


                    <span style="color:#0000ff;">if</span> (resp.Data.MergeFieldData != <span style="color:#0000ff;">null</span> && resp.Data.MergeFieldData.Any())
                    {
                        resp.Data.MergeFieldData.ToList().ForEach(t =&gt;
                        {
                            <span style="color:#0000ff;">if</span> (!<span style="color:#0000ff;">string</span>.IsNullOrEmpty(t.Value) && t.Value.StartsWith(<span style="color:#a31515;">"{"</span>) && t.Value.EndsWith(<span style="color:#a31515;">"}"</span>))
                            {
                                t.Value = t.Value.TrimStart(<span style="color:#a31515;">'{'</span>).TrimEnd(<span style="color:#a31515;">'}'</span>);
                            }
                        });
                    }
                }

                <span style="color:#0000ff;">return</span> resp;
            }
            <span style="color:#0000ff;">catch</span> (Exception ex)
            {
                <span style="color:#0000ff;">return</span> request.HandleResponse&lt;MergeFieldRequest, MergeFieldResponse&gt;(ex, response, totalRecords, UserSession.Session.UserId);
            }

        }
        #endregion
    }
}
</code></pre>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<div class="section" id="contact">
  <div class="cc-contact-information" style="background-image: url('images/graphic-design-4.jpg');">
    <div class="container">
      <div class="cc-contact">
        <div class="row">
          <div class="col-md-9">
            <div class="card mb-0" data-aos="zoom-in">
              <div class="h4 text-center title">Contact Me</div>
              <div class="row">
             
                <div class="col-md-12" style="text-align:center;">
                  <div class="card-body">
                    <p class="mb-0"><strong>Phone</strong></p>
                    <p class="pb-2">+1 (517) 633-6253 </p>
                    <p class="mb-0"><strong>Email</strong></p>
                    <p>arifsuleman.tech@gmail.com</p>
			  <p class="mb-0"><strong>Address</strong></p>
                    <p>Lewisville, Texas</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div></div>
    </div>
    <footer class="footer">
      <div class="container text-center"></div>

      <div class="h4 title text-center">Arif Suleman</div>
      <div class="text-center text-muted">
        <p>&copy; Creative CV. All rights reserved.</p>
      </div>
    </footer>
    <script src="js/core/jquery.3.2.1.min.js"></script>
    <script src="js/core/popper.min.js"></script>
    <script src="js/core/bootstrap.min.js"></script>
    <script src="js/now-ui-kit.js?v=1.1.0"></script>
    <script src="js/aos.js"></script>
    <script src="scripts/main.js"></script>
  </body>
</html>
